# ... (ç¬¬ä¸€å ´æˆ²ï¼šJuju éƒ¨åˆ†å®Œå…¨ä¸è®Šï¼Œçœç•¥ä»¥ç¯€çœç‰ˆé¢) ...

# ==========================================
# ç¬¬äºŒå ´æˆ²ï¼šåœ¨ KubeSphere Host ä¸ŠåŸ·è¡Œè¨»å†Šèˆ‡åˆ·æ–°
# ==========================================
- name: 2. Register Cluster (on KubeSphere Host)
  hosts: ks_host
  gather_facts: no
  
  tasks:
    - name: 7. Apply Cluster CRD
      shell: |
        cat <<EOF | kubectl apply -f -
        apiVersion: cluster.kubesphere.io/v1alpha1
        kind: Cluster
        metadata:
          name: {{ cluster_name }}
          labels:
            cluster-role.kubesphere.io/member: ""
        spec:
          connection:
            type: direct
            kubeconfig: {{ cluster_config }}
          provider: microk8s
        EOF
      register: apply_result

    # ã€æ–°å¢ã€‘å¼·åˆ¶é‡å•Ÿ KubeSphere API Server ä»¥åˆ·æ–° UI è¨ˆæ•¸
    - name: 8. Force Refresh KubeSphere UI (Restart API)
      command: "kubectl rollout restart deployment ks-apiserver -n kubesphere-system"
      ignore_errors: yes # å°±ç®—é‡å•Ÿå¤±æ•—ä¹Ÿä¸è¦è®“æ•´å€‹ Job è®Šç´…ç‡ˆ

    - name: Final Success Message
      debug:
        msg: "ğŸ‰ å…¨è‡ªå‹•æˆåŠŸï¼é›†ç¾¤ {{ cluster_name }} å·²è¨»å†Šï¼ŒAPI Server å·²é‡å•Ÿä»¥åˆ·æ–° UIã€‚"
