# ==========================================
# ç¬¬ä¸€å ´æˆ²ï¼šåœ¨ Juju Controller ä¸Šç”Ÿæˆé…ç½®
# ==========================================
- name: 1. Deploy and Generate Config (on Juju)
  hosts: all  # ç¢ºä¿ AWX Inventory æŒ‡å‘æ‚¨çš„ Juju Controller (maasjuju)
  gather_facts: no
  vars:
    k8s_model: "k8s-cluster-auto"
    # [ä¿®æ”¹] å°‡ KubeSphere çš„è³‡è¨Šè®Šæ•¸åŒ–ï¼Œä¸è¦å¯«æ­» IP
    ks_host_ip: "192.168.100.4"   # è«‹åœ¨ AWX Survey è¨­å®šæ­¤è®Šæ•¸
    ks_host_user: "ubuntu"        # è«‹åœ¨ AWX Survey è¨­å®šæ­¤è®Šæ•¸

  tasks:
    # ----------------------------------------------------------------
    # Juju éƒ¨ç½²éƒ¨åˆ†
    # ----------------------------------------------------------------
    - name: 1.1 Create Juju Model
      command: "juju add-model {{ k8s_model }}"
      ignore_errors: yes

    - name: 1.2 Set Model Base to Ubuntu 22.04
      command: "juju model-config -m {{ k8s_model }} default-base=ubuntu@22.04"
      ignore_errors: yes

    - name: 1.3 Deploy MicroK8s
      command: "juju deploy microk8s --channel=1.28/stable --base ubuntu@22.04 -m {{ k8s_model }}"
      ignore_errors: yes 

    # [å„ªåŒ–] ä½¿ç”¨ retries å–ä»£å–®ç´” wait-forï¼Œé¿å… Juju ç‰ˆæœ¬å·®ç•°å°è‡´æŒ‡ä»¤å¤±æ•—
    - name: 2. Wait for MicroK8s to be Ready
      shell: "juju status -m {{ k8s_model }} --format json | jq -r '.applications.microk8s.status.active'"
      register: app_status
      until: app_status.stdout == "true"
      retries: 30
      delay: 10

    # ----------------------------------------------------------------
    # [é—œéµä¿®æ­£] è¨­å®š SANs (Subject Alternative Names)
    # ----------------------------------------------------------------
    - name: 3. Get Node Public IPv4
      # æ’é™¤ 127.0.0.1ï¼Œç¢ºä¿æŠ“åˆ°å°å¤– IP
      shell: "juju ssh -m {{ k8s_model }} microk8s/0 -- ip -4 -o addr show scope global | grep -v '127.0.0.1' | awk '{print $4}' | cut -d/ -f1 | head -n1"
      register: ip_result

    - name: 4. Set Facts
      set_fact:
        node_ip: "{{ ip_result.stdout | trim }}"

    - name: 5. Add IP to MicroK8s Cert SANs
      # é€™æ˜¯æœ€é‡è¦çš„ä¿®æ­£ï¼å¦‚æœä¸åŠ é€™è¡Œï¼ŒKubeSphere é€£ç·šæ™‚æœƒå ± x509 éŒ¯èª¤
      command: "juju config -m {{ k8s_model }} microk8s extra_sans={{ node_ip }}"

    # ç­‰å¾…è­‰æ›¸æ›´æ–°é‡å•Ÿ
    - name: 6. Wait for Config Update
      wait_for:
        timeout: 10

    # ----------------------------------------------------------------
    # ç”¢ç”Ÿ Base64 Config ä¸¦å‚³éçµ¦ Host
    # ----------------------------------------------------------------
    - name: 7. Generate Base64 Kubeconfig
      # ä½¿ç”¨ sed æ›¿æ› IPï¼Œä¸¦è½‰ç‚º Base64 (ä¸æ›è¡Œ)
      shell: "juju ssh -m {{ k8s_model }} microk8s/0 -- sudo microk8s config | sed 's/127.0.0.1/{{ node_ip }}/g' | base64 -w 0"
      register: kubeconfig_b64

    - name: 8. Add KubeSphere Host to Inventory
      add_host:
        name: "ks_host"
        ansible_host: "{{ ks_host_ip }}"
        ansible_user: "{{ ks_host_user }}"
        cluster_name: "{{ k8s_model }}"
        cluster_config: "{{ kubeconfig_b64.stdout }}"

# ==========================================
# ç¬¬äºŒå ´æˆ²ï¼šåœ¨ KubeSphere Host ä¸ŠåŸ·è¡Œè¨»å†Š
# ==========================================
- name: 2. Register Cluster (on KubeSphere Host)
  hosts: ks_host
  gather_facts: no
  
  tasks:
    - name: 9. Apply Cluster CRD
      # [ä¿®æ­£] é€™è£¡ä¿®æ­£äº† YAML ç¸®æ’éŒ¯èª¤ï¼Œé€™åœ¨ Ansible ä¸­éå¸¸åš´æ ¼
      shell: |
        cat <<EOF | kubectl apply -f -
        apiVersion: cluster.kubesphere.io/v1alpha1
        kind: Cluster
        metadata:
          name: {{ cluster_name }}
        spec:
          provider: microk8s
          joinFederation: true
          connection:
            type: direct
            kubeconfig: {{ cluster_config }}
          config: 
            global: {}
        EOF
      register: apply_result

    - name: Final Success Message
      debug:
        msg: "ğŸ‰ å…¨è‡ªå‹•æˆåŠŸï¼é›†ç¾¤ {{ cluster_name }} (IP: {{ hostvars['ks_host']['cluster_name'] }}) å·²ç›´æ¥è¨»å†Šè‡³ KubeSphereã€‚"
