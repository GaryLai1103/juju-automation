---
- name: Deploy K8s and Auto-Register to KubeSphere
  hosts: all
  gather_facts: no
  vars:
    # --- è®Šæ•¸è¨­å®š (AWX Survey è¼¸å…¥çš„ k8s_model æœƒè¦†è“‹é€™è£¡) ---
    k8s_model: "k8s-cluster-auto"
    
    # --- KubeSphere é€£ç·šè³‡è¨Š ---
    ks_url: "http://192.168.1.112:30880"
    
    # ã€é—œéµä¿®æ­£ã€‘ä½¿ç”¨ ServiceAccount Bearer Token ç¹éç™»å…¥ API
    # âš ï¸ è«‹å°‡æ­¤è™•çš„ä½”ä½ç¬¦æ›¿æ›æˆæ‚¨ä¹‹å‰å–å¾—çš„ Cluster-Admin Tokenï¼
    ks_token: "eyJhbGciOiJSUzI1NiIsImtpZCI6ImszdmJRMm1USVpCd19YUGt4QUZDVEdCbkpzQkNsc2dQcUJYaUpzS2daVTQifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlc3BoZXJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhd3gtYXV0b21hdGlvbi10b2tlbiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJhd3gtYXV0b21hdGlvbiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjQ2MjQ2ODlkLTgzZTEtNDZmMC04NWRmLTI1OTM2NTkwNjJiMCIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlc3BoZXJlLXN5c3RlbTphd3gtYXV0b21hdGlvbiJ9.nNp2th8MWfPlwDNIZ-0IaVG6g_SWSlsBnK6Qjav5Snnb4TZbWurGp-CE1b6_aRKwBsfWG-2tSWHGSH7EbgK1INAnJMmHKs6CsQKnVspgjoUYflQUf87AAG1srmPVXdIMT_lDoyU703hvlndguxBFDsnfGlfilYLovolDP37WLxOiwfoiJPpgOFtpUsLp5D8uxyVe9pV4Iu_QdLyZsu-KSCnRTEfKcfIvX2G5R5z2uvwdeoHX0w1PeL5Ay4plqEZ9kBNm2DsklZpx4HOZRwp7mR7xjO8y_gMDgQhLA0uR0H5-7tsZYGKeJ9j59xYaf89GNzDAiToTx4zLV6_I5fWziQ"

  tasks:
    # =========================================================
    # ç¬¬ä¸€éšæ®µï¼šJuju éƒ¨ç½²èˆ‡è¨­å®šæª”ç²å– (ä¸è®Š)
    # =========================================================
    
    - name: 1.1 Create Juju Model
      command: "juju add-model {{ k8s_model }}"
      ignore_errors: yes

    - name: 1.2 Set Model Base to Ubuntu 22.04
      command: "juju model-config -m {{ k8s_model }} default-base=ubuntu@22.04"
      ignore_errors: yes

    - name: 1.3 Deploy MicroK8s
      command: "juju deploy microk8s --channel=1.28/stable --base ubuntu@22.04 -m {{ k8s_model }}"
      ignore_errors: yes

    - name: 2. Wait for MicroK8s to be Ready
      command: "juju wait-for application microk8s -m {{ k8s_model }} --query='name==\"microk8s\" && status==\"active\"'"

    - name: 3. Get Node Public IPv4
      command: "juju ssh -m {{ k8s_model }} microk8s/0 -- ip -4 -o addr show scope global"
      register: ip_result

    - name: 4. Parse IP Address
      set_fact:
        node_ip: "{{ ip_result.stdout | regex_search('inet ([0-9.]+)', '\\1') | first }}"

    - name: 5. Get and Patch Kubeconfig
      shell: "juju ssh -m {{ k8s_model }} microk8s/0 -- sudo microk8s config | sed 's/127.0.0.1/{{ node_ip }}/g'"
      register: kubeconfig_patched

    # =========================================================
    # ç¬¬äºŒéšæ®µï¼šKubeSphere è‡ªå‹•ç´ç®¡ (ä½¿ç”¨ Token èªè­‰)
    # =========================================================
    
    # ã€å·²åˆªé™¤ã€‘ Task 6 (Login to KubeSphere API)

    - name: 7. Register Cluster to KubeSphere
      uri:
        url: "{{ ks_url }}/kapis/cluster.kubesphere.io/v1alpha1/clusters"
        method: POST
        body_format: json
        
        # ã€ä¿®æ­£ã€‘ç›´æ¥ä½¿ç”¨ Bearer Token é€²è¡Œèªè­‰ï¼Œç¹é Login é–˜é“
        headers:
          Authorization: "Bearer {{ ks_token }}" 
          Content-Type: "application/json"
        
        body:
          apiVersion: "cluster.kubesphere.io/v1alpha1"
          kind: "Cluster"
          metadata:
            name: "{{ k8s_model }}"
            labels:
              cluster-role.kubesphere.io/member: ""
          spec:
            connection:
              type: "direct"
              kubeconfig: "{{ kubeconfig_patched.stdout | b64encode }}"
            provider: "microk8s"
        status_code: [201, 409] # 409 ä»£è¡¨å·²å­˜åœ¨ (ä¸ç®—å¤±æ•—)
        validate_certs: no
      delegate_to: localhost

    - name: Final Status
      debug:
        msg: "ğŸ‰ æˆåŠŸï¼é›†ç¾¤ {{ k8s_model }} (IP: {{ node_ip }}) å·²éƒ¨ç½²ä¸¦è‡ªå‹•è¨»å†Šè‡³ KubeSphereã€‚"
