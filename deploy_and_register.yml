---
- name: Deploy K8s and Auto-Register to KubeSphere
  hosts: all
  gather_facts: no
  vars:
    # --- è®Šæ•¸è¨­å®š (AWX Survey è¼¸å…¥çš„ k8s_model æœƒè¦†è“‹é€™è£¡) ---
    k8s_model: "k8s-cluster-auto"
    
    # --- KubeSphere é€£ç·šè³‡è¨Š (è«‹ç¢ºèªå¯†ç¢¼æ˜¯å¦æ­£ç¢º) ---
    ks_url: "http://192.168.1.112:30880"
    ks_user: "admin"
    ks_password: "P@88w0rd"  # <--- âš ï¸ è«‹å‹™å¿…ç¢ºèªé€™è£¡æ˜¯æ‚¨ KubeSphere çš„çœŸå¯¦å¯†ç¢¼

  tasks:
    # =========================================================
    # ç¬¬ä¸€éšæ®µï¼šJuju éƒ¨ç½²èˆ‡è¨­å®šæª”ç²å–
    # =========================================================
    
    - name: 1.1 Create Juju Model
      command: "juju add-model {{ k8s_model }}"
      ignore_errors: yes # å¦‚æœæ¨¡å‹å·²å­˜åœ¨ï¼Œå¿½ç•¥éŒ¯èª¤ç¹¼çºŒå¾€ä¸‹è·‘

    - name: 1.2 Set Model Base to Ubuntu 22.04
      command: "juju model-config -m {{ k8s_model }} default-base=ubuntu@22.04"
      ignore_errors: yes

    - name: 1.3 Deploy MicroK8s
      # å¼·åˆ¶æŒ‡å®š Ubuntu 22.04ï¼Œé¿å…ç‰ˆæœ¬ç›¸å®¹å•é¡Œ
      command: "juju deploy microk8s --channel=1.28/stable --base ubuntu@22.04 -m {{ k8s_model }}"
      ignore_errors: yes 

    - name: 2. Wait for MicroK8s to be Ready
      # é€™ä¸€æ­¥æœƒç­‰å¾…ç›´åˆ°ç‹€æ…‹è®Šæˆ active (é€šå¸¸éœ€è¦ 5~10 åˆ†é˜)
      command: "juju wait-for application microk8s -m {{ k8s_model }} --query='name==\"microk8s\" && status==\"active\"'"

    - name: 3. Get Node Public IPv4
      command: "juju ssh -m {{ k8s_model }} microk8s/0 -- ip -4 -o addr show scope global"
      register: ip_result

    - name: 4. Parse IP Address
      set_fact:
        node_ip: "{{ ip_result.stdout | regex_search('inet ([0-9.]+)', '\\1') | first }}"

    - name: 5. Get and Patch Kubeconfig
      # ã€ä¿®æ­£é‡é»ã€‘é€™è£¡æ”¹ç”¨ shell æ¨¡çµ„ï¼Œä»¥æ”¯æ´ç®¡é“ç¬¦è™Ÿ (|)
      shell: "juju ssh -m {{ k8s_model }} microk8s/0 -- sudo microk8s config | sed 's/127.0.0.1/{{ node_ip }}/g'"
      register: kubeconfig_patched

    # =========================================================
    # ç¬¬äºŒéšæ®µï¼šKubeSphere è‡ªå‹•ç´ç®¡ (API æ“ä½œ)
    # =========================================================
    
    - name: 6. Login to KubeSphere API (Get Token)
      uri:
        url: "{{ ks_url }}/kapis/iam.kubesphere.io/v1alpha2/login"
        method: POST
        body_format: json
        body:
          username: "{{ ks_user }}"
          password: "{{ ks_password }}"
        validate_certs: no
      register: ks_login_response
      delegate_to: localhost 

    - name: 7. Register Cluster to KubeSphere
      uri:
        url: "{{ ks_url }}/kapis/cluster.kubesphere.io/v1alpha1/clusters"
        method: POST
        body_format: json
        headers:
          Authorization: "Bearer {{ ks_login_response.json.access_token }}"
        body:
          apiVersion: "cluster.kubesphere.io/v1alpha1"
          kind: "Cluster"
          metadata:
            name: "{{ k8s_model }}"
            labels:
              cluster-role.kubesphere.io/member: ""
          spec:
            connection:
              type: "direct"
              kubeconfig: "{{ kubeconfig_patched.stdout | b64encode }}"
            provider: "microk8s"
        status_code: [200, 201, 409] # 409 ä»£è¡¨å·²å­˜åœ¨ (ä¸ç®—å¤±æ•—)
        validate_certs: no
      delegate_to: localhost

    - name: Final Status
      debug:
        msg: "ğŸ‰ æˆåŠŸï¼é›†ç¾¤ {{ k8s_model }} (IP: {{ node_ip }}) å·²éƒ¨ç½²ä¸¦è‡ªå‹•è¨»å†Šè‡³ KubeSphereã€‚"
