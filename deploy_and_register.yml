# ==========================================
# ç¬¬ä¸€å ´æˆ²ï¼šåœ¨ Juju Controller ä¸Šç”Ÿæˆé…ç½®
# ==========================================
- name: 1. Deploy and Generate Config (on Juju)
  hosts: all  # ç¢ºä¿ AWX Inventory æŒ‡å‘æ‚¨çš„ Juju Controller (maasjuju)
  gather_facts: no
  vars:
    # [ä¿®æ”¹ 1] ç§»é™¤åŸæœ¬çš„ k8s_model å®šç¾©
    # å› ç‚º AWX Survey æœƒç›´æ¥å‚³å…¥ 'k8s_cluster' é€™å€‹è®Šæ•¸ï¼Œé€™è£¡ä¸éœ€è¦å†å®šç¾©
    # å¦‚æœæ‚¨æƒ³ä¿ç•™é è¨­å€¼ä»¥é˜²è¬ä¸€ï¼Œå¯ä»¥è§£é–‹ä¸‹é¢é€™è¡Œè¨»è§£ï¼Œä½†é€šå¸¸ä¸éœ€è¦ï¼š
    # k8s_cluster: "{{ k8s_cluster | default('k8s-cluster-auto') }}"

    # [ä¿ç•™] é€™äº›å»ºè­°ä¹ŸåŠ å…¥ Surveyï¼Œç›®å‰å…ˆä¿ç•™åœ¨æ­¤ç•¶ä½œé è¨­å€¼
    ks_host_ip: "192.168.100.4"
    ks_host_user: "ubuntu"

  tasks:
    # ----------------------------------------------------------------
    # Juju éƒ¨ç½²éƒ¨åˆ†
    # ----------------------------------------------------------------
    - name: 1.1 Create Juju Model
      # [ä¿®æ”¹ 2] è®Šæ•¸åç¨±æ”¹ç‚º k8s_cluster
      command: "juju add-model {{ k8s_cluster }}"
      ignore_errors: yes

    - name: 1.2 Set Model Base to Ubuntu 22.04
      # [ä¿®æ”¹ 3] è®Šæ•¸åç¨±æ”¹ç‚º k8s_cluster
      command: "juju model-config -m {{ k8s_cluster }} default-base=ubuntu@22.04"
      ignore_errors: yes

    - name: 1.3 Deploy MicroK8s
      # [ä¿®æ”¹ 4] è®Šæ•¸åç¨±æ”¹ç‚º k8s_cluster
      command: "juju deploy microk8s --channel=1.28/stable --base ubuntu@22.04 -m {{ k8s_cluster }}"
      ignore_errors: yes 

    - name: 2. Wait for MicroK8s to be Ready
      # [ä¿®æ”¹ 5] è®Šæ•¸åç¨±æ”¹ç‚º k8s_cluster
      command: >
        juju wait-for application microk8s 
        -m {{ k8s_cluster }} 
        --query='status=="active"' 
        --timeout 20m0s
    # ----------------------------------------------------------------
    # å•Ÿç”¨ MicroK8s å¿…è¦æ’ä»¶ (è§£æ±º PVC æ›ä¸ä¸Šçš„å•é¡Œ)
    # ----------------------------------------------------------------
    - name: 2.1 Enable MicroK8s Storage Addon
      command: "juju ssh -m {{ k8s_cluster }} microk8s/0 -- sudo microk8s enable hostpath-storage"

    - name: 2.2 Enable MicroK8s DNS Addon (æ¨è–¦åŠ å…¥ï¼Œå¦å‰‡æœå‹™ç™¼ç¾æœƒå‡ºéŒ¯)
      command: "juju ssh -m {{ k8s_cluster }} microk8s/0 -- sudo microk8s enable dns"
    # ----------------------------------------------------------------
    # è¨­å®š SANs
    # ----------------------------------------------------------------
    - name: 3. Get Node Public IPv4
      # [ä¿®æ”¹ 6] è®Šæ•¸åç¨±æ”¹ç‚º k8s_cluster
      shell: "juju ssh -m {{ k8s_cluster }} microk8s/0 -- ip -4 -o addr show scope global | grep -v '127.0.0.1' | awk '{print $4}' | cut -d/ -f1 | head -n1"
      register: ip_result

    - name: 4. Set Facts
      set_fact:
        node_ip: "{{ ip_result.stdout | trim }}"

    - name: 5. Add IP to MicroK8s Cert SANs
      # [ä¿®æ”¹ 7] è®Šæ•¸åç¨±æ”¹ç‚º k8s_cluster
      command: "juju config -m {{ k8s_cluster }} microk8s extra_sans={{ node_ip }}"

    - name: 6. Wait for Config Update
      wait_for:
        timeout: 10

    # ----------------------------------------------------------------
    # ç”¢ç”Ÿ Base64 Config ä¸¦å‚³éçµ¦ Host
    # ----------------------------------------------------------------
    - name: 7. Generate Base64 Kubeconfig
      # [ä¿®æ”¹ 8] è®Šæ•¸åç¨±æ”¹ç‚º k8s_cluster
      shell: "juju ssh -m {{ k8s_cluster }} microk8s/0 -- sudo microk8s config | sed 's/127.0.0.1/{{ node_ip }}/g' | base64 -w 0"
      register: kubeconfig_b64

    - name: 8. Add KubeSphere Host to Inventory
      add_host:
        name: "ks_host"
        ansible_host: "{{ ks_host_ip }}"
        ansible_user: "{{ ks_host_user }}"
        # [ä¿®æ”¹ 9] é€™è£¡æœ€é‡è¦ï¼æŠŠ Survey å‚³é€²ä¾†çš„ k8s_cluster å‚³éçµ¦ä¸‹ä¸€å ´æˆ²
        cluster_name: "{{ k8s_cluster }}"
        cluster_config: "{{ kubeconfig_b64.stdout }}"

# ==========================================
# ç¬¬äºŒå ´æˆ²ï¼šåœ¨ KubeSphere Host ä¸ŠåŸ·è¡Œè¨»å†Š
# ==========================================
- name: 2. Register Cluster (on KubeSphere Host)
  hosts: ks_host
  gather_facts: no
  
  tasks:
    - name: 9. Apply Cluster CRD
      shell: |
        cat <<EOF | kubectl apply -f -
        apiVersion: cluster.kubesphere.io/v1alpha1
        kind: Cluster
        metadata:
          name: {{ cluster_name }}
        spec:
          provider: microk8s
          joinFederation: true
          connection:
            type: direct
            kubeconfig: {{ cluster_config }}
        EOF
      register: apply_result

    - name: Final Success Message
      debug:
        msg: "ğŸ‰ å…¨è‡ªå‹•æˆåŠŸï¼é›†ç¾¤ {{ cluster_name }} å·²ç›´æ¥è¨»å†Šè‡³ KubeSphereã€‚"
