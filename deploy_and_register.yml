---
# ==========================================
# ç¬¬ä¸€å ´æˆ²ï¼šåœ¨ Juju Controller ä¸Šç”Ÿæˆé…ç½®
# ==========================================
- name: 1. Deploy and Generate Config (on Juju)
  hosts: all
  gather_facts: no
  vars:
    k8s_model: "k8s-cluster-auto" # AWX Survey æœƒè¦†è“‹æ­¤è®Šæ•¸

  tasks:
    # ----------------------------------------------------------------
    # Juju éƒ¨ç½²éƒ¨åˆ†
    # ----------------------------------------------------------------
    - name: 1.1 Create Juju Model
      command: "juju add-model {{ k8s_model }}"
      ignore_errors: yes

    - name: 1.2 Set Model Base to Ubuntu 22.04
      command: "juju model-config -m {{ k8s_model }} default-base=ubuntu@22.04"
      ignore_errors: yes

    - name: 1.3 Deploy MicroK8s
      command: "juju deploy microk8s --channel=1.28/stable --base ubuntu@22.04 -m {{ k8s_model }}"
      ignore_errors: yes 

    - name: 2. Wait for MicroK8s to be Ready
      command: "juju wait-for application microk8s -m {{ k8s_model }} --query='name==\"microk8s\" && status==\"active\"'"

    # ----------------------------------------------------------------
    # å–å¾—é€£ç·šè³‡è¨Šèˆ‡è¨­å®šæª”
    # ----------------------------------------------------------------
    - name: 3. Get Node Public IPv4
      command: "juju ssh -m {{ k8s_model }} microk8s/0 -- ip -4 -o addr show scope global"
      register: ip_result

    - name: 4. Parse IP Address
      set_fact:
        node_ip: "{{ ip_result.stdout | regex_search('inet ([0-9.]+)', '\\1') | first }}"

    # ----------------------------------------------------------------
    # é—œéµä¿®æ”¹ï¼šç”¢ç”Ÿ Base64 Config ä¸¦å‚³éçµ¦ Host
    # ----------------------------------------------------------------
    - name: 5. Generate Base64 Kubeconfig
      shell: "juju ssh -m {{ k8s_model }} microk8s/0 -- sudo microk8s config | sed 's/127.0.0.1/{{ node_ip }}/g' | base64 -w 0"
      register: kubeconfig_b64

    - name: 6. Add KubeSphere Host to Inventory
      # é€™å€‹å‹•ä½œæ˜¯ã€Œå‹•æ…‹ã€æŠŠ Host åŠ å…¥åŸ·è¡Œæ¸…å–®ï¼Œä¸¦æŠŠè®Šæ•¸å‚³éå»
      add_host:
        name: "ks_host"
        ansible_host: "192.168.1.112" # KubeSphere Host IP
        ansible_user: "garylai"       # ç™»å…¥å¸³è™Ÿ
        # æŠŠæŸ¥åˆ°çš„è³‡æ–™å‚³çµ¦ä¸‹ä¸€å ´æˆ²
        cluster_name: "{{ k8s_model }}"
        cluster_config: "{{ kubeconfig_b64.stdout }}"

# ==========================================
# ç¬¬äºŒå ´æˆ²ï¼šåœ¨ KubeSphere Host ä¸ŠåŸ·è¡Œè¨»å†Š
# ==========================================
- name: 2. Register Cluster (on KubeSphere Host)
  hosts: ks_host
  gather_facts: no
  
  tasks:
    - name: 7. Apply Cluster CRD
      shell: |
        cat <<EOF | kubectl apply -f -
        apiVersion: cluster.kubesphere.io/v1alpha1
        kind: Cluster
        spec:
          provider: microk8s
          connection:
            type: direct
            kubeconfig: {{ cluster_config }}
          joinFederation: true
          config: 
            global:
        metadata:
          name: {{ cluster_name }}
        EOF
      register: apply_result

    - name: Final Success Message
      debug:
        msg: "ğŸ‰ å…¨è‡ªå‹•æˆåŠŸï¼é›†ç¾¤ {{ cluster_name }} å·²ç›´æ¥è¨»å†Šè‡³ KubeSphereã€‚"
