---
- name: Deploy K8s and Register to KubeSphere (CLI Method)
  hosts: all
  gather_facts: no
  vars:
    # --- è®Šæ•¸è¨­å®š ---
    k8s_model: "k8s-cluster-auto" # AWX Survey æœƒè¦†è“‹æ­¤è®Šæ•¸
    # æ³¨æ„ï¼šé€™æ¬¡ä¸éœ€è¦ KubeSphere å¸³å¯†äº†ï¼Œå› ç‚ºæˆ‘å€‘ç›´æ¥ç”¨ kubectl

  tasks:
    # =========================================================
    # ç¬¬ä¸€éšæ®µï¼šJuju éƒ¨ç½² (èˆ‡ä¹‹å‰ç›¸åŒ)
    # =========================================================
    
    - name: 1.1 Create Juju Model
      command: "juju add-model {{ k8s_model }}"
      ignore_errors: yes

    - name: 1.2 Set Model Base to Ubuntu 22.04
      command: "juju model-config -m {{ k8s_model }} default-base=ubuntu@22.04"
      ignore_errors: yes

    - name: 1.3 Deploy MicroK8s
      command: "juju deploy microk8s --channel=1.28/stable --base ubuntu@22.04 -m {{ k8s_model }}"
      ignore_errors: yes 

    - name: 2. Wait for MicroK8s to be Ready
      command: "juju wait-for application microk8s -m {{ k8s_model }} --query='name==\"microk8s\" && status==\"active\"'"

    - name: 3. Get Node Public IPv4
      command: "juju ssh -m {{ k8s_model }} microk8s/0 -- ip -4 -o addr show scope global"
      register: ip_result

    - name: 4. Parse IP Address
      set_fact:
        node_ip: "{{ ip_result.stdout | regex_search('inet ([0-9.]+)', '\\1') | first }}"

    # =========================================================
    # ç¬¬äºŒéšæ®µï¼šæº–å‚™è¨­å®šæª”ä¸¦è¨»å†Š (CLI æ–¹æ³•)
    # =========================================================

    - name: 5. Generate Base64 Kubeconfig
      # ç›´æ¥åœ¨ Juju ç«¯è™•ç†å¥½ IP æ›¿æ›å’Œ Base64 ç·¨ç¢¼ï¼ŒæŠ“å›ä¾†å°±æ˜¯ä¸€è¡Œäº‚ç¢¼
      shell: "juju ssh -m {{ k8s_model }} microk8s/0 -- sudo microk8s config | sed 's/127.0.0.1/{{ node_ip }}/g' | base64 -w 0"
      register: kubeconfig_b64

    - name: 6. Create Cluster CRD Manifest on Host
      # åœ¨ KubeSphere Host ä¸Šç”¢ç”Ÿ YAML æª”æ¡ˆ
      # delegate_to: localhost ä»£è¡¨é€™ä¸€æ­¥æ˜¯åœ¨ AWX åŸ·è¡Œç’°å¢ƒ(æˆ– Host)ä¸Šè·‘ï¼Œè¦–æ‚¨çš„ Inventory è¨­å®š
      # ç‚ºäº†ä¿éšªï¼Œæˆ‘å€‘å‡è¨­æ‚¨çš„ Inventory 'all' æŒ‡å‘çš„æ˜¯ Juju Controller
      # ä½†æˆ‘å€‘éœ€è¦æ“ä½œ KubeSphere Host (192.168.1.112)
      # é€™è£¡æœ€ç°¡å–®çš„æ–¹æ³•æ˜¯ï¼šåˆ©ç”¨ Juju Controller ç•¶è·³æ¿ï¼Œæˆ–è€…ç›´æ¥ç”¨ Ansible çš„ kubernetes.core.k8s æ¨¡çµ„
      # è€ƒæ…®åˆ°æ‚¨çš„ç’°å¢ƒï¼Œæˆ‘å€‘ç”¨æœ€å–®ç´”çš„ 'kubectl' æŒ‡ä»¤ (å‡è¨­ Juju VM ä¸Šæœ‰ kubectl ä¸”èƒ½é€£åˆ° Hostï¼Œæˆ–è€…æˆ‘å€‘ç›´æ¥ SSH åˆ° Host)
      
      # *** é—œéµç­–ç•¥ ***
      # AWX æ˜¯è·‘åœ¨ KubeSphere ä¸Šé¢çš„ï¼Œæ‰€ä»¥ AWX çš„ Pod å…¶å¯¦å¯ä»¥ç›´æ¥å° KubeSphere ä¸‹æŒ‡ä»¤ï¼
      # æˆ‘å€‘ç›´æ¥åœ¨ AWX å®¹å™¨å…§åŸ·è¡Œ kubectl apply
      shell: |
        cat <<EOF | kubectl apply -f -
        apiVersion: cluster.kubesphere.io/v1alpha1
        kind: Cluster
        metadata:
          name: {{ k8s_model }}
          labels:
            cluster-role.kubesphere.io/member: ""
        spec:
          connection:
            type: direct
            kubeconfig: {{ kubeconfig_b64.stdout }}
          provider: microk8s
        EOF
      delegate_to: localhost # åœ¨ AWX å®¹å™¨æœ¬æ©ŸåŸ·è¡Œ
      
    - name: Final Status
      debug:
        msg: "ğŸ‰ æˆåŠŸï¼é›†ç¾¤ {{ k8s_model }} å·²éƒ¨ç½²ä¸¦é€é kubectl å®Œæˆè¨»å†Šã€‚"
