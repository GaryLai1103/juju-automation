---
- name: Deploy K8s and Generate Import YAML
  hosts: all
  gather_facts: no
  vars:
    k8s_model: "k8s-cluster-auto" # AWX Survey æœƒè¦†è“‹æ­¤è®Šæ•¸

  tasks:
    # =========================================================
    # ç¬¬ä¸€éšæ®µï¼šJuju éƒ¨ç½² (å®Œå…¨è‡ªå‹•åŒ–)
    # =========================================================
    
    - name: 1.1 Create Juju Model
      command: "juju add-model {{ k8s_model }}"
      ignore_errors: yes

    - name: 1.2 Set Model Base to Ubuntu 22.04
      command: "juju model-config -m {{ k8s_model }} default-base=ubuntu@22.04"
      ignore_errors: yes

    - name: 1.3 Deploy MicroK8s
      command: "juju deploy microk8s --channel=1.28/stable --base ubuntu@22.04 -m {{ k8s_model }}"
      ignore_errors: yes 

    - name: 2. Wait for MicroK8s to be Ready
      command: "juju wait-for application microk8s -m {{ k8s_model }} --query='name==\"microk8s\" && status==\"active\"'"

    - name: 3. Get Node Public IPv4
      command: "juju ssh -m {{ k8s_model }} microk8s/0 -- ip -4 -o addr show scope global"
      register: ip_result

    - name: 4. Parse IP Address
      set_fact:
        node_ip: "{{ ip_result.stdout | regex_search('inet ([0-9.]+)', '\\1') | first }}"

    # =========================================================
    # ç¬¬äºŒéšæ®µï¼šç”¢ç”Ÿ KubeSphere ç´ç®¡æ‰€éœ€çš„ YAML
    # =========================================================

    - name: 5. Generate Base64 Kubeconfig
      # ç›´æ¥åœ¨ Juju ç«¯è™•ç†å¥½ IP æ›¿æ›å’Œ Base64 ç·¨ç¢¼
      shell: "juju ssh -m {{ k8s_model }} microk8s/0 -- sudo microk8s config | sed 's/127.0.0.1/{{ node_ip }}/g' | base64 -w 0"
      register: kubeconfig_b64

    - name: 6. Show Final Command
      # é€™è£¡ä¸åŸ·è¡Œï¼Œè€Œæ˜¯ç›´æ¥å°å‡ºå®Œæ•´çš„æŒ‡ä»¤ä¾›æ‚¨è¤‡è£½
      debug:
        msg: 
          - "================================================================================="
          - "ğŸ‰ è‡ªå‹•åŒ–éƒ¨ç½²å®Œæˆï¼ç”±æ–¼ AWX ç„¡æ³•ç›´æ¥æ“ä½œ Hostï¼Œè«‹æ‰‹å‹•åŸ·è¡Œæœ€å¾Œä¸€æ­¥ã€‚"
          - "è«‹è¤‡è£½ä¸‹æ–¹ã€ç¶ è‰²æ–‡å­—å€å¡Šã€‘ï¼Œç›´æ¥è²¼ä¸Šåˆ° Host (192.168.1.112) çš„çµ‚ç«¯æ©ŸåŸ·è¡Œï¼š"
          - "================================================================================="
          - "cat <<EOF | kubectl apply -f -"
          - "apiVersion: cluster.kubesphere.io/v1alpha1"
          - "kind: Cluster"
          - "metadata:"
          - "  name: {{ k8s_model }}"
          - "  labels:"
          - "    cluster-role.kubesphere.io/member: \"\""
          - "spec:"
          - "  connection:"
          - "    type: direct"
          - "    kubeconfig: {{ kubeconfig_b64.stdout }}"
          - "  provider: microk8s"
          - "EOF"
          - "================================================================================="
