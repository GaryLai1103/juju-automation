---
# =================================================================
# ç¬¬ä¸€å ´æˆ²ï¼šåœ¨ Juju Controller ä¸Šç”Ÿæˆé…ç½® (Play 1)
# =================================================================
- name: 1. Deploy and Generate Config (on Juju)
  hosts: all
  gather_facts: no
  vars:
    k8s_model: "k8s-cluster-auto" # AWX Survey æœƒè¦†è“‹æ­¤è®Šæ•¸

  tasks:
    # ----------------------------------------------------------------
    # Juju éƒ¨ç½²éƒ¨åˆ† (ä¿ç•™åŸæ¨£)
    # ----------------------------------------------------------------
    - name: 1.1 Create Juju Model
      command: "juju add-model {{ k8s_model }}"
      ignore_errors: yes

    - name: 1.2 Set Model Base to Ubuntu 22.04
      command: "juju model-config -m {{ k8s_model }} default-base=ubuntu@22.04"
      ignore_errors: yes

    - name: 1.3 Deploy MicroK8s
      command: "juju deploy microk8s --channel=1.28/stable --base ubuntu@22.04 -m {{ k8s_model }}"
      ignore_errors: yes 

    - name: 2. Wait for MicroK8s to be Ready
      command: "juju wait-for application microk8s -m {{ k8s_model }} --query='name==\"microk8s\" && status==\"active\"'"

    # ----------------------------------------------------------------
    # å–å¾—é€£ç·šè³‡è¨Šèˆ‡è¨­å®šæª”
    # ----------------------------------------------------------------
    - name: 3. Get Node Public IPv4
      command: "juju ssh -m {{ k8s_model }} microk8s/0 -- ip -4 -o addr show scope global"
      register: ip_result

    - name: 4. Parse IP Address
      set_fact:
        node_ip: "{{ ip_result.stdout | regex_search('inet ([0-9.]+)', '\\1') | first }}"

    - name: 5. Generate Base64 Kubeconfig
      shell: "juju ssh -m {{ k8s_model }} microk8s/0 -- sudo microk8s config | sed 's/127.0.0.1/{{ node_ip }}/g' | base64 -w 0"
      register: kubeconfig_b64

    # ----------------------------------------------------------------
    # å‚³éè®Šæ•¸çµ¦ Host (è«‹ç¢ºèªæ‚¨çš„ KubeSphere å¯†ç¢¼)
    # ----------------------------------------------------------------
    - name: 6. Add KubeSphere Host to Inventory
      add_host:
        name: "ks_host"
        ansible_host: "192.168.1.112"
        ansible_user: "garylai"
        cluster_name: "{{ k8s_model }}"
        cluster_config: "{{ kubeconfig_b64.stdout }}"
        ks_password: "1qaz@WSX"  # <--- æ‚¨çš„ KubeSphere ç™»å…¥å¯†ç¢¼

# =================================================================
# ç¬¬äºŒå ´æˆ²ï¼šåœ¨ KubeSphere Host ä¸Šç”¨ Curl å‘¼å« API (Play 2)
# =================================================================
- name: 2. Register Cluster via Local API (on KubeSphere Host)
  hosts: ks_host
  gather_facts: no
  
  tasks:
    # 1. ç™»å…¥ API å–å¾— Token (ä½¿ç”¨ localhost ç¹éå¤–éƒ¨é™åˆ¶)
    - name: 7. Login and Get Token (Curl)
      shell: |
        curl -s -X POST "http://localhost:30880/kapis/iam.kubesphere.io/v1alpha2/login" \
        -H "Content-Type: application/json" \
        -d '{"username":"admin","password":"{{ ks_password }}"}'
      register: login_response
      ignore_errors: yes # é¿å…ç™»å…¥å¤±æ•—ç›´æ¥ç´…ç‡ˆï¼Œè®“æˆ‘å€‘èƒ½çœ‹åˆ°éŒ¯èª¤è¨Šæ¯

    # ç”¨ Debug å°å‡ºå›æ‡‰ï¼Œè¬ä¸€å¤±æ•—æ‰çŸ¥é“åŸå› 
    - name: 7.1 Debug Login Response
      debug:
        var: login_response.stdout

    - name: 8. Parse Token
      set_fact:
        api_token: "{{ (login_response.stdout | from_json).oauthToken.access_token }}"
      when: login_response.rc == 0 and 'oauthToken' in login_response.stdout

    # 2. ä½¿ç”¨ Token å‘¼å« API å»ºç«‹é›†ç¾¤
    - name: 9. Create Cluster via API (Curl)
      shell: |
        curl -s -X POST "http://localhost:30880/kapis/cluster.kubesphere.io/v1alpha1/clusters" \
        -H "Authorization: Bearer {{ api_token }}" \
        -H "Content-Type: application/json" \
        -d '{
          "apiVersion": "cluster.kubesphere.io/v1alpha1",
          "kind": "Cluster",
          "metadata": {
            "name": "{{ cluster_name }}",
            "labels": {
              "cluster-role.kubesphere.io/member": ""
            }
          },
          "spec": {
            "connection": {
              "type": "direct",
              "kubeconfig": "{{ cluster_config }}"
            },
            "provider": "microk8s"
          }
        }'
      register: create_response
      # åˆ¤æ–·æˆåŠŸæ¢ä»¶ï¼šå›å‚³æˆåŠŸæˆ–å·²å­˜åœ¨
      failed_when: 
        - create_response.rc != 0
        - '"reason" in create_response.stdout and "AlreadyExists" not in create_response.stdout'
      when: api_token is defined

    - name: Final Success Message
      debug:
        msg: "ğŸ‰ API è¨»å†Šå®Œæˆï¼è«‹æª¢æŸ¥ KubeSphere UI æ•¸å­—æ˜¯å¦æ›´æ–°ã€‚"
