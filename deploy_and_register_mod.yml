---
# ==========================================
# ç¬¬ä¸€å ´æˆ²ï¼šåœ¨ Juju Controller ä¸Šç”Ÿæˆé…ç½®
# ==========================================
- name: 1. Deploy and Generate Config (on Juju)
  hosts: all
  gather_facts: no
  vars:
    k8s_model: "k8s-cluster-auto" # AWX Survey æœƒè¦†è“‹æ­¤è®Šæ•¸

  tasks:
    # ----------------------------------------------------
    # 1. åŸºç¤è¨­æ–½éƒ¨ç½² (MAAS + MicroK8s)
    # ----------------------------------------------------
    - name: 1.1 Create Juju Model
      command: "juju add-model {{ k8s_model }}"
      ignore_errors: yes

    - name: 1.2 Set Model Base to Ubuntu 22.04
      command: "juju model-config -m {{ k8s_model }} default-base=ubuntu@22.04"
      ignore_errors: yes

    - name: 1.3 Deploy MicroK8s
      command: "juju deploy microk8s --channel=1.28/stable --base ubuntu@22.04 -m {{ k8s_model }}"
      ignore_errors: yes 

    - name: 2. Wait for MicroK8s to be Ready
      command: "juju wait-for application microk8s -m {{ k8s_model }} --query='name==\"microk8s\" && status==\"active\"'"

    # ----------------------------------------------------
    # 2. å–å¾—é€£ç·šè³‡è¨Šèˆ‡è¨­å®šæª”
    # ----------------------------------------------------
    - name: 3. Get Node Public IPv4
      command: "juju ssh -m {{ k8s_model }} microk8s/0 -- ip -4 -o addr show scope global"
      register: ip_result

    - name: 4. Parse IP Address
      set_fact:
        node_ip: "{{ ip_result.stdout | regex_search('inet ([0-9.]+)', '\\1') | first }}"

    - name: 5. Generate Base64 Kubeconfig
      # ç›´æ¥åœ¨ Juju ç«¯è™•ç†å¥½ IP æ›¿æ›å’Œ Base64 ç·¨ç¢¼
      shell: "juju ssh -m {{ k8s_model }} microk8s/0 -- sudo microk8s config | sed 's/127.0.0.1/{{ node_ip }}/g' | base64 -w 0"
      register: kubeconfig_b64

    # ----------------------------------------------------
    # 3. å‹•æ…‹æ–°å¢ KubeSphere Host åˆ°åŸ·è¡Œæ¸…å–®
    # ----------------------------------------------------
    - name: 6. Add KubeSphere Host to Inventory
      add_host:
        name: "ks_host"
        ansible_host: "192.168.1.112" # KubeSphere Host IP
        ansible_user: "garylai"       # SSH ç™»å…¥å¸³è™Ÿ (éœ€å·²æ‰“é€š SSH Key)
        # å‚³éè®Šæ•¸çµ¦ä¸‹ä¸€å ´æˆ²
        cluster_name: "{{ k8s_model }}"
        cluster_config: "{{ kubeconfig_b64.stdout }}"
        ks_password: "1qaz@WSX"       # KubeSphere ç¶²é ç™»å…¥å¯†ç¢¼

# ==========================================
# ç¬¬äºŒå ´æˆ²ï¼šåœ¨ KubeSphere Host ä¸Šç”¨ Curl æ¨¡æ“¬ç¶²é æ“ä½œ
# ==========================================
- name: 2. Register Cluster via API (on KubeSphere Host)
  hosts: ks_host
  gather_facts: no
  
  tasks:
    - name: 7. Login and Get Token (Curl)
      # ç›´æ¥åœ¨ Host æœ¬æ©Ÿå‘¼å« localhost APIï¼Œæœ€ç©©å®š
      shell: |
        curl -s -X POST "http://localhost:30880/kapis/iam.kubesphere.io/v1alpha2/login" \
        -H "Content-Type: application/json" \
        -d '{"username":"admin","password":"{{ ks_password }}"}'
      register: login_response

    - name: 8. Parse Token
      set_fact:
        # è§£æå›å‚³çš„ JSON å–å¾— Token
        api_token: "{{ (login_response.stdout | from_json).oauthToken.access_token }}"

    - name: 9. Create Cluster via API (Curl)
      # æ¨¡æ“¬ç¶²é é»æ“Šã€Œå°å…¥ã€çš„å‹•ä½œ
      shell: |
        curl -s -X POST "http://localhost:30880/kapis/cluster.kubesphere.io/v1alpha1/clusters" \
        -H "Authorization: Bearer {{ api_token }}" \
        -H "Content-Type: application/json" \
        -d '{
          "apiVersion": "cluster.kubesphere.io/v1alpha1",
          "kind": "Cluster",
          "metadata": {
            "name": "{{ cluster_name }}",
            "labels": {
              "cluster-role.kubesphere.io/member": ""
            }
          },
          "spec": {
            "connection": {
              "type": "direct",
              "kubeconfig": "{{ cluster_config }}"
            },
            "provider": "microk8s"
          }
        }'
      register: create_response
      # å…è¨± 200/201 (æˆåŠŸ) æˆ– 409 (å·²å­˜åœ¨)
      failed_when: 
        - create_response.rc != 0
        - '"reason" in create_response.stdout and "AlreadyExists" not in create_response.stdout'

    - name: Final Success Message
      debug:
        msg: "ğŸ‰ API è¨»å†ŠæˆåŠŸï¼Cluster count æ‡‰è©²å·²ç¶“æ›´æ–°ã€‚"
