---
- name: Deploy K8s and Register via SSH (Stable Version)
  hosts: all
  gather_facts: no
  vars:
    k8s_model: "k8s-cluster-auto" # AWX Survey è¦†è“‹æ­¤è®Šæ•¸
    ks_host_ip: "192.168.1.112"   # KubeSphere Host IP
    ks_host_user: "garylai"       # Host ç™»å…¥å¸³è™Ÿ

  tasks:
    # ----------------------------------------------------
    # 1. åŸºç¤è¨­æ–½éƒ¨ç½² (Juju)
    # ----------------------------------------------------
    - name: 1.1 Create Juju Model
      command: "juju add-model {{ k8s_model }}"
      ignore_errors: yes

    - name: 1.2 Set Model Base to Ubuntu 22.04
      command: "juju model-config -m {{ k8s_model }} default-base=ubuntu@22.04"
      ignore_errors: yes

    - name: 1.3 Deploy MicroK8s
      command: "juju deploy microk8s --channel=1.28/stable --base ubuntu@22.04 -m {{ k8s_model }}"
      ignore_errors: yes 

    - name: 2. Wait for MicroK8s to be Ready
      command: "juju wait-for application microk8s -m {{ k8s_model }} --query='name==\"microk8s\" && status==\"active\"'"

    # ----------------------------------------------------
    # 2. æº–å‚™ Kubeconfig
    # ----------------------------------------------------
    - name: 3. Get Node Public IPv4
      command: "juju ssh -m {{ k8s_model }} microk8s/0 -- ip -4 -o addr show scope global"
      register: ip_result

    - name: 4. Parse IP Address
      set_fact:
        node_ip: "{{ ip_result.stdout | regex_search('inet ([0-9.]+)', '\\1') | first }}"

    - name: 5. Generate Base64 Kubeconfig
      # ã€ä¿®æ­£é‡é»ã€‘åŠ å…¥ -o StrictHostKeyChecking=no å’Œ -o UserKnownHostsFile=/dev/null
      # é€™æ¨£ Juju SSH é€£ç·šæ™‚å°±ä¸æœƒå› ç‚ºæŒ‡ç´‹è®Šæ›´è€Œå¡ä½
      shell: "juju ssh -m {{ k8s_model }} microk8s/0 -- -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null sudo microk8s config | sed 's/127.0.0.1/{{ node_ip }}/g' | base64 -w 0"
      register: kubeconfig_b64

    # ----------------------------------------------------
    # 3. é€é SSH é ç«¯åŸ·è¡Œè¨»å†Š (ç©©å®šç‰ˆï¼šå…ˆç”¢æª” -> å†å‚³é€ -> å†åŸ·è¡Œ)
    # ----------------------------------------------------
    
    # æ­¥é©Ÿ 6.1: å…ˆåœ¨ Juju VM æœ¬åœ°ç”¢ç”Ÿæ­£ç¢ºçš„ YAML æª”æ¡ˆ
    # é€™æ¨£å¯ä»¥ç¢ºä¿ Ansible è®Šæ•¸ ({{ ... }}) å®Œç¾å¡«å…¥ï¼Œä¸æœƒå— SSH å½±éŸ¿
    - name: 6.1 Create Import YAML locally on Juju VM
      copy:
        dest: "/tmp/{{ k8s_model }}_import.yaml"
        content: |
          apiVersion: cluster.kubesphere.io/v1alpha1
          kind: Cluster
          metadata:
            name: {{ k8s_model }}
            labels:
              cluster-role.kubesphere.io/member: ""
          spec:
            connection:
              type: direct
              kubeconfig: {{ kubeconfig_b64.stdout }}
            provider: microk8s

    # æ­¥é©Ÿ 6.2: æŠŠæª”æ¡ˆå‚³é€åˆ° KubeSphere Host
    - name: 6.2 SCP YAML to Host
      shell: >
        scp -i ~/.ssh/awx_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null
        /tmp/{{ k8s_model }}_import.yaml
        {{ ks_host_user }}@{{ ks_host_ip }}:/tmp/{{ k8s_model }}_import.yaml

    # æ­¥é©Ÿ 6.3: åœ¨ Host ä¸ŠåŸ·è¡Œ Apply (ä½¿ç”¨ kubectl çš„çµ•å°è·¯å¾‘)
    # æˆ‘å€‘å…ˆç”¨ 'which kubectl' æ‰¾è·¯å¾‘ï¼Œæ‰¾ä¸åˆ°å°±é è¨­ /usr/local/bin/kubectl
    - name: 6.3 Apply YAML on Host
      shell: |
        ssh -i ~/.ssh/awx_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null {{ ks_host_user }}@{{ ks_host_ip }} "
        # å˜—è©¦å°‹æ‰¾ kubectlï¼Œè‹¥æ‰¾ä¸åˆ°å‰‡å˜—è©¦å¸¸è¦‹è·¯å¾‘
        KUBECTL=\$(which kubectl || echo /usr/local/bin/kubectl || echo /usr/bin/kubectl)
        \$KUBECTL apply -f /tmp/{{ k8s_model }}_import.yaml
        "
      register: apply_result

    - name: Final Status
      debug:
        msg: 
          - "ğŸ‰ æˆåŠŸï¼å·²é€é SSH æª”æ¡ˆå‚³è¼¸æ–¹å¼è¨»å†Šé›†ç¾¤ã€‚"
          - "Host å›æ‡‰: {{ apply_result.stdout }}"

    - name: Final Status
      debug:
        msg: 
          - "ğŸ‰ æˆåŠŸï¼é›†ç¾¤ {{ k8s_model }} å·²è¨»å†Šã€‚"
          - "KubeSphere æœå‹™æ­£åœ¨é‡å•Ÿä»¥åˆ·æ–°æ•¸æ“šï¼Œè«‹ç¨ç­‰ 1 åˆ†é˜å¾Œåˆ·æ–°ç¶²é ã€‚"
