---
- name: Deploy K8s and Register via SSH (Stable Version)
  hosts: all
  gather_facts: no
  vars:
    k8s_model: "k8s-cluster-auto" # AWX Survey è¦†è“‹æ­¤è®Šæ•¸
    ks_host_ip: "192.168.1.112"   # KubeSphere Host IP
    ks_host_user: "garylai"       # Host ç™»å…¥å¸³è™Ÿ

  tasks:
    # ----------------------------------------------------
    # 1. åŸºç¤è¨­æ–½éƒ¨ç½² (Juju)
    # ----------------------------------------------------
    - name: 1.1 Create Juju Model
      command: "juju add-model {{ k8s_model }}"
      ignore_errors: yes

    - name: 1.2 Set Model Base to Ubuntu 22.04
      command: "juju model-config -m {{ k8s_model }} default-base=ubuntu@22.04"
      ignore_errors: yes

    - name: 1.3 Deploy MicroK8s
      command: "juju deploy microk8s --channel=1.28/stable --base ubuntu@22.04 -m {{ k8s_model }}"
      ignore_errors: yes 

    - name: 2. Wait for MicroK8s to be Ready
      command: "juju wait-for application microk8s -m {{ k8s_model }} --query='name==\"microk8s\" && status==\"active\"'"

    # ----------------------------------------------------
    # 2. æº–å‚™ Kubeconfig
    # ----------------------------------------------------
    - name: 3. Get Node Public IPv4
      command: "juju ssh -m {{ k8s_model }} microk8s/0 -- ip -4 -o addr show scope global"
      register: ip_result

    - name: 4. Parse IP Address
      set_fact:
        node_ip: "{{ ip_result.stdout | regex_search('inet ([0-9.]+)', '\\1') | first }}"

    - name: 5. Generate Base64 Kubeconfig
      shell: "juju ssh -m {{ k8s_model }} microk8s/0 -- sudo microk8s config | sed 's/127.0.0.1/{{ node_ip }}/g' | base64 -w 0"
      register: kubeconfig_b64

    # ----------------------------------------------------
    # 3. é€é SSH é ç«¯åŸ·è¡Œè¨»å†Š (ä¿è­‰æˆåŠŸ)
    # ----------------------------------------------------
    - name: 6. Remote Register on KubeSphere Host
      shell: |
        ssh -o StrictHostKeyChecking=no {{ ks_host_user }}@{{ ks_host_ip }} "cat <<EOF | kubectl apply -f -
        apiVersion: cluster.kubesphere.io/v1alpha1
        kind: Cluster
        metadata:
          name: {{ k8s_model }}
          labels:
            cluster-role.kubesphere.io/member: \"\"
        spec:
          connection:
            type: direct
            kubeconfig: {{ kubeconfig_b64.stdout }}
          provider: microk8s
        EOF"
      register: ssh_result

    # ----------------------------------------------------
    # 4. å¼·åŠ›åˆ·æ–° UI (é‡å•Ÿå¾Œç«¯èˆ‡å‰ç«¯)
    # ----------------------------------------------------
    - name: 7. Force Refresh UI (Restart KS Services)
      shell: |
        ssh -o StrictHostKeyChecking=no {{ ks_host_user }}@{{ ks_host_ip }} "kubectl rollout restart deployment ks-apiserver -n kubesphere-system && kubectl rollout restart deployment ks-console -n kubesphere-system"
      ignore_errors: yes

    - name: Final Status
      debug:
        msg: 
          - "ğŸ‰ æˆåŠŸï¼é›†ç¾¤ {{ k8s_model }} å·²è¨»å†Šã€‚"
          - "KubeSphere æœå‹™æ­£åœ¨é‡å•Ÿä»¥åˆ·æ–°æ•¸æ“šï¼Œè«‹ç¨ç­‰ 1 åˆ†é˜å¾Œåˆ·æ–°ç¶²é ã€‚"
