---
- name: éƒ¨ç½² PyTorch GPU æ¸¬è©¦ç’°å¢ƒ (Restore Burn Tool)
  hosts: maasjuju
  gather_facts: no
  vars:
    # é€™æ˜¯é è¨­å€¼ï¼Œå¯¦éš›æœƒè¢« AWX Survey è¦†è“‹
    slurm_model: "hpc-lab"
    worker_tag: "slurm-node"

  tasks:
    # ====================================================
    # 1. è‡ªå‹•åµæ¸¬ GPU Worker çš„ ID (Machine 1)
    # ====================================================
    - name: 1. åµæ¸¬ GPU Worker ID
      shell: |
        # æŠ“å– Juju æ©Ÿå™¨åˆ—è¡¨ä¸¦è§£æ JSON
        STATUS=$(juju machines -m {{ slurm_model }} --format json)
        
        # ä½¿ç”¨ jq éæ¿¾å‡ºå¸¶æœ‰ 'slurm-node' æ¨™ç±¤çš„æ©Ÿå™¨ ID
        # å¦‚æœæ‚¨çš„æ¨™ç±¤ä¸åŒï¼Œè«‹ä¿®æ”¹ä¸Šé¢çš„ vars
        WORKER_ID=$(echo $STATUS | jq -r '.machines | to_entries[] | select(.value.constraints | contains("tags={{ worker_tag }}")) | .key' | head -n 1)
        
        # å¦‚æœæ‰¾ä¸åˆ°ï¼Œé è¨­å›é€€åˆ° '1' (å‡è¨­ Machine 1)
        if [ -z "$WORKER_ID" ]; then echo "1"; else echo "$WORKER_ID"; fi
      register: worker_id_result
      changed_when: false

    - name: 1.1 é¡¯ç¤ºåµæ¸¬åˆ°çš„ Worker ID
      debug:
        msg: "å³å°‡éƒ¨ç½²åˆ° Model: {{ slurm_model }}, Machine ID: {{ worker_id_result.stdout }}"

    # ====================================================
    # 2. é ç«¯å®‰è£ Python ç’°å¢ƒèˆ‡ PyTorch
    # ====================================================
    - name: 2. å®‰è£ venv ä¸¦å»ºç«‹ PyTorch ç’°å¢ƒ (é€™å¯èƒ½éœ€è¦å¹¾åˆ†é˜)
      shell: |
        juju ssh -m {{ slurm_model }} {{ worker_id_result.stdout }} "
          # A. å®‰è£ç³»çµ±å¥—ä»¶
          echo 'ğŸ“¦ Updating apt and installing venv...'
          sudo apt-get update -qq
          sudo apt-get install -y python3-venv python3-pip

          # B. å»ºç«‹è™›æ“¬ç’°å¢ƒ (å¦‚æœå·²å­˜åœ¨å‰‡è·³é)
          if [ ! -d 'gpu-test-env' ]; then
            echo 'ğŸ“‚ Creating virtual environment...'
            python3 -m venv gpu-test-env
          fi

          # C. å®‰è£ PyTorch (ç›´æ¥å‘¼å« venv è£¡çš„ pipï¼Œç¢ºä¿è£åœ¨è™›æ“¬ç’°å¢ƒå…§)
          echo 'ğŸ”¥ Installing PyTorch (CUDA 12.1)... This takes time!'
          ./gpu-test-env/bin/pip install --upgrade pip
          ./gpu-test-env/bin/pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121
        "
      # è¨­å®šè¼ƒé•·çš„ timeoutï¼Œå› ç‚ºä¸‹è¼‰ PyTorch å¾ˆæ…¢ (30åˆ†é˜)
      async: 1800
      poll: 10
