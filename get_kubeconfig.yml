---
- name: Get Clean Kubeconfig
  hosts: all
  gather_facts: no
  vars:
    k8s_model: "k8s-cluster-02" # 預設值

  tasks:
    # 1. 抓取正確的對外 IP (IPv4)
    - name: Get Node Public IPv4
      command: "juju ssh -m {{ k8s_model }} microk8s/0 -- ip -4 -o addr show scope global"
      register: ip_result

    # 使用正則表達式提取第一個非 127.0.0.1 的 IP
    - name: Parse IP
      set_fact:
        node_ip: "{{ ip_result.stdout | regex_search('inet ([0-9.]+)', '\\1') | first }}"

    # 2. 抓取原始 Config 並直接在記憶體中替換 IP
    - name: Get and Patch Kubeconfig
      # 這裡用了 sed 直接把 127.0.0.1 換成 node_ip
      command: "juju ssh -m {{ k8s_model }} microk8s/0 -- sudo microk8s config | sed 's/127.0.0.1/{{ node_ip }}/g'"
      register: kubeconfig_patched

    # 3. 輸出乾淨的結果
    - name: ==========================================
      debug:
        msg: 
          - "---------------------------------------------------"
          - " 集群: {{ k8s_model }} / IP: {{ node_ip }}"
          - " 下方內容已修正 IP，請直接複製貼上至 KubeSphere"
          - "---------------------------------------------------"

    - name: KUBECONFIG OUTPUT
      debug:
        var: kubeconfig_patched.stdout_lines
