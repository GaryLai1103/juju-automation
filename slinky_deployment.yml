---
# ==========================================
# SKU: Infra-Test-MicroK8s-v0.7.1 (Syntax Fix)
# 修正：
#   1. 修復 YAML 語法錯誤 (Task 4.2 名稱中的冒號問題)
#   2. 包含 Retry 機制與正確的 Action 名稱
# ==========================================
- name: Infrastructure Test - Deploy MicroK8s via Juju
  hosts: maasjuju
  gather_facts: no
  vars:
    test_model: "slinky-cluster"
    target_os: "ubuntu@22.04"
    k8s_channel: "1.28/stable"
    master_tag: "virtual"
    worker_tag: "slurm-node"

  tasks:
    # -------------------------------------------------------
    # 1. 環境清理
    # -------------------------------------------------------
    - name: 1.0 強制清理舊的測試模型 (若存在)
      command: "juju destroy-model {{ test_model }} --no-prompt --force --destroy-storage"
      register: destroy_result
      failed_when: 
        - destroy_result.rc != 0 
        - '"not found" not in destroy_result.stderr'
      ignore_errors: yes

    - name: 1.1 等待模型完全釋放
      pause:
        seconds: 15

    - name: 1.2 建立全新 Juju Model
      shell: juju add-model {{ test_model }}

    # -------------------------------------------------------
    # 2. 請求機器 (無 Config 部署)
    # -------------------------------------------------------
    - name: 2.1 請求 Control Plane (k8s-master)
      shell: |
        juju deploy microk8s k8s-master \
          --model {{ test_model }} \
          --channel {{ k8s_channel }} \
          --constraints "tags={{ master_tag }}" \
          --base {{ target_os }}

    - name: 2.2 請求 GPU Worker (k8s-worker)
      shell: |
        juju deploy microk8s k8s-worker \
          --model {{ test_model }} \
          --channel {{ k8s_channel }} \
          --constraints "tags={{ worker_tag }}" \
          --base {{ target_os }}

    # -------------------------------------------------------
    # 3. 建立關聯 (整合 Retry 機制)
    # -------------------------------------------------------
    - name: 3.1 建立 Master 與 Worker 的叢集關係
      shell: |
        juju integrate k8s-master:microk8s k8s-worker:microk8s --model {{ test_model }}
      register: integrate_result
      until: integrate_result.rc == 0
      retries: 20       # 最多重試 20 次
      delay: 10         # 每次間隔 10 秒

    # -------------------------------------------------------
    # 4. 部署後驗收與功能啟用
    # -------------------------------------------------------
    - name: 4.1 等待機器分配與部署 (這一步會最久)
      shell: |
        juju status --model {{ test_model }} --format json | jq -r '.machines[]."agent-status".current' | grep -E "started" | wc -l
      register: machine_ready
      until: machine_ready.stdout | int >= 2
      retries: 100  # 約 16 分鐘
      delay: 10
      ignore_errors: yes 

    - name: "4.2 啟用基礎設施插件 (Action: enable)" # <--- 這裡加了引號
      shell: |
        # 修正：MicroK8s Charm 的動作名稱是 "enable"
        # 我們也加上 Retry，防止機器剛開機還沒準備好接 Action
        juju run k8s-master/0 enable addon=dns --model {{ test_model }}
        juju run k8s-master/0 enable addon=rbac --model {{ test_model }}
        juju run k8s-master/0 enable addon=hostpath-storage --model {{ test_model }}
      register: action_result
      until: action_result.rc == 0
      retries: 5
      delay: 10
      ignore_errors: yes

    - name: 4.3 在 Worker 啟用 GPU
      shell: |
        juju run k8s-worker/0 enable addon=gpu --model {{ test_model }}
      ignore_errors: yes

    - name: ✅ 部署指令完成
      debug:
        msg: "基礎建設部署請求已完成。請登入 maasjuju 使用 'juju status -m {{ test_model }} --watch 1s' 查看即時進度。"
