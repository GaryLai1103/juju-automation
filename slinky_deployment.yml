---
# ==========================================
# SKU: Slinky-K8s-v1.3-Modern
# 目標：配合 KubeSphere 規格，部署現代化 K8s (1.31+)
# 修正：
#   1. 版本對齊：升級至 1.31/stable (接近您截圖中的 v1.32)
#   2. 組件優化：使用現代化 CNI 與 Runtime
# ==========================================
- name: Infrastructure Test - Deploy Modern Charmed Kubernetes
  hosts: maasjuju
  gather_facts: yes
  vars:
    # 建議名稱，方便與 KubeSphere 對接
    test_model: "slinky-cluster"
    # 配合您截圖的版本，選擇目前 Juju 支援最穩定的新版
    k8s_channel: "1.31/stable"
    bundle_path: "{{ ansible_user_dir }}/charmed-k8s-modern.yaml"

  tasks:
    # -------------------------------------------------------
    # 1. 環境清理
    # -------------------------------------------------------
    - name: 1.0 強制清理舊模型
      command: "juju destroy-model {{ test_model }} --no-prompt --force --destroy-storage"
      register: destroy_result
      ignore_errors: yes

    - name: 1.1 等待模型釋放
      pause:
        seconds: 15

    - name: 1.2 建立全新 Juju Model
      shell: juju add-model {{ test_model }}

    # -------------------------------------------------------
    # 2. 製作藍圖 (與您之前的三節點邏輯一致)
    # -------------------------------------------------------
    - name: 2.1 產生現代化 K8s Bundle
      copy:
        dest: "{{ bundle_path }}"
        mode: '0644'
        content: |
          description: Slinky Modern K8s Cluster
          series: jammy
          
          machines:
            "0":
              constraints: tags=virtual
            "1":
              constraints: tags=slurm-node

          applications:
            easyrsa:
              charm: easyrsa
              num_units: 1
              to: ["0"]
            
            etcd:
              charm: etcd
              num_units: 1
              to: ["0"]
              options:
                channel: 3.4/stable

            kubernetes-control-plane:
              charm: kubernetes-control-plane
              channel: {{ k8s_channel }}
              num_units: 1
              to: ["0"]
              options:
                allow-privileged: "true"

            kubernetes-worker:
              charm: kubernetes-worker
              channel: {{ k8s_channel }}
              num_units: 1
              to: ["1"]
              expose: true

            # 現代化網路插件
            calico:
              charm: calico
              
            containerd:
              charm: containerd

          relations:
            - ["kubernetes-control-plane:kube-control", "kubernetes-worker:kube-control"]
            - ["kubernetes-control-plane:certificates", "easyrsa:client"]
            - ["etcd:certificates", "easyrsa:client"]
            - ["kubernetes-control-plane:etcd", "etcd:db"]
            - ["kubernetes-worker:certificates", "easyrsa:client"]
            - ["calico:etcd", "etcd:db"]
            - ["calico:cni", "kubernetes-control-plane:cni"]
            - ["calico:cni", "kubernetes-worker:cni"]
            - ["containerd:containerd", "kubernetes-worker:container-runtime"]
            - ["containerd:containerd", "kubernetes-control-plane:container-runtime"]

    # -------------------------------------------------------
    # 3. 執行部署
    # -------------------------------------------------------
    - name: 3.1 部署 Bundle
      shell: |
        juju deploy {{ bundle_path }} --model {{ test_model }} --trust

    # -------------------------------------------------------
    # 4. 監控與驗收
    # -------------------------------------------------------
    - name: 4.1 等待 K8s 狀態變為 Active
      shell: |
        juju status --model {{ test_model }} --format json | jq -r '
          .applications["kubernetes-worker"]["application-status"].current == "active"
        '
      register: k8s_ready
      until: k8s_ready.stdout | trim == "true"
      retries: 300 
      delay: 10

    - name: ✅ 現代化叢集部署完成
      debug:
        msg: "版本 v1.31 部署完成。這比之前的 1.28 更接近您的 KubeSphere 環境！"
