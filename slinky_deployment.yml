---
# ==========================================
# SKU: Slinky-K8s-v1.5-Final
# 修正：
#   1. 將 etcd channel 改為 latest/stable 以符合 ubuntu@22.04
#   2. 保持 slinky-cluster 模型名稱與 1.31/stable 版本
# ==========================================
- name: Infrastructure Test - Deploy Modern Charmed Kubernetes
  hosts: maasjuju
  gather_facts: yes
  vars:
    test_model: "slinky-cluster"
    k8s_channel: "1.31/stable"
    bundle_path: "{{ ansible_user_dir }}/charmed-k8s-modern.yaml"

  tasks:
    # 1. 環境清理
    - name: 1.0 強制清理舊模型
      command: "juju destroy-model {{ test_model }} --no-prompt --force --destroy-storage"
      register: destroy_result
      failed_when: 
        - destroy_result.rc != 0 
        - '"not found" not in destroy_result.stderr'
      ignore_errors: yes

    - name: 1.1 等待模型釋放
      pause:
        seconds: 15

    - name: 1.2 建立全新 Juju Model
      shell: juju add-model {{ test_model }}

    # 2. 製作藍圖
    - name: 2.1 產生本地 Bundle 檔案
      copy:
        dest: "{{ bundle_path }}"
        mode: '0644'
        content: |
          description: Slinky Modern K8s Cluster
          base: ubuntu@22.04
          
          machines:
            "0":
              constraints: tags=virtual
            "1":
              constraints: tags=slurm-node

          applications:
            easyrsa:
              charm: easyrsa
              channel: latest/stable
              num_units: 1
              to: ["0"]
            
            etcd:
              charm: etcd
              # 修正：這裡改用 latest/stable，因為 3.4/stable 不支援 22.04 base
              channel: latest/stable
              num_units: 1
              to: ["0"]

            kubernetes-control-plane:
              charm: kubernetes-control-plane
              channel: {{ k8s_channel }}
              num_units: 1
              to: ["0"]
              options:
                allow-privileged: "true"

            kubernetes-worker:
              charm: kubernetes-worker
              channel: {{ k8s_channel }}
              num_units: 1
              to: ["1"]
              expose: true

            calico:
              charm: calico
              channel: latest/stable
              
            containerd:
              charm: containerd
              channel: latest/stable

          relations:
            - ["kubernetes-control-plane:kube-control", "kubernetes-worker:kube-control"]
            - ["kubernetes-control-plane:certificates", "easyrsa:client"]
            - ["etcd:certificates", "easyrsa:client"]
            - ["kubernetes-control-plane:etcd", "etcd:db"]
            - ["kubernetes-worker:certificates", "easyrsa:client"]
            - ["calico:etcd", "etcd:db"]
            - ["calico:cni", "kubernetes-control-plane:cni"]
            - ["calico:cni", "kubernetes-worker:cni"]
            - ["containerd:containerd", "kubernetes-worker:container-runtime"]
            - ["containerd:containerd", "kubernetes-control-plane:container-runtime"]

    # 3. 執行部署
    - name: 3.1 部署 Bundle
      shell: |
        juju deploy {{ bundle_path }} --model {{ test_model }} --trust
      register: deploy_out
      until: deploy_out.rc == 0
      retries: 3
      delay: 10

    # 4. 監控與驗收
    - name: 4.1 等待 K8s 狀態變為 Active
      shell: |
        juju status --model {{ test_model }} --format json | jq -r '
          .applications["kubernetes-worker"]["application-status"].current == "active"
        '
      register: k8s_ready
      until: k8s_ready.stdout | trim == "true"
      retries: 500 
      delay: 60

    # 5. Local Path Provisioner
    - name: 5.1 安裝 Local Path Provisioner
      kubernetes.core.k8s:
        state: present
        src: https://raw.githubusercontent.com/rancher/local-path-provisioner/v0.0.30/deploy/local-path-storage.yaml
      environment:
        KUBECONFIG: "/home/gary/.kube/config"

    - name: 5.2 設定為預設 StorageClass
      shell: |
        kubectl patch storageclass local-path -p '{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"true"}}}'

    - name: ✅ 部署完成
      debug:
        msg: "Charmed Kubernetes 已成功開始部署。etcd 已修正為 latest/stable 以支援 Ubuntu 22.04。"
