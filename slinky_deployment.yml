---
# ==========================================
# SKU: Slinky-CharmedK8s-v1.0 (The Real Deal)
# 目標：放棄 MicroK8s，改用正規 Charmed Kubernetes
# 架構：
#   - Machine 0 (VM): Control Plane + Etcd + PKI
#   - Machine 1 (GPU): Worker Node
# 優勢：
#   1. 原生支援 Master/Worker 分離架構
#   2. 完美支援 juju integrate，不再有 "no relation" 錯誤
#   3. 生產級架構，適合 HPC/Slinky
# ==========================================
- name: Infrastructure Test - Deploy Charmed Kubernetes
  hosts: maasjuju
  gather_facts: no
  vars:
    test_model: "slinky-cluster"
    # 使用 Charmed Kubernetes 的標準 Channel
    k8s_channel: "1.28/stable"
    bundle_path: "/tmp/charmed-k8s-bundle.yaml"

  tasks:
    # -------------------------------------------------------
    # 1. 環境清理
    # -------------------------------------------------------
    - name: 1.0 強制清理舊模型
      command: "juju destroy-model {{ test_model }} --no-prompt --force --destroy-storage"
      register: destroy_result
      failed_when: 
        - destroy_result.rc != 0 
        - '"not found" not in destroy_result.stderr'
      ignore_errors: yes

    - name: 1.1 等待模型釋放
      pause:
        seconds: 15

    - name: 1.2 建立全新 Juju Model
      shell: juju add-model {{ test_model }}

    # -------------------------------------------------------
    # 2. 定義正規 K8s Bundle
    # 說明：這裡我們把 K8s 拆解成獨立組件，並定義它們的去向
    # -------------------------------------------------------
    - name: 2.1 產生 Charmed K8s Bundle
      copy:
        dest: "{{ bundle_path }}"
        content: |
          description: Slinky Standard K8s Cluster
          series: jammy
          
          # --- 機器定義 ---
          machines:
            "0":
              constraints: tags=virtual
            "1":
              constraints: tags=slurm-node

          # --- 應用程式定義 ---
          applications:
            # 1. 憑證中心 (放在 VM)
            easyrsa:
              charm: easyrsa
              num_units: 1
              to: ["0"]
            
            # 2. 資料庫 (放在 VM)
            etcd:
              charm: etcd
              num_units: 1
              to: ["0"]
              options:
                channel: 3.4/stable

            # 3. 控制平面 Master (放在 VM)
            kubernetes-control-plane:
              charm: kubernetes-control-plane
              channel: {{ k8s_channel }}
              num_units: 1
              to: ["0"]
              options:
                # 允許特權模式 (對某些 HPC 應用重要)
                allow-privileged: "true"

            # 4. 運算節點 Worker (放在 GPU 裸機)
            kubernetes-worker:
              charm: kubernetes-worker
              channel: {{ k8s_channel }}
              num_units: 1
              to: ["1"]
              expose: true

            # 5. 網路插件 (Calico 是標準)
            calico:
              charm: calico
              
            # 6. 容器運行時
            containerd:
              charm: containerd

          # --- 關聯定義 (這就是 Juju 的魔法) ---
          relations:
            - ["kubernetes-control-plane:kube-control", "kubernetes-worker:kube-control"]
            - ["kubernetes-control-plane:certificates", "easyrsa:client"]
            - ["etcd:certificates", "easyrsa:client"]
            - ["kubernetes-control-plane:etcd", "etcd:db"]
            - ["kubernetes-worker:certificates", "easyrsa:client"]
            - ["calico:etcd", "etcd:db"]
            - ["calico:cni", "kubernetes-control-plane:cni"]
            - ["calico:cni", "kubernetes-worker:cni"]
            - ["containerd:containerd", "kubernetes-worker:container-runtime"]
            - ["containerd:containerd", "kubernetes-control-plane:container-runtime"]

    # -------------------------------------------------------
    # 3. 部署 Bundle
    # -------------------------------------------------------
    - name: 3.1 執行部署 (Fire and Forget)
      shell: |
        juju deploy {{ bundle_path }} --model {{ test_model }} --trust

    # -------------------------------------------------------
    # 4. 監控與收尾
    # -------------------------------------------------------
    - name: 4.1 等待部署完成 (Smart Wait)
      shell: |
        # 檢查 Worker 是否已經 active 且 idle
        juju status --model {{ test_model }} --format json | jq -r '
          .applications["kubernetes-worker"]["application-status"].current == "active"
        '
      register: k8s_ready
      until: k8s_ready.stdout | trim == "true"
      # 正規 K8s 組件較多，安裝時間會比 MicroK8s 稍長
      retries: 240 # 40 分鐘
      delay: 10
      ignore_errors: no

    - name: ✅ 部署完成
      debug:
        msg: "正規 Charmed Kubernetes 部署完成！這是一個標準的 Master/Worker 分離架構。"
