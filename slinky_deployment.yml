---
# ==========================================
# SKU: Slinky-MicroK8s-v7.0 (Smart Wait)
# 目標：智慧監控 Juju 狀態，機器一好立刻執行後續動作，不浪費時間
# 流程：
#   1. 極速部署 (Deploy & Integrate)
#   2. 智慧等待 (Smart Wait) -> 直到狀態變更為 Active/Idle
#   3. 執行 Action (Enable Addons)
# ==========================================
- name: Infrastructure Test - Scalable MicroK8s Deployment
  hosts: maasjuju
  gather_facts: no
  vars:
    test_model: "slinky-cluster"
    k8s_channel: "1.28/stable"
    constraint_master: "tags=virtual"
    constraint_worker: "tags=slurm-node"

  tasks:
    # -------------------------------------------------------
    # 1. 環境清理 (保持不變)
    # -------------------------------------------------------
    - name: 1.0 強制清理舊的測試模型
      command: "juju destroy-model {{ test_model }} --no-prompt --force --destroy-storage"
      register: destroy_result
      failed_when: 
        - destroy_result.rc != 0 
        - '"not found" not in destroy_result.stderr'
      ignore_errors: yes

    - name: 1.1 等待模型釋放
      pause:
        seconds: 15

    - name: 1.2 建立全新 Juju Model
      shell: juju add-model {{ test_model }}

    # -------------------------------------------------------
    # 2. 極速部署 (保持不變)
    # -------------------------------------------------------
    - name: 2.1 部署 k8s-master
      shell: |
        juju deploy microk8s k8s-master \
          --model {{ test_model }} \
          --channel {{ k8s_channel }} \
          --constraints "{{ constraint_master }}"

    - name: 2.2 部署 k8s-worker
      shell: |
        juju deploy microk8s k8s-worker \
          --model {{ test_model }} \
          --channel {{ k8s_channel }} \
          --constraints "{{ constraint_worker }}"

    - name: 3.1 預先建立叢集關聯
      shell: |
        juju integrate k8s-master:microk8s k8s-worker:microk8s --model {{ test_model }}
      register: integrate_result
      until: integrate_result.rc == 0
      retries: 20 
      delay: 5

    # -------------------------------------------------------
    # 4. 智慧等待 (Smart Wait) - 核心修改
    # 說明：每 30 秒檢查一次 Juju 狀態，直到 Master 和 Worker 都準備好
    # -------------------------------------------------------
    - name: 4.1 動態監控機器狀態 (等待 Agent 就緒)
      shell: |
        # 抓取狀態為 json
        # 檢查 k8s-master/0 和 k8s-worker/0 的 workload-status 是否為 'active'
        # 或者是檢查 machines 的 agent-status 是否為 'started'
        
        juju status --model {{ test_model }} --format json | jq -r '
          .machines["0"]["agent-status"].current == "started" and 
          .machines["1"]["agent-status"].current == "started"
        '
      register: deployment_check
      # 條件：當 jq 回傳 "true" 時停止等待
      until: deployment_check.stdout | trim == "true"
      # 設定最大等待時間：30秒 * 120次 = 60分鐘 (足夠裸機安裝)
      retries: 120
      delay: 30
      ignore_errors: no # 這裡不能忽略錯誤，必須確保機器真的好了

    # 額外緩衝：Agent 剛起來可能還沒準備好接 Action，多等 30 秒保險
    - name: 4.2 服務暖機緩衝
      pause:
        seconds: 30

    # -------------------------------------------------------
    # 5. 功能啟用 (現在執行絕對安全)
    # -------------------------------------------------------
    - name: 5.1 啟用基礎設施 (Master)
      shell: |
        juju run k8s-master/0 enable addon=dns --model {{ test_model }}
        juju run k8s-master/0 enable addon=rbac --model {{ test_model }}
        juju run k8s-master/0 enable addon=hostpath-storage --model {{ test_model }}
      ignore_errors: yes

    - name: 5.2 啟用 GPU (Worker)
      shell: |
        juju run k8s-worker/0 enable addon=gpu --model {{ test_model }}
      ignore_errors: yes

    - name: ✅ 部署指令全數完成
      debug:
        msg: "檢測到所有節點已上線 (Active)，並且插件啟用指令已發送。"
