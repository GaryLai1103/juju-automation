---
# ==========================================
# SKU: Infra-Test-MicroK8s-v0.1
# 目標：驗證 Juju 對接 MaaS 部署 MicroK8s 的能力
# ==========================================
- name: Infrastructure Test - Deploy MicroK8s via Juju
  hosts: maasjuju
  gather_facts: no
  vars:
    # 測試用的 Model 名稱，測試完可隨時刪除
    test_model: "infra-test"
    target_os: "ubuntu@22.04"
    # Channel: 使用 1.28 或 1.29 較為穩定，或者直接測 1.32
    k8s_channel: "1.32/stable"
    
    # 定義 MaaS Tags (請確認您的 MaaS 機器已有這些 Tag)
    master_tag: "virtual"    # 用於 Control Plane
    worker_tag: "slurm-node" # 用於 GPU Worker

  tasks:
    # 1. 環境清理與初始化
    - name: 1.1 確保測試 Model 是乾淨的 (若存在則忽略錯誤)
      shell: juju add-model {{ test_model }}
      ignore_errors: yes

    # 2. 請求機器 (Juju -> MaaS)
    - name: 2.1 請求 Control Plane 節點
      shell: |
        juju deploy microk8s k8s-master \
          --model {{ test_model }} \
          --channel {{ k8s_channel }} \
          --constraints "tags={{ master_tag }}" \
          --base {{ target_os }} \
          --config hostpath_storage=true \
          --config dns=true \
          --config rbac=true
      async: 600
      poll: 0

    - name: 2.2 請求 GPU Worker 節點
      shell: |
        juju deploy microk8s k8s-worker \
          --model {{ test_model }} \
          --channel {{ k8s_channel }} \
          --constraints "tags={{ worker_tag }}" \
          --base {{ target_os }} \
          --config hostpath_storage=true \
          --config dns=true \
          --config rbac=true
      async: 600
      poll: 0

    # 3. 建立關聯 (Clustering)
    - name: 3.1 建立 Master 與 Worker 的叢集關係
      shell: |
        # 這會觸發 MicroK8s 的 join 動作
        juju integrate k8s-master:microk8s k8s-worker:microk8s --model {{ test_model }}

    # 4. 啟用 GPU (關鍵測試點)
    - name: 4.1 等待 Juju 部署完成 (主動輪詢)
      shell: |
        # 簡單檢查是否所有 Unit 都進入 active 或 idle 狀態
        # 若還在 allocating 或 executing 則失敗重試
        juju status --model {{ test_model }} --format json | jq -r '.machines[]."agent-status".current' | grep -v "started" | wc -l
      register: status_check
      until: status_check.stdout == "0"
      retries: 60  # 等待 10 分鐘
      delay: 10
      ignore_errors: yes # 允許超時，讓我們手動檢查

    - name: 4.2 在 Worker 啟用 GPU Addon
      shell: |
        # 針對 Worker Unit 啟用 GPU
        # 注意：Juju unit 名稱通常是 application-name/0
        juju run k8s-worker/0 microk8s-enable addon=gpu --model {{ test_model }}
      ignore_errors: yes # 若硬體沒準備好可能會報錯，先忽略以便除錯

    - name: ✅ 測試部署請求已發送
      debug:
        msg: "Juju 指令已全部發送。請登入 maasjuju 透過 CLI 進行詳細驗收。"
