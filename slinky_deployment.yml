---
# ==========================================
# SKU: Slinky-MicroK8s-v3.1 (Syntax Fix)
# 目標：建立一個具備高度擴充性的生產級架構
# 修正：移除 Shell 模組內的中文註解與引號，避免 Jinja2 解析錯誤
# ==========================================
- name: Infrastructure Test - Scalable MicroK8s Deployment
  hosts: maasjuju
  gather_facts: no
  vars:
    test_model: "slinky-cluster"
    k8s_channel: "1.28/stable"
    constraint_master: "tags=virtual"
    constraint_worker: "tags=slurm-node"
    bundle_path: "/tmp/slinky-scalable-bundle.yaml"

  tasks:
    # -------------------------------------------------------
    # 1. 環境清理
    # -------------------------------------------------------
    - name: 1.0 強制清理舊的測試模型
      command: "juju destroy-model {{ test_model }} --no-prompt --force --destroy-storage"
      register: destroy_result
      failed_when: 
        - destroy_result.rc != 0 
        - '"not found" not in destroy_result.stderr'
      ignore_errors: yes

    - name: 1.1 等待模型釋放
      pause:
        seconds: 15

    - name: 1.2 建立全新 Juju Model
      shell: juju add-model {{ test_model }}

    # -------------------------------------------------------
    # 2. 定義可擴充架構 (Bundle)
    # -------------------------------------------------------
    - name: 2.1 產生 Scalable Bundle YAML 文件
      copy:
        dest: "{{ bundle_path }}"
        content: |
          description: Slinky Scalable Cluster
          series: jammy
          applications:
            k8s-master:
              charm: microk8s
              channel: {{ k8s_channel }}
              num_units: 1
              constraints: {{ constraint_master }}
              options:
                hostpath_storage: "true"
                dns: "true"
                rbac: "true"
            k8s-worker:
              charm: microk8s
              channel: {{ k8s_channel }}
              num_units: 1
              constraints: {{ constraint_worker }}
              options:
                hostpath_storage: "true"
                dns: "true"
                rbac: "true"
          relations:
            - ["k8s-master:microk8s", "k8s-worker:microk8s"]

    # -------------------------------------------------------
    # 3. 執行部署 (Fire and Forget)
    # -------------------------------------------------------
    - name: 3.1 部署 Scalable Bundle
      shell: |
        juju deploy {{ bundle_path }} --model {{ test_model }}

    # -------------------------------------------------------
    # 4. 部署後驗收 (等待 MaaS 安裝 OS)
    # -------------------------------------------------------
    - name: 4.1 等待 Master 與 Worker 就緒
      shell: |
        juju status --model {{ test_model }} --format json | jq -r '.machines[]."agent-status".current' | grep -E "started" | wc -l
      register: machine_ready
      until: machine_ready.stdout | int >= 2
      retries: 240  # 40 分鐘
      delay: 10
      ignore_errors: yes 

    # -------------------------------------------------------
    # 5. 針對 Worker 群組啟用 GPU
    # -------------------------------------------------------
    - name: 5.1 在 Worker 群組啟用 GPU
      shell: |
        juju run k8s-worker/0 enable addon=gpu --model {{ test_model }}
      ignore_errors: yes

    - name: ✅ 架構部署完成
      debug:
        msg: "可擴充架構 (Bundle) 部署請求已完成。請持續監控 Juju Status 直到 OS 安裝完畢。"
