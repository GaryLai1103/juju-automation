---
# ==========================================
# SKU: Slinky-CharmedK8s-v1.1 (File Generation Fix)
# 目標：部署正規 Charmed Kubernetes (Master/Worker 分離)
# 修正：
#   1. 加入 "產生 Bundle 檔案" 的步驟
#   2. 確保 Juju 能讀取到本地定義的機器分配 (VM vs GPU)
# ==========================================
- name: Infrastructure Test - Deploy Charmed Kubernetes
  hosts: maasjuju
  gather_facts: no
  vars:
    test_model: "slinky-k8s"
    k8s_channel: "1.28/stable"
    bundle_path: "/tmp/charmed-k8s-bundle.yaml"

  tasks:
    # -------------------------------------------------------
    # 1. 環境清理
    # -------------------------------------------------------
    - name: 1.0 強制清理舊模型
      command: "juju destroy-model {{ test_model }} --no-prompt --force --destroy-storage"
      register: destroy_result
      failed_when: 
        - destroy_result.rc != 0 
        - '"not found" not in destroy_result.stderr'
      ignore_errors: yes

    - name: 1.1 等待模型釋放
      pause:
        seconds: 15

    - name: 1.2 建立全新 Juju Model
      shell: juju add-model {{ test_model }}

    # -------------------------------------------------------
    # 2. 製作藍圖 (這就是您缺少的步驟！)
    # -------------------------------------------------------
    - name: 2.1 產生本地 Bundle 檔案
      copy:
        dest: "{{ bundle_path }}"
        content: |
          description: Slinky Standard K8s Cluster
          series: jammy
          
          machines:
            "0":
              constraints: tags=virtual
            "1":
              constraints: tags=slurm-node

          applications:
            easyrsa:
              charm: easyrsa
              num_units: 1
              to: ["0"]
            
            etcd:
              charm: etcd
              num_units: 1
              to: ["0"]
              options:
                channel: 3.4/stable

            kubernetes-control-plane:
              charm: kubernetes-control-plane
              channel: {{ k8s_channel }}
              num_units: 1
              to: ["0"]
              options:
                allow-privileged: "true"

            kubernetes-worker:
              charm: kubernetes-worker
              channel: {{ k8s_channel }}
              num_units: 1
              to: ["1"]
              expose: true

            calico:
              charm: calico
              
            containerd:
              charm: containerd

          relations:
            - ["kubernetes-control-plane:kube-control", "kubernetes-worker:kube-control"]
            - ["kubernetes-control-plane:certificates", "easyrsa:client"]
            - ["etcd:certificates", "easyrsa:client"]
            - ["kubernetes-control-plane:etcd", "etcd:db"]
            - ["kubernetes-worker:certificates", "easyrsa:client"]
            - ["calico:etcd", "etcd:db"]
            - ["calico:cni", "kubernetes-control-plane:cni"]
            - ["calico:cni", "kubernetes-worker:cni"]
            - ["containerd:containerd", "kubernetes-worker:container-runtime"]
            - ["containerd:containerd", "kubernetes-control-plane:container-runtime"]

    # -------------------------------------------------------
    # 3. 執行部署
    # -------------------------------------------------------
    - name: 3.1 部署 Bundle (現在檔案存在了，不會報錯)
      shell: |
        juju deploy {{ bundle_path }} --model {{ test_model }} --trust

    # -------------------------------------------------------
    # 4. 監控進度
    # -------------------------------------------------------
    - name: 4.1 等待部署完成 (Smart Wait)
      shell: |
        # 檢查 Worker 是否已經 active
        juju status --model {{ test_model }} --format json | jq -r '
          .applications["kubernetes-worker"]["application-status"].current == "active"
        '
      register: k8s_ready
      until: k8s_ready.stdout | trim == "true"
      # 正規 K8s 安裝比較久，給它 45 分鐘
      retries: 270 
      delay: 10
      ignore_errors: no

    - name: ✅ 部署完成
      debug:
        msg: "正規 Charmed Kubernetes 部署完成！Master 在 VM，Worker 在 GPU 裸機，且已自動連線。"
