---
# ==========================================
# SKU: Slinky-K8s-v1.5-Final-APT
# ä¿®æ­£ï¼š
#   1. å°‡ etcd channel æ”¹ç‚º latest/stable
#   2. æ”¹ç”¨ APT å®‰è£ Python ä¾è³´åº« (é¿é–‹ pip error)
#   3. ç§»é™¤é‡è¤‡çš„ Task å€å¡Š
# ==========================================
- name: Infrastructure Test - Deploy Modern Charmed Kubernetes
  hosts: maasjuju
  gather_facts: yes
  vars:
    test_model: "slinky-cluster"
    k8s_channel: "1.31/stable"
    bundle_path: "{{ ansible_user_dir }}/charmed-k8s-modern.yaml"

  tasks:
    # 1. ç’°å¢ƒæ¸…ç†
    - name: 1.0 å¼·åˆ¶æ¸…ç†èˆŠæ¨¡å‹
      command: "juju destroy-model {{ test_model }} --no-prompt --force --destroy-storage"
      register: destroy_result
      failed_when: 
        - destroy_result.rc != 0 
        - '"not found" not in destroy_result.stderr'
      ignore_errors: yes

    - name: 1.1 ç­‰å¾…æ¨¡å‹é‡‹æ”¾
      pause:
        seconds: 15

    - name: 1.2 å»ºç«‹å…¨æ–° Juju Model
      shell: juju add-model {{ test_model }}

    # 2. è£½ä½œè—åœ–
    - name: 2.0 æ¸…é™¤èˆŠçš„ Bundle æª”æ¡ˆ (é¿å…æ¬Šé™è¡çª)
      become: yes
      file:
        path: "{{ bundle_path }}"
        state: absent
        
    - name: 2.1 ç”¢ç”Ÿæœ¬åœ° Bundle æª”æ¡ˆ
      copy:
        dest: "{{ bundle_path }}"
        mode: '0644'
        content: |
          description: Slinky Modern K8s Cluster
          base: ubuntu@22.04
          
          machines:
            "0":
              constraints: tags=virtual
            "1":
              constraints: tags=slurm-node

          applications:
            easyrsa:
              charm: easyrsa
              channel: latest/stable
              num_units: 1
              to: ["0"]
            
            etcd:
              charm: etcd
              channel: latest/stable
              num_units: 1
              to: ["0"]

            kubernetes-control-plane:
              charm: kubernetes-control-plane
              channel: {{ k8s_channel }}
              num_units: 1
              to: ["0"]
              options:
                allow-privileged: "true"

            kubernetes-worker:
              charm: kubernetes-worker
              channel: {{ k8s_channel }}
              num_units: 1
              to: ["1"]
              expose: true

            calico:
              charm: calico
              channel: latest/stable
              
            containerd:
              charm: containerd
              channel: latest/stable

          relations:
            - ["kubernetes-control-plane:kube-control", "kubernetes-worker:kube-control"]
            - ["kubernetes-control-plane:certificates", "easyrsa:client"]
            - ["etcd:certificates", "easyrsa:client"]
            - ["kubernetes-control-plane:etcd", "etcd:db"]
            - ["kubernetes-worker:certificates", "easyrsa:client"]
            - ["calico:etcd", "etcd:db"]
            - ["calico:cni", "kubernetes-control-plane:cni"]
            - ["calico:cni", "kubernetes-worker:cni"]
            - ["containerd:containerd", "kubernetes-worker:container-runtime"]
            - ["containerd:containerd", "kubernetes-control-plane:container-runtime"]

    # 3. åŸ·è¡Œéƒ¨ç½²
    - name: 3.1 éƒ¨ç½² Bundle
      shell: |
        juju deploy {{ bundle_path }} --model {{ test_model }} --trust
      register: deploy_out
      until: deploy_out.rc == 0
      retries: 3
      delay: 10

    # -----------------------------------------------------------
    # 4. ç›£æ§èˆ‡é©—æ”¶ (ç„¡é™ç­‰å¾…ç‰ˆ)
    # -----------------------------------------------------------
    - name: 4.1 ç­‰å¾… K8s ç‹€æ…‹è®Šç‚º Active (ç›´åˆ°æˆåŠŸç‚ºæ­¢)
      shell: |
        echo "â³ é€²å…¥ç„¡é™ç›£æ¸¬æ¨¡å¼... (è«‹æ‰‹å‹•ç›£æ§ juju status)"
        
        while true; do
          # 1. ç²å– Worker ç‹€æ…‹
          STATUS=$(juju status --model {{ test_model }} --format json | jq -r '.applications["kubernetes-worker"]["application-status"].current')
          
          # 2. ç²å– Control Plane ç‹€æ…‹
          CP_STATUS=$(juju status --model {{ test_model }} --format json | jq -r '.applications["kubernetes-control-plane"]["application-status"].current')

          # 3. æˆåŠŸåˆ¤æ–·ï¼šå…©è€…çš†ç‚º active æ‰é›¢é–‹
          if [ "$STATUS" == "active" ] && [ "$CP_STATUS" == "active" ]; then
            echo "âœ… Kubernetes Cluster is Ready! (Worker: $STATUS, Control-Plane: $CP_STATUS)"
            exit 0
          fi
          
          # 4. ä¼‘æ¯ 10 ç§’å†å•
          sleep 10
        done
      args:
        executable: /bin/bash
      register: k8s_wait_result
      changed_when: false 

    # -----------------------------------------------------------
    # è£œæ•‘æªæ–½ï¼šè§£æ±º "kubernetes module" ä¾è³´å•é¡Œ (æ”¹ç”¨ APT)
    # -----------------------------------------------------------
    
    # ğŸŸ¢ [ä¿®æ”¹] æ”¹ç”¨ APT å®‰è£ Ansible K8s æ¨¡çµ„æ‰€éœ€çš„ä¾è³´
    # é€™æ¯” pip æ›´ç©©å®šï¼Œä¸”ä¸æœƒæœ‰ PEP 668 éŒ¯èª¤
    - name: 4.2 å®‰è£ç³»çµ±ç´š K8s Python ä¾è³´åº« (APTæ¨¡å¼)
      become: yes
      ansible.builtin.apt:
        name: 
          - python3-kubernetes  # å°æ‡‰ pip çš„ kubernetes
          - python3-yaml        # å°æ‡‰ pip çš„ PyYAML
          - python3-pip         # é †ä¾¿è£ä¸Š pip ä»¥å‚™ä¸æ™‚ä¹‹éœ€
        state: present
        update_cache: yes
      register: apt_result
      until: apt_result is success
      retries: 3
      delay: 5

    # -----------------------------------------------------------
    # 5. Local Path Provisioner
    # -----------------------------------------------------------
    - name: 5.1 å®‰è£ Local Path Provisioner
      kubernetes.core.k8s:
        state: present
        src: https://raw.githubusercontent.com/rancher/local-path-provisioner/v0.0.30/deploy/local-path-storage.yaml
      environment:
        KUBECONFIG: "/home/gary/.kube/config"

    - name: 5.2 è¨­å®šç‚ºé è¨­ StorageClass
      shell: |
        kubectl patch storageclass local-path -p '{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"true"}}}'

    - name: âœ… éƒ¨ç½²å®Œæˆ
      debug:
        msg: "Charmed Kubernetes å·²æˆåŠŸéƒ¨ç½²ï¼Œä¸¦ä½¿ç”¨ APT å®Œæˆ Python ä¾è³´å®‰è£ã€‚"
