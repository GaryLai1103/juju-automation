---
# ==========================================
# SKU: Slinky-MicroK8s-v4.0 (Pure CLI)
# 目標：不使用 YAML 文件，純粹透過 Juju Charm 指令部署
# 架構：
#   1. k8s-master (App): 綁定 tags=virtual
#   2. k8s-worker (App): 綁定 tags=slurm-node
#   3. 自動 Integrate
# ==========================================
- name: Infrastructure Test - Scalable MicroK8s Deployment (CLI)
  hosts: maasjuju
  gather_facts: no
  vars:
    test_model: "slinky-cluster"
    k8s_channel: "1.28/stable"
    # 定義約束條件
    constraint_master: "tags=virtual"
    constraint_worker: "tags=slurm-node"

  tasks:
    # -------------------------------------------------------
    # 1. 環境清理
    # -------------------------------------------------------
    - name: 1.0 強制清理舊的測試模型
      command: "juju destroy-model {{ test_model }} --no-prompt --force --destroy-storage"
      register: destroy_result
      failed_when: 
        - destroy_result.rc != 0 
        - '"not found" not in destroy_result.stderr'
      ignore_errors: yes

    - name: 1.1 等待模型釋放
      pause:
        seconds: 15

    - name: 1.2 建立全新 Juju Model
      shell: juju add-model {{ test_model }}

    # -------------------------------------------------------
    # 2. 部署控制平面 (Master)
    # 說明：直接在 deploy 指令中帶入 config 和 constraints
    # -------------------------------------------------------
    - name: 2.1 部署 k8s-master (VM)
      shell: |
        juju deploy microk8s k8s-master \
          --model {{ test_model }} \
          --channel {{ k8s_channel }} \
          --constraints "{{ constraint_master }}" \
          --config hostpath_storage=true \
          --config dns=true \
          --config rbac=true

    # -------------------------------------------------------
    # 3. 部署運算平面 (Worker)
    # 說明：這是未來擴充的基礎，新增節點也會使用這個 App 名稱
    # -------------------------------------------------------
    - name: 3.1 部署 k8s-worker (GPU Bare Metal)
      shell: |
        juju deploy microk8s k8s-worker \
          --model {{ test_model }} \
          --channel {{ k8s_channel }} \
          --constraints "{{ constraint_worker }}" \
          --config hostpath_storage=true \
          --config dns=true \
          --config rbac=true

    # -------------------------------------------------------
    # 4. 建立關聯 (Integrate)
    # 說明：這裡必須使用 Retry，因為 CLI 下指令很快，但 Charm 下載需要時間
    # -------------------------------------------------------
    - name: 4.1 連接 Master 與 Worker
      shell: |
        juju integrate k8s-master:microk8s k8s-worker:microk8s --model {{ test_model }}
      register: integrate_result
      until: integrate_result.rc == 0
      retries: 60       # 給予 10 分鐘讓 Charm Metadata 下載完成
      delay: 10
      ignore_errors: yes

    # -------------------------------------------------------
    # 5. 部署後驗收 (等待 OS 安裝)
    # -------------------------------------------------------
    - name: 5.1 等待 Master 與 Worker 就緒
      shell: |
        # 監控 agent-status 是否變為 started (active)
        juju status --model {{ test_model }} --format json | jq -r '.machines[]."agent-status".current' | grep -E "started" | wc -l
      register: machine_ready
      until: machine_ready.stdout | int >= 2
      retries: 240  # 40 分鐘 (裸機安裝時間)
      delay: 10
      ignore_errors: yes 

    # -------------------------------------------------------
    # 6. 功能啟用 (GPU)
    # -------------------------------------------------------
    - name: 6.1 在 Worker 群組啟用 GPU
      shell: |
        # 針對 k8s-worker 群組的第一個單元啟用
        juju run k8s-worker/0 enable addon=gpu --model {{ test_model }}
      ignore_errors: yes

    - name: ✅ 部署指令完成
      debug:
        msg: "CLI 部署已完成。Juju 正在背景處理 MaaS 機器申請與 OS 安裝。"
