---
# ==========================================
# SKU: Slinky-K8s-v1.5-Final
# 修正：
#   1. 將 etcd channel 改為 latest/stable 以符合 ubuntu@22.04
#   2. 保持 slinky-cluster 模型名稱與 1.31/stable 版本
# ==========================================
- name: Infrastructure Test - Deploy Modern Charmed Kubernetes
  hosts: maasjuju
  gather_facts: yes
  vars:
    test_model: "slinky-cluster"
    k8s_channel: "1.31/stable"
    bundle_path: "{{ ansible_user_dir }}/charmed-k8s-modern.yaml"

  tasks:
    # 1. 環境清理
    - name: 1.0 強制清理舊模型
      command: "juju destroy-model {{ test_model }} --no-prompt --force --destroy-storage"
      register: destroy_result
      failed_when: 
        - destroy_result.rc != 0 
        - '"not found" not in destroy_result.stderr'
      ignore_errors: yes

    - name: 1.1 等待模型釋放
      pause:
        seconds: 15

    - name: 1.2 建立全新 Juju Model
      shell: juju add-model {{ test_model }}

    # 2. 製作藍圖
    - name: 2.0 清除舊的 Bundle 檔案 (避免權限衝突)
      become: yes
      file:
        path: "{{ bundle_path }}"
        state: absent
    - name: 2.1 產生本地 Bundle 檔案
      copy:
        dest: "{{ bundle_path }}"
        mode: '0644'
        content: |
          description: Slinky Modern K8s Cluster
          base: ubuntu@22.04
          
          machines:
            "0":
              constraints: tags=virtual
            "1":
              constraints: tags=slurm-node

          applications:
            easyrsa:
              charm: easyrsa
              channel: latest/stable
              num_units: 1
              to: ["0"]
            
            etcd:
              charm: etcd
              # 修正：這裡改用 latest/stable，因為 3.4/stable 不支援 22.04 base
              channel: latest/stable
              num_units: 1
              to: ["0"]

            kubernetes-control-plane:
              charm: kubernetes-control-plane
              channel: {{ k8s_channel }}
              num_units: 1
              to: ["0"]
              options:
                allow-privileged: "true"

            kubernetes-worker:
              charm: kubernetes-worker
              channel: {{ k8s_channel }}
              num_units: 1
              to: ["1"]
              expose: true

            calico:
              charm: calico
              channel: latest/stable
              
            containerd:
              charm: containerd
              channel: latest/stable

          relations:
            - ["kubernetes-control-plane:kube-control", "kubernetes-worker:kube-control"]
            - ["kubernetes-control-plane:certificates", "easyrsa:client"]
            - ["etcd:certificates", "easyrsa:client"]
            - ["kubernetes-control-plane:etcd", "etcd:db"]
            - ["kubernetes-worker:certificates", "easyrsa:client"]
            - ["calico:etcd", "etcd:db"]
            - ["calico:cni", "kubernetes-control-plane:cni"]
            - ["calico:cni", "kubernetes-worker:cni"]
            - ["containerd:containerd", "kubernetes-worker:container-runtime"]
            - ["containerd:containerd", "kubernetes-control-plane:container-runtime"]

    # 3. 執行部署
    - name: 3.1 部署 Bundle
      shell: |
        juju deploy {{ bundle_path }} --model {{ test_model }} --trust
      register: deploy_out
      until: deploy_out.rc == 0
      retries: 3
      delay: 10

    # 4. 監控與驗收
    - name: 4.1 等待 K8s 狀態變為 Active (Clean Log)
      shell: |
        echo "⏳ 開始監測 Kubernetes 狀態..."
        START_TIME=$(date +%s)
        TIMEOUT=1200  # 設定超時時間 (秒)，例如 20 分鐘
        
        while true; do
          # 1. 獲取 Worker 狀態
          STATUS=$(juju status --model {{ test_model }} --format json | jq -r '.applications["kubernetes-worker"]["application-status"].current')
          
          # 2. 獲取 Control Plane 狀態 (選用，確保大腦也好了)
          CP_STATUS=$(juju status --model {{ test_model }} --format json | jq -r '.applications["kubernetes-control-plane"]["application-status"].current')

          # 3. 判斷是否兩者皆為 active
          if [ "$STATUS" == "active" ] && [ "$CP_STATUS" == "active" ]; then
            echo "✅ Kubernetes Cluster is Ready! (Worker: $STATUS, Control-Plane: $CP_STATUS)"
            exit 0
          fi

          # 4. 檢查超時
          CURRENT_TIME=$(date +%s)
          ELAPSED_TIME=$((CURRENT_TIME - START_TIME))
          if [ $ELAPSED_TIME -ge $TIMEOUT ]; then
            echo "❌ Timeout waiting for Kubernetes to become active."
            exit 1
          fi

          # 5. 等待並重試 (每 10 秒檢查一次，不洗版)
          # echo "   ... Current status: Worker=$STATUS, CP=$CP_STATUS (Elapsed: ${ELAPSED_TIME}s)" 
          sleep 10
        done
      args:
        executable: /bin/bash
      register: k8s_wait_result
      # 設定 changed_when: false 讓成功時顯示綠色 ok，而不是黃色 changed (看個人喜好)
      changed_when: false 
      # 這裡的 timeout 是 Ansible task 層級的保險，建議比腳本內的 TIMEOUT 稍長
      async: 1500
      poll: 10

    # 新增這一段：確保 maasjuju 本機有執行 k8s 模組所需的 Python 庫
    - name: 4.2 安裝 Ansible K8s 模組所需的 Python 依賴庫
      become: yes  # 需要 sudo 權限來安裝系統層級的 Python 庫
      ansible.builtin.pip:
        name: 
          - kubernetes
          - PyYAML
        state: present
        executable: pip3

    # 5. Local Path Provisioner
    - name: 5.1 安裝 Local Path Provisioner
      kubernetes.core.k8s:
        state: present
        src: https://raw.githubusercontent.com/rancher/local-path-provisioner/v0.0.30/deploy/local-path-storage.yaml
      environment:
        KUBECONFIG: "/home/gary/.kube/config"

    - name: 5.2 設定為預設 StorageClass
      shell: |
        kubectl patch storageclass local-path -p '{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"true"}}}'

    - name: ✅ 部署完成
      debug:
        msg: "Charmed Kubernetes 已成功開始部署。etcd 已修正為 latest/stable 以支援 Ubuntu 22.04。"
