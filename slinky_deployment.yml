# ==========================================
# SKU: Slinky-MicroK8s-v1.0
# é‚è¼¯ï¼šJuju Native ä½ˆç½² MicroK8sï¼Œç‚º Slinky é‹ªè·¯
# ==========================================
- name: 1. åŸºç¤å»ºè¨­èˆ‡ MicroK8s å¢é›†å»ºç«‹
  hosts: maasjuju
  gather_facts: no
  vars:
    # æ¨¡å‹åç¨±
    slinky_model: "slinky-lab"
    target_os: "ubuntu@22.04" # MicroK8s åœ¨ 22.04 æ”¯æ´åº¦æ¥µä½³
    # MaaS Tags (æ²¿ç”¨æ‚¨çš„å®šç¾©)
    master_tags: "tags=virtual"
    worker_tags: "tags=slurm-node"
    # Channel è¨­å®š (ä¾æ“š Slinky ç›¸å®¹æ€§é¸æ“‡)
    k8s_channel: "1.32/stable"

  tasks:
    # ----------------------------------------------------
    # 1.1 åˆå§‹åŒ– Juju Model
    # ----------------------------------------------------
    - name: 1.1 å»ºç«‹ Juju Model
      shell: |
        juju add-model {{ slinky_model }} || true
      changed_when: false

    # ----------------------------------------------------
    # 1.2 è«‹æ±‚æ©Ÿå™¨ (Request Machines from MaaS)
    # ----------------------------------------------------
    - name: 1.2 æ ¹æ“š Tag è«‹æ±‚è£¸æ©Ÿè³‡æº
      shell: |
        # è«‹æ±‚ Machine 0 (é è¨ˆä½œç‚º Control Plane)
        juju add-machine -m {{ slinky_model }} --constraints {{ master_tags }} --base {{ target_os }}
        # è«‹æ±‚ Machine 1 (é è¨ˆä½œç‚º GPU Worker)
        juju add-machine -m {{ slinky_model }} --constraints {{ worker_tags }} --base {{ target_os }}
      register: machine_req

    - name: 1.3 ç­‰å¾…æ©Ÿå™¨åˆ†é… ID èˆ‡å•Ÿå‹•
      shell: |
        # ç°¡å–®è¿´åœˆç­‰å¾…ï¼Œç›´åˆ°èƒ½è§£æå‡ºå…©å€‹ ID
        # å¯¦å‹™ä¸Šå»ºè­°ä½¿ç”¨ juju wait plugin æˆ–æ›´åš´è¬¹çš„æª¢æŸ¥
        sleep 10 
        echo "Waiting for machines..."
      changed_when: false

    - name: 1.4 å‹•æ…‹åµæ¸¬ Machine ID (æ²¿ç”¨æ‚¨çš„é«˜æ˜é‚è¼¯)
      shell: |
        STATUS=$(juju machines -m {{ slinky_model }} --format json)
        # æŠ“å– Virtual (Master) ID
        M0=$(echo $STATUS | jq -r '.machines | to_entries[] | select(.value.constraints | contains("tags={{ master_tags | replace("tags=", "") }}")) | .key' | head -n 1)
        # æŠ“å– Slurm-Node (Worker) ID
        M1=$(echo $STATUS | jq -r '.machines | to_entries[] | select(.value.constraints | contains("tags={{ worker_tags | replace("tags=", "") }}")) | .key' | head -n 1)
        
        if [ -z "$M0" ] || [ -z "$M1" ]; then exit 1; fi
        echo "$M0|$M1"
      register: detected_ids
      until: detected_ids.rc == 0
      retries: 20
      delay: 15

    - name: 1.5 å„²å­˜ ID è®Šæ•¸
      set_fact:
        master_id: "{{ detected_ids.stdout.split('|')[0] }}"
        worker_id: "{{ detected_ids.stdout.split('|')[1] }}"

    # ----------------------------------------------------
    # 2. ä½ˆç½² MicroK8s Charm (æ ¸å¿ƒå·®ç•°è™•)
    # èªªæ˜ï¼šæˆ‘å€‘ä¸ä½¿ç”¨ shell curlï¼Œè€Œæ˜¯ä½¿ç”¨ Charm é€²è¡ŒåŸç”Ÿç®¡ç†
    # ----------------------------------------------------
    - name: 2.1 ä½ˆç½² MicroK8s Control Plane (Master)
      shell: |
        # ä½ˆç½²åç‚º 'k8s-master' çš„æ‡‰ç”¨åˆ° master_id
        juju deploy microk8s k8s-master \
          --channel {{ k8s_channel }} \
          --to {{ master_id }} \
          --config hostpath_storage=true \
          --config rbac=true \
          --config dns=true \
          -m {{ slinky_model }}

    - name: 2.2 ä½ˆç½² MicroK8s Worker (GPU Node)
      shell: |
        # ä½ˆç½²åç‚º 'k8s-worker' çš„æ‡‰ç”¨åˆ° worker_id
        juju deploy microk8s k8s-worker \
          --channel {{ k8s_channel }} \
          --to {{ worker_id }} \
          --config hostpath_storage=true \
          --config rbac=true \
          --config dns=true \
          -m {{ slinky_model }}

    # ----------------------------------------------------
    # 3. å¢é›†æ•´åˆ (Clustering)
    # ----------------------------------------------------
    - name: 3.1 ç­‰å¾…æ‡‰ç”¨ä½ˆç½²å®Œæˆ (é˜»å¡å¼æª¢æŸ¥)
      shell: |
        # é€™æ˜¯ä¸€å€‹ç°¡åŒ–çš„ç­‰å¾…é‚è¼¯ï¼Œç¢ºä¿ Charm å·²ç¶“ Active
        juju-wait -m {{ slinky_model }} -t 600 || true
      ignore_errors: yes

    - name: 3.2 å»ºç«‹ Master-Worker é—œè¯ (å½¢æˆå¢é›†)
      shell: |
        # MicroK8s Charm é€é relation è‡ªå‹• join cluster
        juju integrate k8s-master:microk8s k8s-worker:microk8s -m {{ slinky_model }}

    - name: 3.3 ç­‰å¾…å¢é›†é—œè¯ç”Ÿæ•ˆ
      shell: sleep 30

    # ----------------------------------------------------
    # 4. Slinky å°ˆå±¬é…ç½® (GPU & Labeling)
    # ----------------------------------------------------
    - name: 4.1 åœ¨ Worker ç¯€é»å•Ÿç”¨ GPU (Juju Action)
      shell: |
        # é€™ä¸€æ­¥å–ä»£äº†åŸæœ¬è¤‡é›œçš„ Shell æ‰‹å‹•å®‰è£é©…å‹•
        # MicroK8s Charm æœƒè‡ªå‹•åµæ¸¬ç¡¬é«”ä¸¦å•Ÿç”¨ NVIDIA Operator
        juju run k8s-worker/0 microk8s-enable addon=gpu -m {{ slinky_model }}

    - name: 4.2 ä¸‹è¼‰ Kubeconfig (ä¾› KubeSphere ç´ç®¡ä½¿ç”¨)
      shell: |
        # å¾ Master æŠ“å– config
        mkdir -p /tmp/slinky_configs
        juju run k8s-master/0 microk8s-config > /tmp/slinky_configs/config
        
        # ä¿®æ­£ IP (Charm é€šå¸¸æœƒçµ¦å‡ºæ­£ç¢º IPï¼Œä½†ä¿éšªèµ·è¦‹ä¿®æ­£ç‚ºå°å¤– IP)
        MASTER_IP=$(juju ssh -m {{ slinky_model }} {{ master_id }} 'hostname -I' | awk '{print $1}')
        sed -i "s/127.0.0.1/$MASTER_IP/g" /tmp/slinky_configs/config
      vars:
        slinky_model: "slinky-lab"

    - name: ğŸš€ Slinky åŸºç¤å»ºè¨­å®Œæˆ
      debug:
        msg: 
          - "MicroK8s Cluster å·²é€é Juju å»ºç«‹å®Œæˆã€‚"
          - "Master (ID: {{ master_id }}) èˆ‡ Worker (ID: {{ worker_id }}) å·²æ•´åˆã€‚"
          - "GPU Addon å·²åœ¨ Worker ç¯€é»å•Ÿç”¨ã€‚"
          - "ä¸‹ä¸€æ­¥ï¼šè«‹å°‡ /tmp/slinky_configs/config åŒ¯å…¥ KubeSphereï¼Œä¸¦é–‹å§‹ä½ˆç½² Slinky Operatorã€‚"
