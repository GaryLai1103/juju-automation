---
# ========================================================
# SKU: Slinky-App-Standalone-v1.1-GitClone
# ä¿®æ­£ï¼šè§£æ±º SchedMD Helm Repo 404 å•é¡Œï¼Œæ”¹ç”¨ Git Clone å®‰è£
# ========================================================
- name: Application Layer - Deploy Slinky (Slurm)
  hosts: maasjuju
  gather_facts: yes
  vars:
    test_model: "slinky-cluster"
    release_name: "slinky"
    namespace: "slurm-cluster"
    # æŒ‡å®š GitHub å°ˆæ¡ˆç¶²å€
    git_repo_url: "https://github.com/schedmd/slurm-helm-charts.git"

  tasks:
    # -----------------------------------------------------------
    # 1. æª¢æŸ¥ç’°å¢ƒ
    # -----------------------------------------------------------
    - name: 1.1 ç¢ºèª Machine 0 æ˜¯å¦å­˜æ´»
      shell: juju ssh --model {{ test_model }} 0 -- "echo 'alive'"
      register: machine_check
      ignore_errors: yes

    - name: 1.2 çµ‚æ­¢æª¢æŸ¥
      fail:
        msg: "âŒ æ‰¾ä¸åˆ° Machine 0ï¼è«‹å…ˆåŸ·è¡Œ Infrastructure Playbookã€‚"
      when: machine_check.rc != 0

    # -----------------------------------------------------------
    # 2. æº–å‚™éƒ¨ç½²å·¥å…· (Helm + Git)
    # -----------------------------------------------------------
    - name: 2.1 åœ¨ Machine 0 å®‰è£ Helm èˆ‡ Git (Remote Exec)
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "sudo snap install helm --classic && sudo apt-get update && sudo apt-get install -y git"
      register: tools_install
      changed_when: "'installed' in tools_install.stdout"

    - name: 2.2 [ä¿®æ­£] ä¸‹è¼‰ Slurm Chart åŸå§‹ç¢¼ (Git Clone)
      # ä¸ç”¨ repo addï¼Œç›´æ¥æŠŠåŸå§‹ç¢¼æŠ“ä¸‹ä¾†ï¼Œä¿è­‰æœ€ç©©
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "rm -rf slurm-helm-charts && git clone {{ git_repo_url }}"
      changed_when: true

    - name: 2.3 [æ–°å¢] ä¸‹è¼‰ Chart ä¾è³´å¥—ä»¶ (MariaDB)
      # é€™æ˜¯é—œéµï¼å› ç‚ºæ˜¯åŸå§‹ç¢¼å®‰è£ï¼Œå¿…é ˆæ‰‹å‹•è§¸ç™¼ä¾è³´ä¸‹è¼‰
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "cd slurm-helm-charts/charts/slurm-cluster && helm dependency update"
      changed_when: true

    # -----------------------------------------------------------
    # 3. è¨­å®šæª”é…ç½® (ConfigMap & Database)
    # -----------------------------------------------------------
    - name: 3.1 ç”¢ç”Ÿ Slinky è¨­å®šæª” (values.yaml)
      shell: |
        juju ssh --model {{ test_model }} 0 -- "cat <<EOF > /home/ubuntu/slinky-values.yaml
        global:
          clusterName: {{ test_model }}

        # [å„²å­˜] ä½¿ç”¨ Local Path
        volumeClaimTemplate:
          accessModes: [ \"ReadWriteOnce\" ]
          storageClassName: \"local-path\"
          resources:
            requests:
              storage: 10Gi

        # [æ§åˆ¶å™¨]
        slurmctld:
          persistence:
            enabled: true
            storageClassName: \"local-path\"
            size: 10Gi
          resources:
            limits:
              cpu: 2
              memory: 4Gi

        # [è³‡æ–™åº«] è‡ªå‹•å•Ÿç”¨
        slurmdbd:
          enabled: true
          persistence:
            enabled: true
            storageClassName: \"local-path\"
            size: 10Gi
          resources:
            limits:
              cpu: 2
              memory: 4Gi

        # [å…¥å£] NodePort 30022
        login:
          enabled: true
          service:
            type: NodePort
            nodePort: 30022
          ssh:
            enabled: true
          persistence:
            enabled: true
            storageClassName: \"local-path\"
            size: 10Gi

        # [é‹ç®—ç¯€é»]
        slurmd:
          resources:
            requests:
              cpu: 1
              memory: 2Gi
            limits: 
              cpu: 16  
              memory: 64Gi
          persistence:
            enabled: true
            storageClassName: \"local-path\"
            size: 50Gi
        EOF"
      changed_when: false

    # -----------------------------------------------------------
    # 4. åŸ·è¡Œéƒ¨ç½²
    # -----------------------------------------------------------
    - name: 4.1 å®‰è£/æ›´æ–° Slurm (Install from Local Path)
      # [ä¿®æ­£] é€™è£¡æŒ‡å‘æœ¬æ©Ÿç›®éŒ„ ./slurm-helm-charts/charts/slurm-cluster
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "helm upgrade --install {{ release_name }} ./slurm-helm-charts/charts/slurm-cluster \
          --namespace {{ namespace }} \
          --create-namespace \
          -f /home/ubuntu/slinky-values.yaml \
          --wait --timeout 15m"
      register: helm_deploy
      changed_when: "'Release \"{{ release_name }}\" does not exist' in helm_deploy.stderr or 'Happy Helming' in helm_deploy.stdout"

    # -----------------------------------------------------------
    # 5. è³‡è¨Šé¡¯ç¤º
    # -----------------------------------------------------------
    - name: 5.1 ç²å– Machine 0 IP
      shell: |
        juju status --model {{ test_model }} --format json | jq -r '.machines["0"]["dns-name"]'
      register: master_ip

    - name: âœ… Slinky éƒ¨ç½²å®Œæˆ
      debug:
        msg: 
          - "ğŸ‰ Slurm on K8s (SchedMD) éƒ¨ç½²æˆåŠŸï¼"
          - "è³‡æ–™åº« (MariaDB) èˆ‡ Slurmdbd å·²è‡ªå‹•å»ºç«‹ã€‚"
          - "è«‹å˜—è©¦ SSH é€£ç·šç™»å…¥ç¯€é»ï¼š"
          - "ssh root@{{ master_ip.stdout }} -p 30022"
