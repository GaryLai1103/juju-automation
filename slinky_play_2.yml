---
# ========================================================
# SKU: Slinky-App-Standalone-v4.6-LabelSpoofing
# ä¿®æ­£ï¼š
#   1. [Conflict] æ‰‹å‹•å»ºç«‹ PVC æ™‚ï¼ŒåŠ ä¸Š Helm çš„ Metadata (Labels/Annotations)
#   2. [Adoption] æ¬ºé¨™ Helm è®“å®ƒ "èªé¤Š" é€™å€‹ç¾æœ‰çš„ PVC
#   3. [Storage] ç¢ºä¿ StorageClass æ­£ç¢ºç¶å®šåˆ°éœæ…‹ PV
# ========================================================
- name: Application Layer - Deploy Slurm (Trojan Horse PVC)
  hosts: maasjuju
  gather_facts: yes
  vars:
    test_model: "slinky-cluster"
    release_name: "slinky"
    namespace: "slurm-cluster"
    slurm_git_url: "https://github.com/stackhpc/slurm-k8s-cluster.git"
    nfs_path: "/srv/nfs/kubedata"
    nfs_server_ip: "192.168.1.96"

  tasks:
    # -----------------------------------------------------------
    # 1. å¾¹åº•æ¸…ç†è¡çªç¾å ´
    # -----------------------------------------------------------
    - name: 1.1 ç§»é™¤ Helm Release
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "helm uninstall {{ release_name }} -n {{ namespace }} --wait=false 2>/dev/null || true"
      changed_when: true

    - name: 1.2 åˆªé™¤èˆŠçš„ PVC (å¿…é ˆåˆªé™¤æ‰èƒ½é‡å»ºå¸¶æ¨™ç±¤çš„)
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "kubectl delete pvc slurm-shared-storage -n {{ namespace }} --wait=false 2>/dev/null || true"
      changed_when: true

    # -----------------------------------------------------------
    # 2. å»ºç«‹ PV (ç¶­æŒä¸è®Š)
    # -----------------------------------------------------------
    - name: 2.1 å»ºç«‹ PV (Base64)
      vars:
        pv_yaml_content: |
          apiVersion: v1
          kind: PersistentVolume
          metadata:
            name: slurm-nfs-pv
            labels:
              type: nfs-static
          spec:
            capacity:
              storage: 20Gi
            accessModes:
              - ReadWriteMany
            persistentVolumeReclaimPolicy: Retain
            storageClassName: ""
            nfs:
              path: {{ nfs_path }}
              server: {{ nfs_server_ip }}
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "echo '{{ pv_yaml_content | b64encode }}' | base64 -d > /home/ubuntu/slurm-pv.yaml && \
         kubectl delete pv slurm-nfs-pv --wait=false 2>/dev/null || true && \
         kubectl apply -f /home/ubuntu/slurm-pv.yaml"
      changed_when: true

    # -----------------------------------------------------------
    # 3. å»ºç«‹ "å½è£" PVC (é—œéµæ­¥é©Ÿï¼)
    # -----------------------------------------------------------
    - name: 3.1 å»ºç«‹å¸¶æœ‰ Helm æ¨™ç±¤çš„ PVC
      # é€™è£¡æˆ‘å€‘åŠ ä¸Šäº† labels å’Œ annotations
      # Helm çœ‹åˆ°é€™äº›å°±æœƒèªç‚ºé€™å€‹è³‡æºæ˜¯å®ƒç®¡ç†çš„ï¼Œå¾è€Œåœæ­¢å ±éŒ¯ä¸¦ç›´æ¥ä½¿ç”¨
      vars:
        pvc_yaml_content: |
          apiVersion: v1
          kind: PersistentVolumeClaim
          metadata:
            name: slurm-shared-storage
            namespace: {{ namespace }}
            labels:
              app.kubernetes.io/managed-by: Helm
            annotations:
              meta.helm.sh/release-name: {{ release_name }}
              meta.helm.sh/release-namespace: {{ namespace }}
          spec:
            accessModes:
              - ReadWriteMany
            resources:
              requests:
                storage: 20Gi
            volumeName: slurm-nfs-pv
            storageClassName: ""
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "kubectl create ns {{ namespace }} 2>/dev/null || true && \
         echo '{{ pvc_yaml_content | b64encode }}' | base64 -d > /home/ubuntu/slurm-pvc.yaml && \
         kubectl apply -f /home/ubuntu/slurm-pvc.yaml"
      changed_when: true

    # -----------------------------------------------------------
    # 4. éƒ¨ç½² Slurm
    # -----------------------------------------------------------
    - name: 4.1 ç”¢ç”Ÿ Values (é…åˆå½è£)
      # é›–ç„¶æˆ‘å€‘æ‰‹å‹•å»ºäº† PVCï¼Œä½†ç‚ºäº†é…åˆ Chart é‚è¼¯ï¼Œ
      # æˆ‘å€‘é‚„æ˜¯æŠŠ storageClassName è¨­ç‚ºç©ºï¼Œä¸¦å†æ¬¡å¼·èª¿ç¦ç”¨ rook
      vars:
        values_content: |
          global:
            clusterName: {{ test_model }}
          
          # ä¾ç„¶ç¦ç”¨ Rook
          rook-nfs:
            enabled: false
          
          volumeClaim:
            create: true  # é€™è£¡è¨­ç‚º true ä¹Ÿæ²’é—œä¿‚äº†ï¼Œå› ç‚º Helm æœƒç™¼ç¾ PVC å·²å­˜åœ¨ä¸”æœ‰æ¨™ç±¤
            name: slurm-shared-storage
            storageClassName: ""
            volumeName: slurm-nfs-pv
            accessModes:
              - ReadWriteMany
            size: 20Gi
            
          controller:
            size: 10Gi
            storageClassName: "local-path"
            resources:
              limits:
                cpu: 2
                memory: 4Gi
          slurmdbd:
            enabled: true
            storageClassName: "local-path"
            size: 10Gi
          login:
            service:
              type: NodePort
              nodePort: 30022
            ssh:
              enabled: true
          worker:
            replicas: 1
            resources:
              limits:
                cpu: 8
                memory: 16Gi
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "echo '{{ values_content | b64encode }}' | base64 -d > /home/ubuntu/slurm-static-values.yaml"
      changed_when: false

    - name: 4.2 éƒ¨ç½² Slurm
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "helm upgrade --install {{ release_name }} ./slurm-k8s-cluster/slurm-cluster-chart \
          --namespace {{ namespace }} \
          --create-namespace \
          -f /home/ubuntu/slurm-static-values.yaml \
          --wait --timeout 15m"
      register: helm_deploy

    - name: âœ… å®Œæˆ
      debug:
        msg: 
          - "ğŸ‰ V4.6 (æ¨™ç±¤å½è£ç‰ˆ) éƒ¨ç½²æˆåŠŸï¼"
          - "PVC å·²å½é€  Helm æ¨™ç±¤ï¼ŒæˆåŠŸé¨™é Helm é€²è¡Œèªé¤Šã€‚"
          - "StorageClass éŒ¯èª¤æ‡‰å·²è§£æ±ºã€‚"
          - "è«‹æª¢æŸ¥: kubectl get pvc -n slurm-cluster"
