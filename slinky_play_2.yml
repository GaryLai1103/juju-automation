---
# ========================================================
# SKU: Slinky-App-Standalone-v2.0-StackHPC
# ç­–ç•¥ï¼š
#   1. æ”¾æ£„ SchedMD (é€£çµå¤±æ•ˆ)ï¼Œæ”¹ç”¨ StackHPC (ç¤¾ç¾¤ä¸»æµ)
#   2. ä½¿ç”¨ Git Clone (StackHPC æ”¯æ´ master åˆ†æ”¯)
#   3. èª¿æ•´ Values ä»¥ç¬¦åˆ StackHPC Chart æ ¼å¼
# ========================================================
- name: Application Layer - Deploy Slurm (StackHPC)
  hosts: maasjuju
  gather_facts: yes
  vars:
    test_model: "slinky-cluster"
    release_name: "slinky"
    namespace: "slurm-cluster"
    # [æ–°ç›®æ¨™] StackHPC çš„ Repo
    git_repo_url: "https://github.com/stackhpc/slurm-k8s-cluster.git"

  tasks:
    # -----------------------------------------------------------
    # 1. æª¢æŸ¥ç’°å¢ƒ
    # -----------------------------------------------------------
    - name: 1.1 ç¢ºèª Machine 0 æ˜¯å¦å­˜æ´»
      shell: juju ssh --model {{ test_model }} 0 -- "echo 'alive'"
      register: machine_check
      ignore_errors: yes

    - name: 1.2 çµ‚æ­¢æª¢æŸ¥
      fail:
        msg: "âŒ æ‰¾ä¸åˆ° Machine 0ï¼è«‹å…ˆåŸ·è¡Œ Infrastructure Playbookã€‚"
      when: machine_check.rc != 0

    # -----------------------------------------------------------
    # 2. æº–å‚™éƒ¨ç½²å·¥å…·
    # -----------------------------------------------------------
    - name: 2.1 åœ¨ Machine 0 å®‰è£ Helm èˆ‡å·¥å…· (Quiet Mode)
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "sudo snap install helm --classic && \
         sudo apt-get update && \
         sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -o Dpkg::Options::='--force-confdef' -o Dpkg::Options::='--force-confold' git"
      register: tools_install
      changed_when: "'installed' in tools_install.stdout"

    - name: 2.2 ä¸‹è¼‰ StackHPC Chart (Git Clone)
      # StackHPC çš„ master åˆ†æ”¯æ˜¯å­˜åœ¨çš„ï¼Œç›´æ¥ clone
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "rm -rf slurm-k8s-cluster && \
         git clone --depth 1 {{ git_repo_url }}"
      changed_when: true

    - name: 2.3 ä¸‹è¼‰ä¾è³´ (StackHPC ä¾è³´ MariaDB ç­‰)
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "cd slurm-k8s-cluster/slurm-cluster-chart && helm dependency update"
      changed_when: true

    # -----------------------------------------------------------
    # 3. è¨­å®šæª”é…ç½® (é©é… StackHPC æ ¼å¼)
    # -----------------------------------------------------------
    - name: 3.1 ç”¢ç”Ÿ StackHPC å°ˆç”¨ values.yaml
      # StackHPC çš„åƒæ•¸çµæ§‹èˆ‡ SchedMD ä¸åŒï¼Œé€™è£¡åšäº†å°æ‡‰èª¿æ•´
      shell: |
        juju ssh --model {{ test_model }} 0 -- "cat <<EOF > /home/ubuntu/stackhpc-values.yaml
        global:
          clusterName: {{ test_model }}

        # 1. å„²å­˜è¨­å®š (ä½¿ç”¨ local-path)
        # StackHPC é€šå¸¸æœƒè‡ªå‹•è£ NFSï¼Œæˆ‘å€‘é€™è£¡ç›¡é‡ç”¨ local-path è¦†è“‹
        volumeClaim:
          storageClassName: \"local-path\"
          size: 10Gi

        # 2. æ§åˆ¶å™¨è¨­å®š
        controller:
          size: 10Gi
          storageClassName: \"local-path\"
          resources:
            limits:
              cpu: 2
              memory: 4Gi

        # 3. è³‡æ–™åº«è¨­å®š (StackHPC å…§å»º MariaDB ä¾è³´)
        slurmdbd:
          enabled: true
          storageClassName: \"local-path\"
          size: 10Gi

        # 4. ç™»å…¥ç¯€é» (é–‹å•Ÿ NodePort)
        login:
          service:
            type: NodePort
            nodePort: 30022
          ssh:
            enabled: true

        # 5. é‹ç®—ç¯€é»
        worker:
          replicas: 1
          resources:
            limits:
              cpu: 16
              memory: 64Gi
        EOF"
      changed_when: false

    # -----------------------------------------------------------
    # 4. åŸ·è¡Œéƒ¨ç½²
    # -----------------------------------------------------------
    - name: 4.1 å®‰è£ StackHPC Slurm Chart
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "helm upgrade --install {{ release_name }} ./slurm-k8s-cluster/slurm-cluster-chart \
          --namespace {{ namespace }} \
          --create-namespace \
          -f /home/ubuntu/stackhpc-values.yaml \
          --wait --timeout 15m"
      register: helm_deploy
      changed_when: "'Release \"{{ release_name }}\" does not exist' in helm_deploy.stderr or 'Happy Helming' in helm_deploy.stdout"

    # -----------------------------------------------------------
    # 5. è³‡è¨Šé¡¯ç¤º
    # -----------------------------------------------------------
    - name: 5.1 ç²å– Machine 0 IP
      shell: |
        juju status --model {{ test_model }} --format json | jq -r '.machines["0"]["dns-name"]'
      register: master_ip

    - name: âœ… StackHPC Slurm éƒ¨ç½²å®Œæˆ
      debug:
        msg: 
          - "ğŸ‰ Slurm on K8s (StackHPC Version) éƒ¨ç½²æˆåŠŸï¼"
          - "é€™å€‹ Repo ç©©å®šå¤šäº†ï¼Œè³‡æ–™åº«ä¹Ÿå·²è‡ªå‹•å»ºç«‹ã€‚"
          - "è«‹å˜—è©¦ SSH é€£ç·šç™»å…¥ç¯€é»ï¼š"
          - "ssh rocky@{{ master_ip.stdout }} -p 30022" 
          - "(æ³¨æ„ï¼šStackHPC é è¨­ä½¿ç”¨è€…å¯èƒ½æ˜¯ 'rocky' æˆ– 'ubuntu'ï¼Œè«‹ä¾å¯¦éš›æƒ…æ³æ¸¬è©¦)"
