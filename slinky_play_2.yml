---
# ========================================================
# SKU: Slinky-App-Standalone-v1.4-NonInteractive
# ä¿®æ­£ï¼š
#   1. å¼·åˆ¶è¨­å®š DEBIAN_FRONTEND=noninteractive (è§£æ±ºå¡æ­»)
#   2. ç§»é™¤ needrestart å¹²æ“¾
#   3. ç¶­æŒ Wget ä¸‹è¼‰ (ä¿è­‰ç¶²è·¯æš¢é€š)
# ========================================================
- name: Application Layer - Deploy Slinky (Slurm)
  hosts: maasjuju
  gather_facts: yes
  vars:
    test_model: "slinky-cluster"
    release_name: "slinky"
    namespace: "slurm-cluster"
    zip_url: "https://github.com/schedmd/slurm-helm-charts/archive/refs/heads/master.zip"

  tasks:
    # -----------------------------------------------------------
    # 1. æª¢æŸ¥ç’°å¢ƒ
    # -----------------------------------------------------------
    - name: 1.1 ç¢ºèª Machine 0 æ˜¯å¦å­˜æ´»
      shell: juju ssh --model {{ test_model }} 0 -- "echo 'alive'"
      register: machine_check
      ignore_errors: yes

    - name: 1.2 çµ‚æ­¢æª¢æŸ¥
      fail:
        msg: "âŒ æ‰¾ä¸åˆ° Machine 0ï¼è«‹å…ˆåŸ·è¡Œ Infrastructure Playbookã€‚"
      when: machine_check.rc != 0

    # -----------------------------------------------------------
    # 2. æº–å‚™éƒ¨ç½²å·¥å…· (Anti-Hang Mode)
    # -----------------------------------------------------------
    - name: 2.1 [é˜²å¡æ­»ä¿®æ­£] åœ¨ Machine 0 å®‰è£ Helm èˆ‡å·¥å…·
      # åŠ å…¥ç’°å¢ƒè®Šæ•¸ï¼Œç¦æ­¢ apt è·³å‡ºå•ç­”è¦–çª—
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "sudo snap install helm --classic && \
         sudo apt-get update && \
         sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -o Dpkg::Options::='--force-confdef' -o Dpkg::Options::='--force-confold' wget unzip"
      register: tools_install
      changed_when: "'installed' in tools_install.stdout"

    - name: 2.2 ä½¿ç”¨ Wget ä¸‹è¼‰åŸå§‹ç¢¼ ZIP
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "rm -rf slurm-helm-charts master.zip && \
         wget -O master.zip {{ zip_url }} && \
         unzip -o master.zip && \
         mv slurm-helm-charts-master slurm-helm-charts && \
         rm master.zip"
      changed_when: true

    - name: 2.3 ä¸‹è¼‰ Chart ä¾è³´å¥—ä»¶ (MariaDB)
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "cd slurm-helm-charts/charts/slurm-cluster && helm dependency update"
      changed_when: true

    # -----------------------------------------------------------
    # 3. è¨­å®šæª”é…ç½®
    # -----------------------------------------------------------
    - name: 3.1 ç”¢ç”Ÿ Slinky è¨­å®šæª” (values.yaml)
      shell: |
        juju ssh --model {{ test_model }} 0 -- "cat <<EOF > /home/ubuntu/slinky-values.yaml
        global:
          clusterName: {{ test_model }}

        volumeClaimTemplate:
          accessModes: [ \"ReadWriteOnce\" ]
          storageClassName: \"local-path\"
          resources:
            requests:
              storage: 10Gi

        slurmctld:
          persistence:
            enabled: true
            storageClassName: \"local-path\"
            size: 10Gi
          resources:
            limits:
              cpu: 2
              memory: 4Gi

        slurmdbd:
          enabled: true
          persistence:
            enabled: true
            storageClassName: \"local-path\"
            size: 10Gi
          resources:
            limits:
              cpu: 2
              memory: 4Gi

        login:
          enabled: true
          service:
            type: NodePort
            nodePort: 30022
          ssh:
            enabled: true
          persistence:
            enabled: true
            storageClassName: \"local-path\"
            size: 10Gi

        slurmd:
          resources:
            requests:
              cpu: 1
              memory: 2Gi
            limits: 
              cpu: 16  
              memory: 64Gi
          persistence:
            enabled: true
            storageClassName: \"local-path\"
            size: 50Gi
        EOF"
      changed_when: false

    # -----------------------------------------------------------
    # 4. åŸ·è¡Œéƒ¨ç½²
    # -----------------------------------------------------------
    - name: 4.1 å®‰è£/æ›´æ–° Slurm
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "helm upgrade --install {{ release_name }} ./slurm-helm-charts/charts/slurm-cluster \
          --namespace {{ namespace }} \
          --create-namespace \
          -f /home/ubuntu/slinky-values.yaml \
          --wait --timeout 15m"
      register: helm_deploy
      changed_when: "'Release \"{{ release_name }}\" does not exist' in helm_deploy.stderr or 'Happy Helming' in helm_deploy.stdout"

    # -----------------------------------------------------------
    # 5. è³‡è¨Šé¡¯ç¤º
    # -----------------------------------------------------------
    - name: 5.1 ç²å– Machine 0 IP
      shell: |
        juju status --model {{ test_model }} --format json | jq -r '.machines["0"]["dns-name"]'
      register: master_ip

    - name: âœ… Slinky éƒ¨ç½²å®Œæˆ
      debug:
        msg: 
          - "ğŸ‰ Slurm on K8s (Final Fix) éƒ¨ç½²æˆåŠŸï¼"
          - "è³‡æ–™åº« (MariaDB) å·²è‡ªå‹•å»ºç«‹ã€‚"
          - "è«‹å˜—è©¦ SSH é€£ç·šç™»å…¥ç¯€é»ï¼š"
          - "ssh root@{{ master_ip.stdout }} -p 30022"
