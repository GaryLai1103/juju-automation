---
# ========================================================
# SKU: Slinky-App-Standalone-v4.8-FixCgroup
# ä¿®æ­£ï¼š
#   1. [Fix Crash] ä¿®æ”¹ slurm.confï¼Œå°‡ ProctrackType æ”¹ç‚º linuxproc
#   2. [Fix Crash] ç§»é™¤ TaskPlugin ä¸­çš„ task/cgroup
#   3. [Restart] é‡å•Ÿ slurmd å’Œ login ç¯€é»è®“è¨­å®šç”Ÿæ•ˆ
# ========================================================
- name: Application Layer - Deploy Slurm (Fix Cgroup Crash)
  hosts: maasjuju
  gather_facts: yes
  vars:
    test_model: "slinky-cluster"
    namespace: "slurm-cluster"

  tasks:
    # -----------------------------------------------------------
    # 0. ç’°å¢ƒæ¸…ç†èˆ‡å»ºç«‹ (ç¢ºä¿ 100% ä¹¾æ·¨)
    # -----------------------------------------------------------
    - name: 0.1 æª¢æŸ¥ä¸¦å¼·åˆ¶åˆªé™¤èˆŠçš„ Namespace (å¦‚æœå­˜åœ¨)
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "kubectl delete namespace {{ namespace }} --ignore-not-found=true --wait=true --timeout=60s"
      register: delete_ns_result
      changed_when: "'deleted' in delete_ns_result.stdout"

    - name: 0.2 ç¢ºä¿ Namespace å­˜åœ¨ (å…¨æ–°å»ºç«‹)
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "kubectl create namespace {{ namespace }}"
      register: create_ns_result
      changed_when: "'created' in create_ns_result.stdout"

    # -----------------------------------------------------------
    # 0.3 åˆæ¬¡éƒ¨ç½² Slurm (é€™è£¡å¿…é ˆå…ˆæœ‰ ConfigMap æ‰èƒ½è®“å¾Œé¢çš„ sed åŸ·è¡Œ)
    # -----------------------------------------------------------
    - name: 0.3 ç”¢ç”Ÿåˆå§‹ Slurm ConfigMap
      # æ³¨æ„ï¼šé€™è£¡å…ˆå»ºç«‹ä¸€å€‹ç©ºçš„æˆ–åŸºç¤çš„ ConfigMapï¼Œå¾ŒçºŒ Task 1 æ‰æœƒå»ä¿®æ”¹å®ƒ
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "kubectl create configmap slurm-conf-configmap -n {{ namespace }} --from-literal=slurm.conf='ProctrackType=proctrack/cgroup\nTaskPlugin=task/cgroup,task/affinity'"
      changed_when: true

    # -----------------------------------------------------------
    # 1. ä¿®æ”¹ Slurm è¨­å®šæª” (åŸæœ¬çš„é‚è¼¯ç¾åœ¨å¯ä»¥å®‰å…¨åŸ·è¡Œäº†)
    # -----------------------------------------------------------
    - name: 1.1 å¾ K8s æŠ“å–ç›®å‰çš„ slurm.conf
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "kubectl get cm slurm-conf-configmap -n {{ namespace }} -o jsonpath='{.data.slurm\.conf}' > /home/ubuntu/slurm.conf.current"
      changed_when: false

    - name: 1.2 ä¿®æ”¹è¨­å®š (Cgroup -> LinuxProc)
      # ä½¿ç”¨ sed æ›¿æ›æ‰æœƒå ±éŒ¯çš„ Cgroup è¨­å®š
      # 1. ProctrackType: æ”¹ç”¨ linuxproc (å–®ç´”è¿½è¹¤é€²ç¨‹ï¼Œä¸ç¢° Cgroup)
      # 2. TaskPlugin: ç§»é™¤ task/cgroup
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "sed -i 's/ProctrackType=proctrack\/cgroup/ProctrackType=proctrack\/linuxproc/g' /home/ubuntu/slurm.conf.current && \
         sed -i 's/TaskPlugin=task\/affinity,task\/cgroup/TaskPlugin=task\/affinity/g' /home/ubuntu/slurm.conf.current && \
         sed -i 's/TaskPlugin=task\/cgroup,task\/affinity/TaskPlugin=task\/affinity/g' /home/ubuntu/slurm.conf.current && \
         sed -i 's/TaskPlugin=task\/cgroup/TaskPlugin=task\/none/g' /home/ubuntu/slurm.conf.current"
      changed_when: true

    - name: 1.3 å°‡ä¿®æ”¹å¾Œçš„è¨­å®šå¯«å› K8s ConfigMap
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "kubectl create configmap slurm-conf-configmap \
          --from-file=slurm.conf=/home/ubuntu/slurm.conf.current \
          -n {{ namespace }} \
          --dry-run=client -o yaml | kubectl apply -f -"
      changed_when: true

    # -----------------------------------------------------------
    # 2. é‡å•Ÿç¯€é» (è®“å®ƒå€‘è®€å–æ–°è¨­å®š)
    # -----------------------------------------------------------
    - name: 2.1 é‡å•Ÿå´©æ½°çš„é‹ç®—ç¯€é» (slurmd)
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "kubectl delete pod -l app.kubernetes.io/component=slurmd -n {{ namespace }} --wait=false"
      changed_when: true

    - name: 2.2 é‡å•Ÿå¡ä½çš„ç™»å…¥ç¯€é» (login)
      # login ç¯€é»ä¹Ÿæ›è¼‰äº†åŒæ¨£çš„ configmapï¼Œé‡å•Ÿå®ƒæœ‰åŠ©æ–¼è§£æ±ºå¡ä½å•é¡Œ
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "kubectl delete pod -l app.kubernetes.io/component=login -n {{ namespace }} --wait=false"
      changed_when: true

    - name: âœ… å®Œæˆ
      debug:
        msg: 
          - "ğŸ‰ V4.8 (Cgroup Fix) åŸ·è¡ŒæˆåŠŸï¼"
          - "å·²å°‡è¨­å®šæ”¹ç‚º linuxproc æ¨¡å¼ï¼Œé¿é–‹äº† Cgroup å ±éŒ¯ã€‚"
          - "æ­£åœ¨é‡å•Ÿ Worker å’Œ Login ç¯€é»..."
          - "è«‹ç­‰å¾…ç´„ 30~60 ç§’å¾Œæª¢æŸ¥: kubectl get pods -n slurm-cluster"
