---
# ========================================================
# SKU: Slinky-App-Standalone-v4.8-FixCgroup
# ä¿®æ­£ï¼š
#   1. [Fix Crash] ä¿®æ”¹ slurm.confï¼Œå°‡ ProctrackType æ”¹ç‚º linuxproc
#   2. [Fix Crash] ç§»é™¤ TaskPlugin ä¸­çš„ task/cgroup
#   3. [Restart] é‡å•Ÿ slurmd å’Œ login ç¯€é»è®“è¨­å®šç”Ÿæ•ˆ
# ========================================================
- name: Application Layer - Deploy Slurm (Fix Cgroup Crash)
  hosts: maasjuju
  gather_facts: yes
  vars:
    test_model: "slinky-cluster"
    namespace: "slurm-cluster"

  tasks:
    # -----------------------------------------------------------
    # 0. ç’°å¢ƒåˆå§‹åŒ– (åˆªé™¤ä¸¦é‡å»º)
    # -----------------------------------------------------------
    - name: 0.1 å¼·åˆ¶åˆªé™¤èˆŠçš„ Namespace
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "kubectl delete namespace {{ namespace }} --ignore-not-found=true --wait=true"

    - name: 0.2 å»ºç«‹å…¨æ–° Namespace
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "kubectl create namespace {{ namespace }}"

    # -----------------------------------------------------------
    # 0.3 é‡æ–°éƒ¨ç½² Slurm æœ¬é«” (é€™æ˜¯æ‚¨ç›®å‰æ¼æ‰çš„é—œéµæ­¥)
    # -----------------------------------------------------------
    - name: 0.3 éƒ¨ç½² Slurm è³‡æº (ä¾æ“š stackhpc å°ˆæ¡ˆå…§å®¹)
      # é€™è£¡å‡è¨­æ‚¨æ˜¯ç›´æ¥ apply è©²å°ˆæ¡ˆæä¾›çš„ manifest æª”æ¡ˆ
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "kubectl apply -f https://raw.githubusercontent.com/stackhpc/slurm-k8s-cluster/main/slurm-cluster.yaml -n {{ namespace }}"
      # è«‹å°‡ä¸Šé¢çš„ URL æ›¿æ›ç‚ºæ‚¨å¯¦éš›ä½¿ç”¨çš„éƒ¨ç½²æª”æ¡ˆä½ç½® (ä¾‹å¦‚å°ˆæ¡ˆå…§çš„æŸå€‹ yaml)

    # -----------------------------------------------------------
    # 1. ä¿®æ”¹ Slurm è¨­å®šæª” (ä¿®æ­£ Cgroup å•é¡Œ)
    # -----------------------------------------------------------
    - name: 1.1 ç­‰å¾… ConfigMap å‡ºç¾ä¸¦æŠ“å– slurm.conf
      # å› ç‚ºå‰›éƒ¨ç½²å®Œéœ€è¦å¹¾ç§’é˜è®“ K8s å»ºç«‹ ConfigMap
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "kubectl get cm slurm-conf-configmap -n {{ namespace }} -o jsonpath='{.data.slurm\.conf}' > /home/ubuntu/slurm.conf.current"
      register: get_cm
      until: get_cm.rc == 0
      retries: 5
      delay: 5

    - name: 1.2 ä¿®æ”¹è¨­å®š (Cgroup -> LinuxProc)
      # ä½¿ç”¨ sed æ›¿æ›æ‰æœƒå ±éŒ¯çš„ Cgroup è¨­å®š
      # 1. ProctrackType: æ”¹ç”¨ linuxproc (å–®ç´”è¿½è¹¤é€²ç¨‹ï¼Œä¸ç¢° Cgroup)
      # 2. TaskPlugin: ç§»é™¤ task/cgroup
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "sed -i 's/ProctrackType=proctrack\/cgroup/ProctrackType=proctrack\/linuxproc/g' /home/ubuntu/slurm.conf.current && \
         sed -i 's/TaskPlugin=task\/affinity,task\/cgroup/TaskPlugin=task\/affinity/g' /home/ubuntu/slurm.conf.current && \
         sed -i 's/TaskPlugin=task\/cgroup,task\/affinity/TaskPlugin=task\/affinity/g' /home/ubuntu/slurm.conf.current && \
         sed -i 's/TaskPlugin=task\/cgroup/TaskPlugin=task\/none/g' /home/ubuntu/slurm.conf.current"
      changed_when: true

    - name: 1.3 å°‡ä¿®æ”¹å¾Œçš„è¨­å®šå¯«å› K8s ConfigMap
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "kubectl create configmap slurm-conf-configmap \
          --from-file=slurm.conf=/home/ubuntu/slurm.conf.current \
          -n {{ namespace }} \
          --dry-run=client -o yaml | kubectl apply -f -"
      changed_when: true

    # -----------------------------------------------------------
    # 2. é‡å•Ÿç¯€é» (è®“å®ƒå€‘è®€å–æ–°è¨­å®š)
    # -----------------------------------------------------------
    - name: 2.1 é‡å•Ÿå´©æ½°çš„é‹ç®—ç¯€é» (slurmd)
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "kubectl delete pod -l app.kubernetes.io/component=slurmd -n {{ namespace }} --wait=false"
      changed_when: true

    - name: 2.2 é‡å•Ÿå¡ä½çš„ç™»å…¥ç¯€é» (login)
      # login ç¯€é»ä¹Ÿæ›è¼‰äº†åŒæ¨£çš„ configmapï¼Œé‡å•Ÿå®ƒæœ‰åŠ©æ–¼è§£æ±ºå¡ä½å•é¡Œ
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "kubectl delete pod -l app.kubernetes.io/component=login -n {{ namespace }} --wait=false"
      changed_when: true

    - name: âœ… å®Œæˆ
      debug:
        msg: 
          - "ğŸ‰ V4.8 (Cgroup Fix) åŸ·è¡ŒæˆåŠŸï¼"
          - "å·²å°‡è¨­å®šæ”¹ç‚º linuxproc æ¨¡å¼ï¼Œé¿é–‹äº† Cgroup å ±éŒ¯ã€‚"
          - "æ­£åœ¨é‡å•Ÿ Worker å’Œ Login ç¯€é»..."
          - "è«‹ç­‰å¾…ç´„ 30~60 ç§’å¾Œæª¢æŸ¥: kubectl get pods -n slurm-cluster"
