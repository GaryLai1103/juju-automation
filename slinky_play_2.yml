---
# ========================================================
# SKU: Slinky-App-Standalone-v4.1-DisableRook
# ä¿®æ­£ï¼š
#   1. æ˜ç¢ºç¦ç”¨ rook-nfs å­åœ–è¡¨ (è§£æ±º rook-nfs-backing-pv å¡æ­»)
#   2. æ‰‹å‹•å»ºç«‹ PVC ä¸¦åŠ ä¸Š Helm Labels (å½è£æˆ Helm è³‡æºï¼Œé¿å…æ‰€æœ‰æ¬Šè¡çª)
#   3. ä½¿ç”¨ Base64 ç¢ºä¿ YAML æ ¼å¼å®Œç¾
# ========================================================
- name: Application Layer - Deploy Slurm (No Rook Mode)
  hosts: maasjuju
  gather_facts: yes
  vars:
    test_model: "slinky-cluster"
    release_name: "slinky"
    namespace: "slurm-cluster"
    slurm_git_url: "https://github.com/stackhpc/slurm-k8s-cluster.git"
    nfs_path: "/srv/nfs/kubedata"
    nfs_server_ip: "192.168.1.96"

  tasks:
    # -----------------------------------------------------------
    # 1. å¼·åŠ›æ¸…ç†æˆ°å ´
    # -----------------------------------------------------------
    - name: 1.1 æ¸…ç†æ‰€æœ‰å¡ä½çš„è³‡æº
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "helm uninstall {{ release_name }} -n {{ namespace }} --wait=false 2>/dev/null || true && \
         kubectl delete pvc --all -n {{ namespace }} --wait=false 2>/dev/null || true && \
         kubectl delete pv slurm-nfs-pv --wait=false 2>/dev/null || true && \
         kubectl delete pvp rook-nfs-backing-pv -n {{ namespace }} --wait=false 2>/dev/null || true"
      changed_when: true

    # -----------------------------------------------------------
    # 2. å»ºç«‹ PV (PersistentVolume)
    # -----------------------------------------------------------
    - name: 2.1 å®šç¾© PV å…§å®¹
      set_fact:
        pv_yaml_content: |
          apiVersion: v1
          kind: PersistentVolume
          metadata:
            name: slurm-nfs-pv
            labels:
              type: nfs-static
          spec:
            capacity:
              storage: 20Gi
            accessModes:
              - ReadWriteMany
            persistentVolumeReclaimPolicy: Retain
            storageClassName: ""
            nfs:
              path: {{ nfs_path }}
              server: {{ nfs_server_ip }}

    - name: 2.2 å¯«å…¥ä¸¦æ‡‰ç”¨ PV
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "echo '{{ pv_yaml_content | b64encode }}' | base64 -d > /home/ubuntu/slurm-pv.yaml && \
         kubectl apply -f /home/ubuntu/slurm-pv.yaml"
      changed_when: true

    # -----------------------------------------------------------
    # 3. å»ºç«‹ã€Œå½è£ã€PVC (é—œéµæ­¥é©Ÿ)
    # -----------------------------------------------------------
    - name: 3.1 å®šç¾© PVC å…§å®¹ (åŠ ä¸Š Helm Labels)
      # é€™è£¡æˆ‘å€‘åŠ ä¸Šäº† Helm çš„æ¨™ç±¤ï¼Œé€™æ¨£ Helm å®‰è£æ™‚å°±æœƒèªç‚ºé€™å€‹ PVC æ˜¯å®ƒç®¡è½„çš„
      # ä¸¦ä¸”ä¸æœƒå› ç‚º AlreadyExists è€Œå ±éŒ¯ï¼Œä¹Ÿä¸æœƒè©¦åœ–é‡å»ºå®ƒ
      set_fact:
        pvc_yaml_content: |
          apiVersion: v1
          kind: PersistentVolumeClaim
          metadata:
            name: slurm-shared-storage
            namespace: {{ namespace }}
            labels:
              app.kubernetes.io/managed-by: Helm
            annotations:
              meta.helm.sh/release-name: {{ release_name }}
              meta.helm.sh/release-namespace: {{ namespace }}
          spec:
            accessModes:
              - ReadWriteMany
            resources:
              requests:
                storage: 20Gi
            volumeName: slurm-nfs-pv
            storageClassName: ""

    - name: 3.2 å¯«å…¥ä¸¦æ‡‰ç”¨ PVC
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "kubectl create ns {{ namespace }} 2>/dev/null || true && \
         echo '{{ pvc_yaml_content | b64encode }}' | base64 -d > /home/ubuntu/slurm-pvc.yaml && \
         kubectl apply -f /home/ubuntu/slurm-pvc.yaml"
      changed_when: true

    # -----------------------------------------------------------
    # 4. Host ç«¯ NFS ç¢ºèª
    # -----------------------------------------------------------
    - name: 4.1 ç¢ºä¿ NFS Server é‹ä½œ
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "sudo apt-get update && \
         sudo DEBIAN_FRONTEND=noninteractive apt-get install -y nfs-kernel-server && \
         sudo mkdir -p {{ nfs_path }} && \
         sudo chmod 777 {{ nfs_path }} && \
         echo '{{ nfs_path }} *(rw,sync,no_subtree_check,no_root_squash)' | sudo tee /etc/exports && \
         sudo exportfs -a && \
         sudo systemctl restart nfs-kernel-server"
      changed_when: true

    # -----------------------------------------------------------
    # 5. éƒ¨ç½² Slurm (ç¦ç”¨ Rook)
    # -----------------------------------------------------------
    - name: 5.1 ä¸‹è¼‰ StackHPC Chart
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "sudo apt-get install -y git && \
         rm -rf slurm-k8s-cluster && \
         git clone --depth 1 {{ slurm_git_url }}"
      changed_when: true

    - name: 5.2 ä¸‹è¼‰ä¾è³´
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "cd slurm-k8s-cluster/slurm-cluster-chart && helm dependency update"
      changed_when: true

    - name: 5.3 ç”¢ç”Ÿ Values (Disable Rook + Use Existing PVC)
      # [é‡é»ä¿®æ­£]
      # 1. rook-nfs: { enabled: false } -> å¾¹åº•æ®ºæ­»å…§å»º NFS
      # 2. volumeClaim: create: false -> å› ç‚ºæˆ‘å€‘å·²ç¶“æ‰‹å‹•å»ºäº†å½è£ PVC
      vars:
        values_content: |
          global:
            clusterName: {{ test_model }}
          
          # [æ®ºæ‰‹é§] ç¦ç”¨å…§å»º Rook NFS
          rook-nfs:
            enabled: false
          
          volumeClaim:
            create: false # æˆ‘å€‘è‡ªå·±å»ºäº†å¸¶æœ‰ Helm æ¨™ç±¤çš„ PVC
            name: slurm-shared-storage
            
          controller:
            size: 10Gi
            storageClassName: "local-path"
            resources:
              limits:
                cpu: 2
                memory: 4Gi
          slurmdbd:
            enabled: true
            storageClassName: "local-path"
            size: 10Gi
          login:
            service:
              type: NodePort
              nodePort: 30022
            ssh:
              enabled: true
          worker:
            replicas: 1
            resources:
              limits:
                cpu: 8
                memory: 16Gi
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "echo '{{ values_content | b64encode }}' | base64 -d > /home/ubuntu/slurm-static-values.yaml"
      changed_when: false

    - name: 5.4 éƒ¨ç½² Slurm
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "helm upgrade --install {{ release_name }} ./slurm-k8s-cluster/slurm-cluster-chart \
          --namespace {{ namespace }} \
          --create-namespace \
          -f /home/ubuntu/slurm-static-values.yaml \
          --wait --timeout 15m"
      register: helm_deploy

    - name: âœ… å®Œæˆ
      debug:
        msg: 
          - "ğŸ‰ V4.1 (Disable Rook Mode) éƒ¨ç½²æˆåŠŸï¼"
          - "Rook å·²è¢«ç¦ç”¨ï¼Œä½¿ç”¨å¤–éƒ¨ NFSã€‚"
          - "è«‹æª¢æŸ¥: kubectl get pvc -n slurm-cluster"
