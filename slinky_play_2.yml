---
# ========================================================
# SKU: Slinky-App-Standalone-v1.3-NoGit
# ä¿®æ­£ï¼š
#   1. å®Œå…¨æ”¾æ£„ git clone (å›  MTU å•é¡Œå°è‡´å¤§å°åŒ…å¡æ­»)
#   2. æ”¹ç”¨ wget ä¸‹è¼‰ ZIP (èµ°ç´” HTTP æµé‡ï¼Œä¿è­‰æš¢é€š)
# ========================================================
- name: Application Layer - Deploy Slinky (Slurm)
  hosts: maasjuju
  gather_facts: yes
  vars:
    test_model: "slinky-cluster"
    release_name: "slinky"
    namespace: "slurm-cluster"
    # ç›´æ¥æŒ‡å®š GitHub çš„ ZIP ä¸‹è¼‰é» (Master åˆ†æ”¯)
    zip_url: "https://github.com/schedmd/slurm-helm-charts/archive/refs/heads/master.zip"

  tasks:
    # -----------------------------------------------------------
    # 1. æª¢æŸ¥ç’°å¢ƒ
    # -----------------------------------------------------------
    - name: 1.1 ç¢ºèª Machine 0 æ˜¯å¦å­˜æ´»
      shell: juju ssh --model {{ test_model }} 0 -- "echo 'alive'"
      register: machine_check
      ignore_errors: yes

    - name: 1.2 çµ‚æ­¢æª¢æŸ¥
      fail:
        msg: "âŒ æ‰¾ä¸åˆ° Machine 0ï¼è«‹å…ˆåŸ·è¡Œ Infrastructure Playbookã€‚"
      when: machine_check.rc != 0

    # -----------------------------------------------------------
    # 2. æº–å‚™éƒ¨ç½²å·¥å…· (Helm + Wget/Unzip)
    # -----------------------------------------------------------
    - name: 2.1 åœ¨ Machine 0 å®‰è£ Helm èˆ‡è§£å£“å·¥å…·
      # [ä¿®æ­£] æ”¹è£ unzipï¼Œä¸éœ€è¦ git äº†
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "sudo snap install helm --classic && sudo apt-get update && sudo apt-get install -y wget unzip"
      register: tools_install
      changed_when: "'installed' in tools_install.stdout"

    - name: 2.2 [çµ‚æ¥µä¿®æ­£] ä½¿ç”¨ Wget ä¸‹è¼‰åŸå§‹ç¢¼ ZIP (é¿é–‹ Git å”å®š)
      # é‚è¼¯ï¼š
      # 1. æ¸…ç†èˆŠç’°å¢ƒ
      # 2. ä¸‹è¼‰ master.zip
      # 3. è§£å£“ç¸® (æœƒç”¢ç”Ÿ slurm-helm-charts-master è³‡æ–™å¤¾)
      # 4. é‡æ–°å‘½åç‚º slurm-helm-charts ä»¥ç¬¦åˆå¾ŒçºŒè·¯å¾‘
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "rm -rf slurm-helm-charts master.zip && \
         wget -O master.zip {{ zip_url }} && \
         unzip -o master.zip && \
         mv slurm-helm-charts-master slurm-helm-charts && \
         rm master.zip"
      changed_when: true

    - name: 2.3 ä¸‹è¼‰ Chart ä¾è³´å¥—ä»¶ (MariaDB)
      # è·¯å¾‘ä¾ç„¶æœ‰æ•ˆï¼Œå› ç‚ºæˆ‘å€‘å‰›å‰› mv é‡æ–°å‘½åäº†
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "cd slurm-helm-charts/charts/slurm-cluster && helm dependency update"
      changed_when: true

    # -----------------------------------------------------------
    # 3. è¨­å®šæª”é…ç½®
    # -----------------------------------------------------------
    - name: 3.1 ç”¢ç”Ÿ Slinky è¨­å®šæª” (values.yaml)
      shell: |
        juju ssh --model {{ test_model }} 0 -- "cat <<EOF > /home/ubuntu/slinky-values.yaml
        global:
          clusterName: {{ test_model }}

        volumeClaimTemplate:
          accessModes: [ \"ReadWriteOnce\" ]
          storageClassName: \"local-path\"
          resources:
            requests:
              storage: 10Gi

        slurmctld:
          persistence:
            enabled: true
            storageClassName: \"local-path\"
            size: 10Gi
          resources:
            limits:
              cpu: 2
              memory: 4Gi

        slurmdbd:
          enabled: true
          persistence:
            enabled: true
            storageClassName: \"local-path\"
            size: 10Gi
          resources:
            limits:
              cpu: 2
              memory: 4Gi

        login:
          enabled: true
          service:
            type: NodePort
            nodePort: 30022
          ssh:
            enabled: true
          persistence:
            enabled: true
            storageClassName: \"local-path\"
            size: 10Gi

        slurmd:
          resources:
            requests:
              cpu: 1
              memory: 2Gi
            limits: 
              cpu: 16  
              memory: 64Gi
          persistence:
            enabled: true
            storageClassName: \"local-path\"
            size: 50Gi
        EOF"
      changed_when: false

    # -----------------------------------------------------------
    # 4. åŸ·è¡Œéƒ¨ç½²
    # -----------------------------------------------------------
    - name: 4.1 å®‰è£/æ›´æ–° Slurm
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "helm upgrade --install {{ release_name }} ./slurm-helm-charts/charts/slurm-cluster \
          --namespace {{ namespace }} \
          --create-namespace \
          -f /home/ubuntu/slinky-values.yaml \
          --wait --timeout 15m"
      register: helm_deploy
      changed_when: "'Release \"{{ release_name }}\" does not exist' in helm_deploy.stderr or 'Happy Helming' in helm_deploy.stdout"

    # -----------------------------------------------------------
    # 5. è³‡è¨Šé¡¯ç¤º
    # -----------------------------------------------------------
    - name: 5.1 ç²å– Machine 0 IP
      shell: |
        juju status --model {{ test_model }} --format json | jq -r '.machines["0"]["dns-name"]'
      register: master_ip

    - name: âœ… Slinky éƒ¨ç½²å®Œæˆ
      debug:
        msg: 
          - "ğŸ‰ Slurm on K8s (Wget Mode) éƒ¨ç½²æˆåŠŸï¼"
          - "è³‡æ–™åº« (MariaDB) å·²è‡ªå‹•å»ºç«‹ã€‚"
          - "è«‹å˜—è©¦ SSH é€£ç·šç™»å…¥ç¯€é»ï¼š"
          - "ssh root@{{ master_ip.stdout }} -p 30022"
