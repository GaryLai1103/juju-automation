---
# ========================================================
# SKU: Slinky-App-Standalone-v4.5-TakeControl
# ä¿®æ­£ï¼š
#   1. [Root Cause] è§£æ±º Helm å¼·åˆ¶ä½¿ç”¨ slurm-rook-nfs çš„å•é¡Œ
#   2. [Strategy] æ”¹å› "æ‰‹å‹•å»ºç«‹ PVC"ï¼Œä¸¦è¨­å®š Helm create: false
#   3. [Binding] é€éæ‰‹å‹• PVC å¼·åˆ¶ç¶å®šéœæ…‹ PV
# ========================================================
- name: Application Layer - Deploy Slurm (Manual PVC Override)
  hosts: maasjuju
  gather_facts: yes
  vars:
    test_model: "slinky-cluster"
    release_name: "slinky"
    namespace: "slurm-cluster"
    slurm_git_url: "https://github.com/stackhpc/slurm-k8s-cluster.git"
    nfs_path: "/srv/nfs/kubedata"
    nfs_server_ip: "192.168.1.96"

  tasks:
    # -----------------------------------------------------------
    # 1. æ¸…ç†èˆŠçš„ Helm èˆ‡ PVC (ç¢ºä¿ä¹¾æ·¨é‡ä¾†)
    # -----------------------------------------------------------
    - name: 1.1 ç§»é™¤èˆŠçš„ Helm Release
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "helm uninstall {{ release_name }} -n {{ namespace }} --wait=false 2>/dev/null || true"
      changed_when: true

    - name: 1.2 åˆªé™¤å¡ä½çš„ PVC (å¿…é ˆåˆªé™¤æ‰èƒ½é‡å»ºæ­£ç¢ºçš„)
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "kubectl delete pvc slurm-shared-storage -n {{ namespace }} --wait=false 2>/dev/null || true"
      changed_when: true

    # -----------------------------------------------------------
    # 2. æ‰‹å‹•å»ºç«‹ PV (Server Side)
    # -----------------------------------------------------------
    - name: 2.1 å»ºç«‹ PV (Base64)
      vars:
        pv_yaml_content: |
          apiVersion: v1
          kind: PersistentVolume
          metadata:
            name: slurm-nfs-pv
            labels:
              type: nfs-static
          spec:
            capacity:
              storage: 20Gi
            accessModes:
              - ReadWriteMany
            persistentVolumeReclaimPolicy: Retain
            storageClassName: ""
            nfs:
              path: {{ nfs_path }}
              server: {{ nfs_server_ip }}
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "echo '{{ pv_yaml_content | b64encode }}' | base64 -d > /home/ubuntu/slurm-pv.yaml && \
         kubectl delete pv slurm-nfs-pv --wait=false 2>/dev/null || true && \
         kubectl apply -f /home/ubuntu/slurm-pv.yaml"
      changed_when: true

    # -----------------------------------------------------------
    # 3. æ‰‹å‹•å»ºç«‹ PVC (Client Side - å¥ªæ¬Šé—œéµ)
    # -----------------------------------------------------------
    - name: 3.1 å»ºç«‹ PVC (å¼·åˆ¶ç¶å®š PVï¼Œä¸è®“ Helm æ’æ‰‹)
      # [é‡é»] storageClassName: "" æ˜¯ç©ºå­—ä¸²
      # [é‡é»] volumeName: slurm-nfs-pv ç›´æ¥æŒ‡å®š PV
      vars:
        pvc_yaml_content: |
          apiVersion: v1
          kind: PersistentVolumeClaim
          metadata:
            name: slurm-shared-storage
            namespace: {{ namespace }}
          spec:
            accessModes:
              - ReadWriteMany
            resources:
              requests:
                storage: 20Gi
            volumeName: slurm-nfs-pv
            storageClassName: ""
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "kubectl create ns {{ namespace }} 2>/dev/null || true && \
         echo '{{ pvc_yaml_content | b64encode }}' | base64 -d > /home/ubuntu/slurm-pvc.yaml && \
         kubectl apply -f /home/ubuntu/slurm-pvc.yaml"
      changed_when: true

    # -----------------------------------------------------------
    # 4. éƒ¨ç½² Slurm
    # -----------------------------------------------------------
    - name: 4.1 ç”¢ç”Ÿ Values (ç¦ç”¨ PVC å»ºç«‹)
      # [é‡é»] volumeClaim.create: false -> å‘Šè¨´ Helm ç”¨æˆ‘å€‘å‰›å»ºå¥½çš„ PVC
      # [é‡é»] rook-nfs.enabled: false -> ä¾ç„¶è¦é—œæ‰ï¼Œé¿å…å…¶ä»–å¹²æ“¾
      vars:
        values_content: |
          global:
            clusterName: {{ test_model }}
          
          rook-nfs:
            enabled: false
          
          volumeClaim:
            create: false
            name: slurm-shared-storage
            
          controller:
            size: 10Gi
            storageClassName: "local-path"
            resources:
              limits:
                cpu: 2
                memory: 4Gi
          slurmdbd:
            enabled: true
            storageClassName: "local-path"
            size: 10Gi
          login:
            service:
              type: NodePort
              nodePort: 30022
            ssh:
              enabled: true
          worker:
            replicas: 1
            resources:
              limits:
                cpu: 8
                memory: 16Gi
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "echo '{{ values_content | b64encode }}' | base64 -d > /home/ubuntu/slurm-static-values.yaml"
      changed_when: false

    - name: 4.2 éƒ¨ç½² Slurm
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "helm upgrade --install {{ release_name }} ./slurm-k8s-cluster/slurm-cluster-chart \
          --namespace {{ namespace }} \
          --create-namespace \
          -f /home/ubuntu/slurm-static-values.yaml \
          --wait --timeout 15m"
      register: helm_deploy

    - name: âœ… å®Œæˆ
      debug:
        msg: 
          - "ğŸ‰ V4.5 (å¥ªæ¬Šç‰ˆ) éƒ¨ç½²æˆåŠŸï¼"
          - "PVC å·²æ‰‹å‹•å»ºç«‹ï¼Œå¼·åˆ¶ç¶å®š NFS PVã€‚"
          - "Helm å·²è¢«ç¦æ­¢å»ºç«‹ PVCï¼Œé¿å…äº† StorageClass éŒ¯èª¤ã€‚"
          - "è«‹æª¢æŸ¥: kubectl get pvc -n slurm-cluster"
