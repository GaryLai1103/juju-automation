---
# ========================================================
# SKU: Slinky-App-Standalone-v3.0-NFS
# æ¶æ§‹ï¼š
#   1. [Host] åœ¨ Machine 0 å®‰è£ NFS Server
#   2. [K8s]  å®‰è£ NFS Subdir Provisioner (é€£æ¥ Host NFS)
#   3. [App]  éƒ¨ç½² StackHPC Slurm (é–‹å•Ÿ ReadWriteMany)
# ========================================================
- name: Application Layer - Deploy NFS & Slurm
  hosts: maasjuju
  gather_facts: yes
  vars:
    test_model: "slinky-cluster"
    release_name: "slinky"
    namespace: "slurm-cluster"
    # Slurm Chart Repo
    slurm_git_url: "https://github.com/stackhpc/slurm-k8s-cluster.git"
    # NFS è¨­å®š
    nfs_path: "/srv/nfs/kubedata"

  tasks:
    # -----------------------------------------------------------
    # 1. æº–å‚™å·¥ä½œ & ç²å– IP
    # -----------------------------------------------------------
    - name: 1.1 ç¢ºèª Machine 0 å­˜æ´»
      shell: juju ssh --model {{ test_model }} 0 -- "echo 'alive'"
      register: machine_check
      ignore_errors: yes

    - name: 1.2 ç²å– Machine 0 å…§ç¶² IP (NFS Server IP)
      # é€™æ˜¯é—œéµï¼æˆ‘å€‘è¦æŠ“å‡º Machine 0 åœ¨å…§ç¶²çš„ IP
      shell: |
        juju status --model {{ test_model }} --format json | jq -r '.machines["0"]["dns-name"]'
      register: nfs_server_ip

    - name: é¡¯ç¤º NFS Server IP
      debug:
        msg: "NFS Server å°‡æ¶è¨­æ–¼: {{ nfs_server_ip.stdout }}"

    # -----------------------------------------------------------
    # 2. [ç³»çµ±å±¤] æ¶è¨­ NFS Server (åœ¨ Machine 0 å¯¦é«”æ©Ÿä¸Š)
    # -----------------------------------------------------------
    - name: 2.1 å®‰è£ NFS Kernel Server
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "sudo apt-get update && \
         sudo DEBIAN_FRONTEND=noninteractive apt-get install -y nfs-kernel-server"
      changed_when: true

    - name: 2.2 å»ºç«‹å…±äº«ç›®éŒ„
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "sudo mkdir -p {{ nfs_path }} && \
         sudo chown nobody:nogroup {{ nfs_path }} && \
         sudo chmod 777 {{ nfs_path }}"
      changed_when: true

    - name: 2.3 è¨­å®š Exports ä¸¦å•Ÿå‹•æœå‹™
      # å…è¨±å…§ç¶²æ‰€æœ‰æ©Ÿå™¨æ›è¼‰ (insecure, no_root_squash æ˜¯ç‚ºäº†æ–¹ä¾¿ K8s æ“ä½œ)
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "echo '{{ nfs_path }} *(rw,sync,no_subtree_check,no_root_squash)' | sudo tee /etc/exports && \
         sudo exportfs -a && \
         sudo systemctl restart nfs-kernel-server"
      changed_when: true

    # -----------------------------------------------------------
    # 3. [K8s å±¤] å®‰è£ NFS Provisioner (StorageClass)
    # -----------------------------------------------------------
    - name: 3.1 åŠ å…¥ NFS Provisioner Helm Repo
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "helm repo add nfs-subdir-external-provisioner https://kubernetes-sigs.github.io/nfs-subdir-external-provisioner/ && \
         helm repo update"
      changed_when: false

    - name: 3.2 å®‰è£ NFS Provisioner
      # é€™æœƒå»ºç«‹ä¸€å€‹åç‚º 'nfs-client' çš„ StorageClass
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "helm upgrade --install nfs-client nfs-subdir-external-provisioner/nfs-subdir-external-provisioner \
          --set nfs.server={{ nfs_server_ip.stdout }} \
          --set nfs.path={{ nfs_path }} \
          --set storageClass.name=nfs-client \
          --set storageClass.defaultClass=true"
      register: nfs_deploy
      changed_when: "'Happy Helming' in nfs_deploy.stdout"

    # -----------------------------------------------------------
    # 4. [æ‡‰ç”¨å±¤] éƒ¨ç½² Slurm (ä½¿ç”¨ NFS RWX)
    # -----------------------------------------------------------
    - name: 4.1 ä¸‹è¼‰ Slurm Chart (StackHPC)
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "sudo apt-get install -y git && \
         rm -rf slurm-k8s-cluster && \
         git clone --depth 1 {{ slurm_git_url }}"
      changed_when: true

    - name: 4.2 ä¸‹è¼‰ä¾è³´
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "cd slurm-k8s-cluster/slurm-cluster-chart && helm dependency update"
      changed_when: true

    - name: 4.3 ç”¢ç”Ÿ Values (é–‹å•Ÿ RWX æ¨¡å¼ï¼)
      # [é‡é»] é€™è£¡ storageClassName æ”¹æˆ 'nfs-client'
      # [é‡é»] accessModes æ”¹å› 'ReadWriteMany' (å› ç‚º NFS æ”¯æ´ï¼)
      shell: |
        juju ssh --model {{ test_model }} 0 -- "cat <<EOF > /home/ubuntu/slurm-nfs-values.yaml
        global:
          clusterName: {{ test_model }}

        # [å„²å­˜è¨­å®š]
        # ä½¿ç”¨å‰›å‰›å»ºç«‹çš„ NFS StorageClass
        volumeClaim:
          storageClassName: \"nfs-client\"
          accessModes: [ \"ReadWriteMany\" ]
          size: 20Gi

        controller:
          size: 10Gi
          storageClassName: \"nfs-client\"
          resources:
            limits:
              cpu: 2
              memory: 4Gi

        slurmdbd:
          enabled: true
          storageClassName: \"nfs-client\"
          size: 10Gi

        login:
          service:
            type: NodePort
            nodePort: 30022
          ssh:
            enabled: true

        worker:
          replicas: 1
          resources:
            limits:
              cpu: 8
              memory: 16Gi
        EOF"
      changed_when: false

    - name: 4.4 éƒ¨ç½²/æ›´æ–° Slurm
      # å…ˆç æ‰èˆŠ PVC (å¦‚æœæœ‰çš„è©±)ï¼Œç¢ºä¿ä¹¾æ·¨é‡å»º
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "kubectl delete pvc --all -n {{ namespace }} --wait=false || true && \
         helm upgrade --install {{ release_name }} ./slurm-k8s-cluster/slurm-cluster-chart \
          --namespace {{ namespace }} \
          --create-namespace \
          -f /home/ubuntu/slurm-nfs-values.yaml \
          --wait --timeout 15m"
      register: slurm_deploy

    - name: âœ… å®Œæˆ
      debug:
        msg: 
          - "ğŸ‰ Slurm + NFS æ¶æ§‹éƒ¨ç½²æˆåŠŸï¼"
          - "NFS Server IP: {{ nfs_server_ip.stdout }}"
          - "StorageClass: nfs-client (ReadWriteMany æ”¯æ´)"
          - "ç¾åœ¨å¤šå€‹ Worker ç¯€é»å¯ä»¥åŒæ™‚è®€å¯« /home ç›®éŒ„äº†ã€‚"
