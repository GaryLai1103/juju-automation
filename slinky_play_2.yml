---
# ========================================================
# SKU: Slinky-App-Standalone-v3.4-Printf
# ä¿®æ­£ï¼š
#   1. æ”¾æ£„ cat/echoï¼Œæ”¹ç”¨ printf ç”Ÿæˆ YAML (æ ¼å¼çµ•å°ç²¾æº–)
#   2. å¼·åŒ– IP è®Šæ•¸æ¸…ç†ï¼Œç¢ºä¿ç„¡éš±è—æ›è¡Œç¬¦
# ========================================================
- name: Application Layer - Deploy Slurm (Static NFS Printf)
  hosts: maasjuju
  gather_facts: yes
  vars:
    test_model: "slinky-cluster"
    release_name: "slinky"
    namespace: "slurm-cluster"
    slurm_git_url: "https://github.com/stackhpc/slurm-k8s-cluster.git"
    nfs_path: "/srv/nfs/kubedata"

  tasks:
    # -----------------------------------------------------------
    # 1. æº–å‚™å·¥ä½œ & IP ç²å–
    # -----------------------------------------------------------
    - name: 1.1 ç¢ºèª Machine 0 å­˜æ´»
      shell: juju ssh --model {{ test_model }} 0 -- "echo 'alive'"
      register: machine_check
      ignore_errors: yes

    - name: 1.2 ç²å– Machine 0 å…§ç¶² IP (å¼·åŒ–æ¸…ç†)
      # jq -r è¼¸å‡ºå¾Œï¼Œå†ç”¨ tr -d åˆªé™¤ä»»ä½•å¯èƒ½å­˜åœ¨çš„æ›è¡Œç¬¦è™Ÿ (\n æˆ– \r)
      shell: |
        juju status --model {{ test_model }} --format json | jq -r '.machines["0"]["dns-name"]' | tr -d '\n\r'
      register: nfs_server_ip

    - name: 1.3 æª¢æŸ¥ä¸¦é¡¯ç¤º IP
      fail:
        msg: "âŒ ç„¡æ³•ç²å– Machine 0 çš„ IP (ç‚ºç©ºå€¼)"
      when: nfs_server_ip.stdout | length == 0

    - name: é¡¯ç¤ºæª¢æ¸¬åˆ°çš„ NFS IP
      debug:
        msg: "Target NFS Server IP: [{{ nfs_server_ip.stdout }}]"

    # -----------------------------------------------------------
    # 2. NFS Server æ¶è¨­ (Host)
    # -----------------------------------------------------------
    - name: 2.1 å®‰è£ NFS Kernel Server
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "sudo apt-get update && \
         sudo DEBIAN_FRONTEND=noninteractive apt-get install -y nfs-kernel-server && \
         sudo mkdir -p {{ nfs_path }} && \
         sudo chown nobody:nogroup {{ nfs_path }} && \
         sudo chmod 777 {{ nfs_path }} && \
         echo '{{ nfs_path }} *(rw,sync,no_subtree_check,no_root_squash)' | sudo tee /etc/exports && \
         sudo exportfs -a && \
         sudo systemctl restart nfs-kernel-server"
      changed_when: true

    # -----------------------------------------------------------
    # 3. [çµ‚æ¥µä¿®æ­£] ä½¿ç”¨ Printf ç”Ÿæˆ PV/PVC
    # -----------------------------------------------------------
    - name: 3.1 ç”Ÿæˆ PV å®šç¾©æª” (ä½¿ç”¨ printf)
      # %s æœƒè¢«å¾Œé¢çš„è®Šæ•¸æ›¿æ›ï¼Œ\n ä»£è¡¨æ›è¡Œï¼Œé€™ç¨®å¯«æ³•ä¸æœƒæœ‰ç¸®æ’éŒ¯èª¤
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "printf 'apiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: slurm-nfs-pv\nspec:\n  capacity:\n    storage: 20Gi\n  accessModes:\n    - ReadWriteMany\n  persistentVolumeReclaimPolicy: Retain\n  nfs:\n    path: %s\n    server: %s\n' '{{ nfs_path }}' '{{ nfs_server_ip.stdout }}' > /home/ubuntu/slurm-pv.yaml"
      changed_when: true

    - name: 3.2 ç”Ÿæˆ PVC å®šç¾©æª” (ä½¿ç”¨ printf)
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "printf 'apiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: slurm-shared-storage\n  namespace: {{ namespace }}\nspec:\n  accessModes:\n    - ReadWriteMany\n  resources:\n    requests:\n      storage: 20Gi\n  volumeName: slurm-nfs-pv\n  storageClassName: \"\"\n' > /home/ubuntu/slurm-pvc.yaml"
      changed_when: true

    - name: 3.3 æ‡‰ç”¨è¨­å®š
      # å…ˆåˆªé™¤èˆŠçš„ä»¥å…è¡çªï¼Œå†å»ºç«‹æ–°çš„
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "kubectl delete pv slurm-nfs-pv --wait=false 2>/dev/null || true && \
         kubectl delete pvc slurm-shared-storage -n {{ namespace }} --wait=false 2>/dev/null || true && \
         kubectl create ns {{ namespace }} 2>/dev/null || true && \
         kubectl apply -f /home/ubuntu/slurm-pv.yaml && \
         kubectl apply -f /home/ubuntu/slurm-pvc.yaml"
      changed_when: true

    # -----------------------------------------------------------
    # 4. éƒ¨ç½² Slurm
    # -----------------------------------------------------------
    - name: 4.1 ä¸‹è¼‰ StackHPC Chart
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "sudo apt-get install -y git && \
         rm -rf slurm-k8s-cluster && \
         git clone --depth 1 {{ slurm_git_url }}"
      changed_when: true

    - name: 4.2 ä¸‹è¼‰ä¾è³´
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "cd slurm-k8s-cluster/slurm-cluster-chart && helm dependency update"
      changed_when: true

    - name: 4.3 ç”¢ç”Ÿ Values (Printf æ¨¡å¼)
      # åŒæ¨£ä½¿ç”¨ printf ç”Ÿæˆ values.yaml
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "printf 'global:\n  clusterName: {{ test_model }}\nvolumeClaim:\n  create: false\n  name: slurm-shared-storage\ncontroller:\n  size: 10Gi\n  storageClassName: \"local-path\"\n  resources:\n    limits:\n      cpu: 2\n      memory: 4Gi\nslurmdbd:\n  enabled: true\n  storageClassName: \"local-path\"\n  size: 10Gi\nlogin:\n  service:\n    type: NodePort\n    nodePort: 30022\n  ssh:\n    enabled: true\nworker:\n  replicas: 1\n  resources:\n    limits:\n      cpu: 8\n      memory: 16Gi\n' > /home/ubuntu/slurm-static-values.yaml"
      changed_when: false

    - name: 4.4 éƒ¨ç½² Slurm
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "helm upgrade --install {{ release_name }} ./slurm-k8s-cluster/slurm-cluster-chart \
          --namespace {{ namespace }} \
          --create-namespace \
          -f /home/ubuntu/slurm-static-values.yaml \
          --wait --timeout 15m"
      register: helm_deploy

    - name: âœ… å®Œæˆ
      debug:
        msg: 
          - "ğŸ‰ Slurm + NFS (Printf Version) éƒ¨ç½²æˆåŠŸï¼"
          - "æˆ‘å€‘ä½¿ç”¨äº†æœ€åš´æ ¼çš„ printf æ ¼å¼ï¼Œç¢ºä¿ YAML è§£ææ­£ç¢ºã€‚"
          - "è«‹å˜—è©¦ç™»å…¥ï¼š"
          - "ssh rocky@{{ nfs_server_ip.stdout }} -p 30022"
