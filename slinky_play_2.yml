---
# ========================================================
# SKU: Slinky-App-Standalone-v3.5-Base64
# ä¿®æ­£ï¼š
#   1. ä½¿ç”¨ Regex å¼·åˆ¶æå–ç´”æ·¨ IP (éæ¿¾é›œè¨Š)
#   2. ä½¿ç”¨ Base64 ç·¨ç¢¼å‚³è¼¸ YAML (é¿é–‹æ‰€æœ‰æ ¼å¼/ç¸®æ’å•é¡Œ)
# ========================================================
- name: Application Layer - Deploy Slurm (Base64 Safe Mode)
  hosts: maasjuju
  gather_facts: yes
  vars:
    test_model: "slinky-cluster"
    release_name: "slinky"
    namespace: "slurm-cluster"
    slurm_git_url: "https://github.com/stackhpc/slurm-k8s-cluster.git"
    nfs_path: "/srv/nfs/kubedata"

  tasks:
    # -----------------------------------------------------------
    # 1. ç²å–ä¸¦æ¸…æ´— IP (æœ€é—œéµçš„ä¸€æ­¥)
    # -----------------------------------------------------------
    - name: 1.1 ç²å– Machine 0 åŸå§‹è³‡è¨Š
      shell: juju status --model {{ test_model }} --format json
      register: juju_status_raw

    - name: 1.2 [æ¸…æ´—] ä½¿ç”¨ Regex æå–ç´”æ·¨ IP
      # ä¸ç®¡ Juju å›å‚³ä»€éº¼ï¼Œæˆ‘å€‘åªæŠ“ "æ•¸å­—.æ•¸å­—.æ•¸å­—.æ•¸å­—" çš„æ ¼å¼
      set_fact:
        # é€™è£¡æœƒå¾é‚£ä¸€é•·ä¸² JSON ä¸­ç²¾æº–æŠ“å‡º Machine 0 çš„ IP
        clean_ip: "{{ (juju_status_raw.stdout | from_json).machines['0']['dns-name'] | regex_search('[0-9]+\\.[0-9]+\\.[0-9]+\\.[0-9]+') }}"

    - name: 1.3 é©—è­‰ IP
      debug:
        msg: "æ¸…æ´—å¾Œçš„ IP ç‚º: [{{ clean_ip }}] (çµ•å°ä¸å«æ›è¡Œæˆ–é›œè¨Š)"

    - name: 1.4 å®‰å…¨æª¢æŸ¥
      fail:
        msg: "âŒ ç„¡æ³•æå–æœ‰æ•ˆçš„ IP ä½å€"
      when: clean_ip is not defined or clean_ip | length == 0

    # -----------------------------------------------------------
    # 2. æº–å‚™ YAML å…§å®¹ (åœ¨ Ansible ç«¯çµ„åˆ)
    # -----------------------------------------------------------
    - name: 2.1 å®šç¾© PV èˆ‡ PVC çš„ YAML å…§å®¹
      set_fact:
        pv_yaml_content: |
          apiVersion: v1
          kind: PersistentVolume
          metadata:
            name: slurm-nfs-pv
          spec:
            capacity:
              storage: 20Gi
            accessModes:
              - ReadWriteMany
            persistentVolumeReclaimPolicy: Retain
            nfs:
              path: {{ nfs_path }}
              server: {{ clean_ip }}
        pvc_yaml_content: |
          apiVersion: v1
          kind: PersistentVolumeClaim
          metadata:
            name: slurm-shared-storage
            namespace: {{ namespace }}
          spec:
            accessModes:
              - ReadWriteMany
            resources:
              requests:
                storage: 20Gi
            volumeName: slurm-nfs-pv
            storageClassName: ""

    # -----------------------------------------------------------
    # 3. å‚³è¼¸ä¸¦æ‡‰ç”¨ (ä½¿ç”¨ Base64 é€šé“)
    # -----------------------------------------------------------
    - name: 3.1 å¯«å…¥ PV æª”æ¡ˆ (Base64 è§£ç¢¼å¯«å…¥)
      # é€éç®¡é“ | base64 -d é‚„åŸæª”æ¡ˆï¼Œé¿é–‹ Shell è§£æéŒ¯èª¤
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "echo '{{ pv_yaml_content | b64encode }}' | base64 -d > /home/ubuntu/slurm-pv.yaml"
      changed_when: true

    - name: 3.2 å¯«å…¥ PVC æª”æ¡ˆ (Base64 è§£ç¢¼å¯«å…¥)
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "echo '{{ pvc_yaml_content | b64encode }}' | base64 -d > /home/ubuntu/slurm-pvc.yaml"
      changed_when: true

    - name: 3.3 ç¢ºä¿ NFS Server å­˜åœ¨ (Host ç«¯)
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "sudo apt-get update && \
         sudo DEBIAN_FRONTEND=noninteractive apt-get install -y nfs-kernel-server && \
         sudo mkdir -p {{ nfs_path }} && \
         sudo chown nobody:nogroup {{ nfs_path }} && \
         sudo chmod 777 {{ nfs_path }} && \
         echo '{{ nfs_path }} *(rw,sync,no_subtree_check,no_root_squash)' | sudo tee /etc/exports && \
         sudo exportfs -a && \
         sudo systemctl restart nfs-kernel-server"
      changed_when: true

    - name: 3.4 æ‡‰ç”¨ PV/PVC è¨­å®š
      # ç‚ºäº†ä¿éšªï¼Œå…ˆæ¸…é™¤èˆŠçš„
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "kubectl delete pv slurm-nfs-pv --wait=false 2>/dev/null || true && \
         kubectl delete pvc slurm-shared-storage -n {{ namespace }} --wait=false 2>/dev/null || true && \
         kubectl create ns {{ namespace }} 2>/dev/null || true && \
         kubectl apply -f /home/ubuntu/slurm-pv.yaml && \
         kubectl apply -f /home/ubuntu/slurm-pvc.yaml"
      changed_when: true

    # -----------------------------------------------------------
    # 4. éƒ¨ç½² Slurm
    # -----------------------------------------------------------
    - name: 4.1 ä¸‹è¼‰ StackHPC Chart
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "sudo apt-get install -y git && \
         rm -rf slurm-k8s-cluster && \
         git clone --depth 1 {{ slurm_git_url }}"
      changed_when: true

    - name: 4.2 ä¸‹è¼‰ä¾è³´
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "cd slurm-k8s-cluster/slurm-cluster-chart && helm dependency update"
      changed_when: true

    - name: 4.3 ç”¢ç”Ÿ Values (ä½¿ç”¨ Base64 å¯«å…¥)
      # Values æª”ä¹Ÿç”¨ Base64 è™•ç†ï¼Œç¢ºä¿è¬ç„¡ä¸€å¤±
      vars:
        values_content: |
          global:
            clusterName: {{ test_model }}
          volumeClaim:
            create: false
            name: slurm-shared-storage
          controller:
            size: 10Gi
            storageClassName: "local-path"
            resources:
              limits:
                cpu: 2
                memory: 4Gi
          slurmdbd:
            enabled: true
            storageClassName: "local-path"
            size: 10Gi
          login:
            service:
              type: NodePort
              nodePort: 30022
            ssh:
              enabled: true
          worker:
            replicas: 1
            resources:
              limits:
                cpu: 8
                memory: 16Gi
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "echo '{{ values_content | b64encode }}' | base64 -d > /home/ubuntu/slurm-static-values.yaml"
      changed_when: false

    - name: 4.4 éƒ¨ç½² Slurm
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "helm upgrade --install {{ release_name }} ./slurm-k8s-cluster/slurm-cluster-chart \
          --namespace {{ namespace }} \
          --create-namespace \
          -f /home/ubuntu/slurm-static-values.yaml \
          --wait --timeout 15m"
      register: helm_deploy

    - name: âœ… å®Œæˆ
      debug:
        msg: 
          - "ğŸ‰ Slurm + NFS (Base64 Mode) éƒ¨ç½²æˆåŠŸï¼"
          - "å¦‚æœé€™æ¬¡é‚„ä¸éï¼Œæˆ‘æŠŠéµç›¤åä¸‹å» (é–‹ç©ç¬‘çš„ï¼Œä½†é€™æ¬¡çœŸçš„æœ€ç©©)"
          - "ç™»å…¥ IP: {{ clean_ip }}"
