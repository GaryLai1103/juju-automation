---
# ========================================================
# SKU: StackHPC-SlurmK8sCluster-FixCgroup
# ä¾ stackhpc/slurm-k8s-cluster README æµç¨‹æ”¹å¯«ï¼š
#   - ç”¨ Helm å®‰è£ slurm-cluster-chartï¼ˆä¸æ˜¯ kubectl apply å¤–éƒ¨ yamlï¼‰
#   - initial onlyï¼šgenerate-secrets.shï¼ˆè‹¥ repo å…§æ‰¾ä¸åˆ°ï¼Œå°‡é¡¯ç¤ºè¨Šæ¯ä¸¦è·³éï¼‰
#   - ssh keysï¼špublish-keys.sh
#   - ä¿® slurm.confï¼šProctrackType=linuxproc + ç§»é™¤ task/cgroup
#   - éœ€è¦æ™‚ rollout restartï¼ˆstatefulset: slurmd/slurmctldï¼›deployment: login/slurmdbd/mysqlï¼‰
# ========================================================

- name: Application Layer - Deploy StackHPC Slurm cluster (Fix cgroup crash)
  hosts: maasjuju
  gather_facts: yes

  vars:
    test_model: "slinky-cluster"
    namespace: "slurm-cluster"
    release_name: "slurm"
    repo_url: "https://github.com/stackhpc/slurm-k8s-cluster.git"

    # âœ… ä¿®æ­£ï¼šä½ å¯¦éš›çš„ repo root åœ¨å¤šä¸€å±¤å­ç›®éŒ„åº•ä¸‹
    repo_dir: "/home/ubuntu/slurm-k8s-cluster/slurm-k8s-cluster"

    # è‹¥ä½  k8s å·²æœ‰å¯ç”¨ RWX StorageClassï¼Œå°±å¡«å®ƒä¸¦é—œæ‰ rooknfs
    # å¦å‰‡ä¿æŒ rooknfs_enabled=trueï¼ˆREADME é è¨­æœƒè£ rooknfs ä¾› RWX /homeï¼‰
    rooknfs_enabled: true
    storage_class: ""          # e.g. "nfs-rwx" / "rook-nfs-share1"
    storage_capacity: "20Gi"   # /home çš„ RWX PVC å®¹é‡

  tasks:
    # -----------------------------------------------------------
    # 1.0) Runtime Discovery - Machine IPs (ä¿®æ­£ç‰ˆ)
    # -----------------------------------------------------------
    - name: 1.1 å¾ Juju Controller ç²å–æ‰€æœ‰æ©Ÿå™¨çš„ç‹€æ…‹
      shell: "juju status --model {{ test_model }} --format json"
      register: juju_status_raw
      changed_when: false

    - name: 1.2 è§£æä¸¦æå– Machine 0 èˆ‡ Machine 1 çš„ IPv4
      set_fact:
        # ç›´æ¥å¾ JSON çµæ§‹ä¸­æŠ“å– IPï¼Œä¸¦æ’é™¤å¯èƒ½çš„ IPv6 (åªå–ç¬¬ä¸€å€‹ IPv4)
        machine0_ip: "{{ (juju_status_raw.stdout | from_json).machines['0']['ip-addresses'] | select('match', '^[0-9.]+$') | first }}"
        machine1_ip: "{{ (juju_status_raw.stdout | from_json).machines['1']['ip-addresses'] | select('match', '^[0-9.]+$') | first }}"

    - name: 1.3 é¡¯ç¤ºåµæ¸¬åˆ°çš„ IP (é©—è­‰ç”¨)
      debug:
        msg:
          - "Machine0 (Control Plane) IP: {{ machine0_ip }}"
          - "Machine1 (Worker Node) IP: {{ machine1_ip }}"

    # -----------------------------------------------------------
    # 2.0) Namespace reset
    # -----------------------------------------------------------
    - name: 2.1 Delete namespace (force)
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "kubectl delete namespace {{ namespace }} --ignore-not-found=true --wait=true"

    - name: 2.2 Create namespace
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "kubectl create namespace {{ namespace }} || true"

    # -----------------------------------------------------------
    # 3.0) Clone repo (ç°¡åŒ–è·¯å¾‘ç‰ˆ)
    # -----------------------------------------------------------
    - name: 3.1 Clone or update stackhpc/slurm-k8s-cluster
      shell: |
        juju ssh --model {{ test_model }} 0 -- bash -c "
          set -e;
          TARGET=/home/ubuntu/slurm-k8s-cluster;
          if [ -d \"\$TARGET/.git\" ]; then
            echo 'Updating existing repo...';
            cd \"\$TARGET\" && git fetch --all && git reset --hard origin/main;
          else
            echo 'Cloning new repo...';
            rm -rf \"\$TARGET\";
            git clone {{ repo_url }} \"\$TARGET\";
          fi;
          ls -la \"\$TARGET/slurm-cluster-chart\"
        "
      register: clone_out

    # åŒæ­¥ä¿®æ­£è®Šæ•¸ï¼Œç¢ºä¿å¾Œé¢ Task æŠ“å¾—åˆ°æ­£ç¢ºç›®éŒ„
    - name: 3.2 Update repo_dir variable
      set_fact:
        repo_dir: "/home/ubuntu/slurm-k8s-cluster"

    # -----------------------------------------------------------
    # 4.0) Patch slurm.confï¼ˆåœ¨ chart çš„ files å…§ï¼‰
    # -----------------------------------------------------------
    - name: 4.1 Patch slurm.conf (single-line remote script, YAML-safe)
      shell: >
        juju ssh --model {{ test_model }} 0 -- bash -lc
        "set -euo pipefail;
         SLURM_CONF='{{ repo_dir }}/slurm-cluster-chart/files/slurm.conf';
         test -f \"${SLURM_CONF}\";
         sed -i 's#^ProctrackType=proctrack/cgroup#ProctrackType=proctrack/linuxproc#g' \"${SLURM_CONF}\";
         sed -i 's#^TaskPlugin=task/affinity,task/cgroup#TaskPlugin=task/affinity#g' \"${SLURM_CONF}\";
         sed -i 's#^TaskPlugin=task/cgroup,task/affinity#TaskPlugin=task/affinity#g' \"${SLURM_CONF}\";
         sed -i 's#^TaskPlugin=task/cgroup$#TaskPlugin=task/none#g' \"${SLURM_CONF}\";
         echo '--- patched slurm.conf ---';
         egrep '^(ProctrackType|TaskPlugin)=' \"${SLURM_CONF}\" || true;"
      changed_when: true

    # -----------------------------------------------------------
    # 5.0) Initial-onlyï¼šgenerate-secrets.shï¼ˆauto-detectï¼Œæ‰¾ä¸åˆ°å°±è·³éï¼‰
    # -----------------------------------------------------------
    - name: 5.1 Check if secrets already exist
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "kubectl -n {{ namespace }} get secret slurm-secrets --ignore-not-found -o name || true"
      register: slurm_secrets_name
      changed_when: false

    - name: 5.2 Generate cluster secrets (initial only, auto-detect script)
      shell: >
        juju ssh --model {{ test_model }} 0 -- bash -lc
        "set -euo pipefail;
         cd {{ repo_dir }};
         SCRIPT=\$(find . -maxdepth 10 -type f -name 'generate-secrets.sh' -print -quit || true);
         if [ -z \"\$SCRIPT\" ]; then
           echo 'WARN: generate-secrets.sh not found in repo; skip secrets generation.';
           echo '      You may need to check repo version/branch or create secrets manually.';
           exit 0;
         fi;
         chmod +x \"\$SCRIPT\";
         \"\$SCRIPT\" {{ namespace }};"
      when: slurm_secrets_name.stdout | trim == ""
      changed_when: true

    # -----------------------------------------------------------
    # 6.0) publish-keys.sh
    # -----------------------------------------------------------
    - name: 6.1 Check if ssh keys secret already exists
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "kubectl -n {{ namespace }} get secret slurm-ssh-public-keys --ignore-not-found -o name || true"
      register: slurm_keys_secret
      changed_when: false

    - name: 6.2 Publish SSH public keys to k8s secret
      shell: >
        juju ssh --model {{ test_model }} 0 -- bash -lc
        "set -euo pipefail;
         cd {{ repo_dir }};
         chmod +x ./publish-keys.sh;
         ./publish-keys.sh {{ namespace }};"
      when: slurm_keys_secret.stdout | trim == ""
      changed_when: true

    # -----------------------------------------------------------
    # 7.0) Helm values overrideï¼ˆå®‰å…¨å¯«æª”ï¼‰
    # -----------------------------------------------------------
    - name: 7.1 Write helm override values.yaml (safe, no heredoc)
      shell: |
        juju ssh --model {{ test_model }} 0 -- "bash -lc '
          set -e
          f=/home/ubuntu/slurm-values.override.yaml
          : > \$f
          echo \"rooknfs:\" >> \$f
          echo \"  enabled: {{ rooknfs_enabled | bool | lower }}\" >> \$f
          echo \"storage:\" >> \$f
          echo \"  capacity: {{ storage_capacity }}\" >> \$f
          {% if storage_class | trim != "" %}
          echo \"storageClass: {{ storage_class }}\" >> \$f
          {% endif %}
          echo \"---\"; cat \$f
        '"
    
    # -----------------------------------------------------------
    # 7.5) å®‰è£ Helm (å¦‚æœå°šæœªå®‰è£)
    # -----------------------------------------------------------
    - name: 7.5 åœ¨ Machine 0 å®‰è£ Helm
      shell: |
        juju ssh --model {{ test_model }} 0 -- bash -c "
          if ! command -v helm &> /dev/null; then
            echo 'Installing Helm...'
            curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          else
            echo 'Helm already installed'
          fi
        "
      changed_when: false
      
    # -----------------------------------------------------------
    # 8.0) Helm dependency updateï¼ˆrooknfs enabled æ™‚ï¼‰
    # -----------------------------------------------------------
    - name: 8.1 Helm dependency update (only when rooknfs enabled)
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "set -e
         cd {{ repo_dir }}
         helm dependency update slurm-cluster-chart"
      when: rooknfs_enabled | bool
      changed_when: true

    # -----------------------------------------------------------
    # 9.0) Helm install/upgrade
    # -----------------------------------------------------------
    - name: 9.1 Deploy Slurm cluster via Helm (upgrade --install)
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "set -e
         cd {{ repo_dir }}
         helm upgrade --install {{ release_name }} ./slurm-cluster-chart \
           -n {{ namespace }} --create-namespace \
           -f /home/ubuntu/slurm-values.override.yaml"
      changed_when: true

    # -----------------------------------------------------------
    # 10.0) rollout restartï¼ˆdeployment vs statefulsetï¼‰
    # -----------------------------------------------------------
    - name: 10.1 Rollout restart deployments (login/slurmdbd/mysql)
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "kubectl -n {{ namespace }} rollout restart deployment login slurmdbd mysql || true"
      changed_when: true

    - name: 10.2 Rollout restart statefulsets (slurmd/slurmctld)
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "kubectl -n {{ namespace }} rollout restart statefulset slurmd slurmctld || true"
      changed_when: true

    # -----------------------------------------------------------
    # 11.0) scontrol reconfigure
    # -----------------------------------------------------------
    - name: 11.1 Run scontrol reconfigure in slurmctld pod
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "set -e
         POD=$(kubectl -n {{ namespace }} get pod -l app.kubernetes.io/component=slurmctld -o jsonpath='{.items[0].metadata.name}')
         kubectl -n {{ namespace }} exec $POD -- scontrol reconfigure || true"
      changed_when: true

    - name: 12.0 Done
      debug:
        msg:
          - "ğŸ‰ StackHPC slurm-k8s-cluster å·²ç”¨ Helm éƒ¨ç½²å®Œæˆ"
          - "Machine0 IP: {{ machine0_ip }} / Machine1 IP: {{ machine1_ip }}"
          - "å·²åœ¨ chart çš„ slurm.conf å…ˆä¿®æ­£ ProctrackType=linuxproc ä¸¦ç§»é™¤ task/cgroup"
          - "publish-keys å·²åŸ·è¡Œï¼ˆè‹¥ secrets å·²å­˜åœ¨å‰‡è·³éï¼‰"
          - "generate-secrets è‹¥ repo å…§ä¸å­˜åœ¨æœƒè·³éä¸¦æç¤ºï¼ˆé¿å…å¡ä½ï¼‰"
          - "å·² rollout restartï¼šdeployment(login/slurmdbd/mysql) + statefulset(slurmd/slurmctld)"
          - "è«‹ç”¨ï¼škubectl get pods -n {{ namespace }}ï¼›å†é€² login pod/ssh å¾Œ sinfo é©—è­‰"
