---
# ========================================================
# SKU: Slinky-App-Standalone-v4.7-TheSwap
# ç­–ç•¥ï¼š
#   1. [Helm] è®“ Helm å»ºç«‹éŒ¯èª¤çš„ PVC (é¿é–‹æ‰€æœ‰æ¬Šè¡çª)
#   2. [Ansible] ä½¿ç”¨ --wait=false ä¸ç­‰å¾… Helm å®Œæˆ
#   3. [Swap] åˆªé™¤ Helm å»ºçš„å£ PVC -> æ›æˆæˆ‘å€‘çš„å¥½ PVC
# ========================================================
- name: Application Layer - Deploy Slurm (The Swap Strategy)
  hosts: maasjuju
  gather_facts: yes
  vars:
    test_model: "slinky-cluster"
    release_name: "slinky"
    namespace: "slurm-cluster"
    slurm_git_url: "https://github.com/stackhpc/slurm-k8s-cluster.git"
    nfs_path: "/srv/nfs/kubedata"
    nfs_server_ip: "192.168.1.96"

  tasks:
    # -----------------------------------------------------------
    # 1. å¾¹åº•æ­¸é›¶ (ç¢ºä¿æ²’æœ‰æ®˜ç•™è¡çª)
    # -----------------------------------------------------------
    - name: 1.1 ç§»é™¤èˆŠçš„ Helm Release
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "helm uninstall {{ release_name }} -n {{ namespace }} --wait=false 2>/dev/null || true"
      changed_when: true

    - name: 1.2 åˆªé™¤èˆŠçš„ PVC
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "kubectl delete pvc slurm-shared-storage -n {{ namespace }} --wait=false 2>/dev/null || true"
      changed_when: true

    # -----------------------------------------------------------
    # 2. æº–å‚™å¥½æ­£ç¢ºçš„ PV (Server Side)
    # -----------------------------------------------------------
    - name: 2.1 å»ºç«‹ PV (Base64)
      vars:
        pv_yaml_content: |
          apiVersion: v1
          kind: PersistentVolume
          metadata:
            name: slurm-nfs-pv
            labels:
              type: nfs-static
          spec:
            capacity:
              storage: 20Gi
            accessModes:
              - ReadWriteMany
            persistentVolumeReclaimPolicy: Retain
            storageClassName: ""
            nfs:
              path: {{ nfs_path }}
              server: {{ nfs_server_ip }}
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "echo '{{ pv_yaml_content | b64encode }}' | base64 -d > /home/ubuntu/slurm-pv.yaml && \
         kubectl delete pv slurm-nfs-pv --wait=false 2>/dev/null || true && \
         kubectl apply -f /home/ubuntu/slurm-pv.yaml"
      changed_when: true

    # -----------------------------------------------------------
    # 3. åŸ·è¡Œ Helm (è®“å®ƒå»ºç«‹éŒ¯èª¤çš„ PVC)
    # -----------------------------------------------------------
    - name: 3.1 ç”¢ç”Ÿ Values
      # é€™è£¡æˆ‘å€‘è®“ Helm è¦ºå¾—ä¸€åˆ‡æ­£å¸¸ï¼Œrook é—œæ‰ï¼ŒPVC è‡ªå·±å»º
      vars:
        values_content: |
          global:
            clusterName: {{ test_model }}
          rook-nfs:
            enabled: false
          volumeClaim:
            create: true  # <--- è®“ Helm å»ºç«‹ PVC (å³ä½¿å®ƒæœƒè¨­éŒ¯ StorageClass)
            name: slurm-shared-storage
            accessModes:
              - ReadWriteMany
            size: 20Gi
          controller:
            size: 10Gi
            storageClassName: "local-path"
            resources:
              limits:
                cpu: 2
                memory: 4Gi
          slurmdbd:
            enabled: true
            storageClassName: "local-path"
            size: 10Gi
          login:
            service:
              type: NodePort
              nodePort: 30022
            ssh:
              enabled: true
          worker:
            replicas: 1
            resources:
              limits:
                cpu: 8
                memory: 16Gi
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "echo '{{ values_content | b64encode }}' | base64 -d > /home/ubuntu/slurm-static-values.yaml"
      changed_when: false

    - name: 3.2 éƒ¨ç½² Slurm (ä¸ç­‰å¾…)
      # é—œéµï¼šåŠ ä¸Š --wait=falseï¼Œå› ç‚ºæˆ‘å€‘çŸ¥é“å®ƒä¸€é–‹å§‹æœƒå¤±æ•—(Pending)ï¼Œä¸è¦è®“ Ansible å¡ä½
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "helm upgrade --install {{ release_name }} ./slurm-k8s-cluster/slurm-cluster-chart \
          --namespace {{ namespace }} \
          --create-namespace \
          -f /home/ubuntu/slurm-static-values.yaml \
          --wait=false" 
      register: helm_deploy

    # -----------------------------------------------------------
    # 4. æ‰‹è¡“èª¿åŒ… (Swap the PVC)
    # -----------------------------------------------------------
    - name: 4.1 ç­‰å¾… Helm å»ºç«‹é‚£å€‹éŒ¯èª¤çš„ PVC
      shell: juju ssh --model {{ test_model }} 0 -- "kubectl get pvc slurm-shared-storage -n {{ namespace }}"
      register: pvc_check
      until: pvc_check.rc == 0
      retries: 30
      delay: 2
      ignore_errors: yes

    - name: 4.2 åˆªé™¤ Helm å»ºç«‹çš„éŒ¯èª¤ PVC
      # åˆªé™¤é‚£å€‹ StorageClass=slurm-rook-nfs çš„ PVC
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "kubectl delete pvc slurm-shared-storage -n {{ namespace }} --wait=false"
      changed_when: true

    - name: 4.3 å¡å…¥æ­£ç¢ºçš„ PVC (å·å¤©æ›æ—¥)
      # åå­—ä¸€æ¨£ï¼Œä½†æ˜¯ StorageClass æ˜¯ç©ºå­—ä¸²ï¼Œä¸”ç¶å®š PV
      vars:
        pvc_yaml_content: |
          apiVersion: v1
          kind: PersistentVolumeClaim
          metadata:
            name: slurm-shared-storage
            namespace: {{ namespace }}
            labels:
              app.kubernetes.io/managed-by: Helm  # åŠ ä¸Šæ¨™ç±¤è®“ Helm ä»¥ç‚ºé‚„æ´»è‘—
            annotations:
              meta.helm.sh/release-name: {{ release_name }}
              meta.helm.sh/release-namespace: {{ namespace }}
          spec:
            accessModes:
              - ReadWriteMany
            resources:
              requests:
                storage: 20Gi
            volumeName: slurm-nfs-pv  # <--- å¼·åˆ¶ç¶å®š
            storageClassName: ""      # <--- ä¿®æ­£ StorageClass
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "echo '{{ pvc_yaml_content | b64encode }}' | base64 -d > /home/ubuntu/slurm-pvc-correct.yaml && \
         kubectl apply -f /home/ubuntu/slurm-pvc-correct.yaml"
      changed_when: true

    # -----------------------------------------------------------
    # 5. é‡å•Ÿ Pod (è®“å®ƒå€‘è®€åˆ°æ–°çš„ PVC)
    # -----------------------------------------------------------
    - name: 5.1 åˆªé™¤ Pod ä»¥è§¸ç™¼é‡æ–°æ›è¼‰
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "kubectl delete pod --all -n {{ namespace }} --wait=false"
      changed_when: true

    - name: âœ… å®Œæˆ
      debug:
        msg: 
          - "ğŸ‰ V4.7 (èª¿åŒ…è¨ˆ) åŸ·è¡ŒæˆåŠŸï¼"
          - "æˆ‘å€‘æ›¿æ›äº† PVCï¼Œé¿é–‹äº† Helm çš„éŒ¯èª¤è¨­å®šã€‚"
          - "Pod æ­£åœ¨é‡å•Ÿä¸¦æ›è¼‰æ­£ç¢ºçš„ NFSã€‚"
          - "è«‹ç­‰å¾…å¹¾ç§’å¾Œæª¢æŸ¥: kubectl get pods -n slurm-cluster"
