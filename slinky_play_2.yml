---
# ========================================================
# SKU: StackHPC-SlurmK8sCluster-FixCgroup
# ä¾ stackhpc/slurm-k8s-cluster README æµç¨‹æ”¹å¯«ï¼š
#   - ç”¨ Helm å®‰è£ slurm-cluster-chartï¼ˆä¸æ˜¯ kubectl apply å¤–éƒ¨ yamlï¼‰
#   - initial onlyï¼šgenerate-secrets.sh
#   - ssh keysï¼špublish-keys.sh
#   - ä¿® slurm.confï¼šProctrackType=linuxproc + ç§»é™¤ task/cgroup
#   - éœ€è¦æ™‚ rollout restartï¼ˆstatefulset: slurmd/slurmctldï¼›deployment: login/slurmdbd/mysqlï¼‰
# ========================================================

- name: Application Layer - Deploy StackHPC Slurm cluster (Fix cgroup crash)
  hosts: maasjuju
  gather_facts: yes

  vars:
    test_model: "slinky-cluster"
    namespace: "slurm-cluster"
    release_name: "slurm"
    repo_url: "https://github.com/stackhpc/slurm-k8s-cluster.git"
    repo_dir: "/home/ubuntu/slurm-k8s-cluster"
    # è‹¥ä½  k8s å·²æœ‰å¯ç”¨ RWX StorageClassï¼Œå°±å¡«å®ƒä¸¦é—œæ‰ rooknfs
    # å¦å‰‡ä¿æŒ rooknfs_enabled=trueï¼ˆREADME é è¨­æœƒè£ rooknfs ä¾› RWX /homeï¼‰
    rooknfs_enabled: true
    storage_class: ""          # e.g. "nfs-rwx" / "rook-nfs-share1"ï¼›è‹¥ç•™ç©ºä¸” rooknfs_enabled=true å°±ç”¨ chart é è¨­
    storage_capacity: "20Gi"   # /home çš„ RWX PVC å®¹é‡ï¼ˆä¾ READMEï¼šstorage.capacity å¯èª¿ï¼‰:contentReference[oaicite:3]{index=3}

  tasks:
    # -----------------------------------------------------------
    # 0) Namespace resetï¼ˆä½ åŸæœ¬å°±è¦å¼·åˆ¶é‡å»ºï¼Œæˆ‘ä¿ç•™ï¼‰
    # -----------------------------------------------------------
    - name: 0.1 Delete namespace (force)
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "kubectl delete namespace {{ namespace }} --ignore-not-found=true --wait=true"

    - name: 0.2 Create namespace
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "kubectl create namespace {{ namespace }} || true"

    # -----------------------------------------------------------
    # 1) å–å¾— repoï¼ˆå« slurm-cluster-chart / rooknfs / scriptsï¼‰
    # -----------------------------------------------------------
    - name: 1.1 Clone or update stackhpc/slurm-k8s-cluster
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "set -e
         if [ -d {{ repo_dir }} ]; then
           cd {{ repo_dir }} && git fetch --all && git reset --hard origin/main
         else
           git clone {{ repo_url }} {{ repo_dir }}
         fi"

    # -----------------------------------------------------------
    # 2) å…ˆä¿® slurm.confï¼ˆåœ¨ chart çš„ files å…§ï¼Œè®“å®ƒã€Œä¸€é–‹å§‹ã€å°±ä¸ç¢° cgroupï¼‰
    #    READMEï¼šslurm-cluster-chart/files/* æœƒæ›è¼‰é€²å®¹å™¨åšè¨­å®š :contentReference[oaicite:4]{index=4}
    # -----------------------------------------------------------
    - name: 2.1 Patch slurm.conf (ProctrackType linuxproc, remove task/cgroup)
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "set -e
         SLURM_CONF='{{ repo_dir }}/slurm-cluster-chart/files/slurm.conf'
         test -f $SLURM_CONF

         # ProctrackType: proctrack/cgroup -> proctrack/linuxproc
         sed -i 's#^ProctrackType=proctrack/cgroup#ProctrackType=proctrack/linuxproc#g' $SLURM_CONF

         # TaskPlugin: ç§»é™¤ task/cgroupï¼ˆä¿ç•™ task/affinityï¼›è‹¥åªæœ‰ task/cgroup å‰‡æ”¹ task/noneï¼‰
         sed -i 's#^TaskPlugin=task/affinity,task/cgroup#TaskPlugin=task/affinity#g' $SLURM_CONF
         sed -i 's#^TaskPlugin=task/cgroup,task/affinity#TaskPlugin=task/affinity#g' $SLURM_CONF
         sed -i 's#^TaskPlugin=task/cgroup$#TaskPlugin=task/none#g' $SLURM_CONF

         echo '--- patched slurm.conf ---'
         egrep '^(ProctrackType|TaskPlugin)=' $SLURM_CONF || true"
      changed_when: true

    # -----------------------------------------------------------
    # 3) Initial-onlyï¼šgenerate-secrets.shï¼ˆREADME æ˜ç¢ºï¼šOn initial deployment ONLYï¼‰:contentReference[oaicite:5]{index=5}
    #    ç”¨ secret å­˜åœ¨èˆ‡å¦ä¾†é¿å…é‡è·‘
    # -----------------------------------------------------------
    - name: 3.1 Check if secrets already exist
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "kubectl -n {{ namespace }} get secret slurm-secrets --ignore-not-found -o name || true"
      register: slurm_secrets_name
      changed_when: false

    - name: 3.2 Generate cluster secrets (initial only)
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "set -e
         cd {{ repo_dir }}
         ./generate-secrets.sh {{ namespace }}"
      when: slurm_secrets_name.stdout | trim == ""
      changed_when: true

    # -----------------------------------------------------------
    # 4) publish-keys.shï¼šæŠŠæœ¬æ©Ÿ public keys ç™¼åˆ° k8s secretï¼ˆREADMEï¼‰:contentReference[oaicite:6]{index=6}
    # -----------------------------------------------------------
    - name: 4.1 Check if ssh keys secret already exists
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "kubectl -n {{ namespace }} get secret slurm-ssh-public-keys --ignore-not-found -o name || true"
      register: slurm_keys_secret
      changed_when: false

    - name: 4.2 Publish SSH public keys to k8s secret
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "set -e
         cd {{ repo_dir }}
         ./publish-keys.sh {{ namespace }}"
      when: slurm_keys_secret.stdout | trim == ""
      changed_when: true

    # -----------------------------------------------------------
    # 5) Helm values overrideï¼ˆä¾ READMEï¼šå¯è¨­å®š storageClassã€rooknfs.enabledã€storage.capacityï¼‰:contentReference[oaicite:7]{index=7}
    # -----------------------------------------------------------
    - name: 5.1 Write helm override values.yaml (safe, no heredoc)
      shell: |
        juju ssh --model {{ test_model }} 0 -- "bash -lc '
          set -e
          f=/home/ubuntu/slurm-values.override.yaml
          : > \$f
          echo \"rooknfs:\"                     >> \$f
          echo \"  enabled: {{ rooknfs_enabled | bool | lower }}\" >> \$f
          echo \"storage:\"                     >> \$f
          echo \"  capacity: {{ storage_capacity }}\" >> \$f
          {% if storage_class | trim != "" %}
          echo \"storageClass: {{ storage_class }}\" >> \$f
          {% endif %}
          echo \"---\"; cat \$f
        '"


    # READMEï¼šè‹¥ç”¨ rooknfs dependencyï¼Œéœ€å…ˆ helm dependency update :contentReference[oaicite:8]{index=8}
    - name: 5.2 Helm dependency update (only when rooknfs enabled)
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "set -e
         cd {{ repo_dir }}
         helm dependency update slurm-cluster-chart"
      when: rooknfs_enabled | bool
      changed_when: true

    # -----------------------------------------------------------
    # 6) Helm install/upgrade Slurm clusterï¼ˆREADMEï¼šhelm install / helm upgradeï¼‰:contentReference[oaicite:9]{index=9}
    # -----------------------------------------------------------
    - name: 6.1 Deploy Slurm cluster via Helm (upgrade --install)
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "set -e
         cd {{ repo_dir }}
         helm upgrade --install {{ release_name }} ./slurm-cluster-chart \
           -n {{ namespace }} --create-namespace \
           -f /home/ubuntu/slurm-values.override.yaml"
      changed_when: true

    # -----------------------------------------------------------
    # 7) ä¾ README çš„é‡é…æ–¹å¼ï¼šéœ€è¦æ™‚ rollout restartï¼ˆdeployment vs statefulsetï¼‰:contentReference[oaicite:10]{index=10}
    # -----------------------------------------------------------
    - name: 7.1 Rollout restart deployments (login/slurmdbd/mysql)
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "kubectl -n {{ namespace }} rollout restart deployment login slurmdbd mysql || true"
      changed_when: true

    - name: 7.2 Rollout restart statefulsets (slurmd/slurmctld)
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "kubectl -n {{ namespace }} rollout restart statefulset slurmd slurmctld || true"
      changed_when: true

    # -----------------------------------------------------------
    # 8) scontrol reconfigureï¼ˆREADMEï¼šhelm upgrade å¾Œå¯åœ¨ pod å…§ scontrol reconfigureï¼‰:contentReference[oaicite:11]{index=11}
    # -----------------------------------------------------------
    - name: 8.1 Run scontrol reconfigure in slurmctld pod
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "set -e
         POD=$(kubectl -n {{ namespace }} get pod -l app.kubernetes.io/component=slurmctld -o jsonpath='{.items[0].metadata.name}')
         kubectl -n {{ namespace }} exec $POD -- scontrol reconfigure || true"
      changed_when: true

    - name: âœ… Done
      debug:
        msg:
          - "ğŸ‰ StackHPC slurm-k8s-cluster å·²ç”¨ Helm éƒ¨ç½²å®Œæˆ"
          - "å·²åœ¨ chart çš„ slurm.conf å…ˆä¿®æ­£ ProctrackType=linuxproc ä¸¦ç§»é™¤ task/cgroup"
          - "å·²ä¾ README åŸ·è¡Œ generate-secrets/publish-keysï¼ˆinitial-only ä»¥ secret åˆ¤æ–·ï¼‰"
          - "å·² rollout restartï¼šdeployment(login/slurmdbd/mysql) + statefulset(slurmd/slurmctld)"
          - "è«‹ç”¨ï¼škubectl get pods -n {{ namespace }}ï¼›å†é€² login pod/ssh å¾Œ sinfo é©—è­‰"
