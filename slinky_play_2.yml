---
# ========================================================
# SKU: Slinky-App-Standalone-v4.8-FixCgroup
# ä¿®æ­£ï¼š
#   1. [Fix Crash] ä¿®æ”¹ slurm.confï¼Œå°‡ ProctrackType æ”¹ç‚º linuxproc
#   2. [Fix Crash] ç¦ç”¨ TaskPlugin çš„ cgroup åŠŸèƒ½
#   3. [Restart] é‡å•Ÿ slurmd è®“è¨­å®šç”Ÿæ•ˆ
# ========================================================
- name: Application Layer - Deploy Slurm (Fix Cgroup Crash)
  hosts: maasjuju
  gather_facts: yes
  vars:
    test_model: "slinky-cluster"
    namespace: "slurm-cluster"

  tasks:
    # -----------------------------------------------------------
    # 1. ä¿®æ”¹ Slurm è¨­å®šæª” (ConfigMap)
    # -----------------------------------------------------------
    - name: 1.1 å¾ K8s æŠ“å–ç›®å‰çš„ slurm.conf
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "kubectl get cm slurm-conf-configmap -n {{ namespace }} -o jsonpath='{.data.slurm\.conf}' > /home/ubuntu/slurm.conf.current"
      changed_when: false

    - name: 1.2 ä¿®æ”¹è¨­å®š (Cgroup -> LinuxProc)
      # æˆ‘å€‘ç”¨ sed ç›´æ¥æ›¿æ›è¨­å®šæª”ä¸­çš„é—œéµè¡Œ
      # 1. ProctrackType=proctrack/cgroup -> ProctrackType=proctrack/linuxproc
      # 2. TaskPlugin=task/cgroup -> TaskPlugin=task/none (æˆ–è¨»è§£æ‰)
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "sed -i 's/ProctrackType=proctrack\/cgroup/ProctrackType=proctrack\/linuxproc/g' /home/ubuntu/slurm.conf.current && \
         sed -i 's/TaskPlugin=task\/cgroup/TaskPlugin=task\/none/g' /home/ubuntu/slurm.conf.current && \
         sed -i 's/TaskPlugin=task\/affinity,task\/cgroup/TaskPlugin=task\/affinity/g' /home/ubuntu/slurm.conf.current"
      changed_when: true

    - name: 1.3 å°‡ä¿®æ”¹å¾Œçš„è¨­å®šå¯«å› K8s ConfigMap
      # é€™æ‹›å¾ˆå¯¦ç”¨ï¼šç”¨ --from-file ç›´æ¥æ›´æ–° ConfigMap ä¸­çš„ç‰¹å®šéµå€¼
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "kubectl create configmap slurm-conf-configmap \
          --from-file=slurm.conf=/home/ubuntu/slurm.conf.current \
          -n {{ namespace }} \
          --dry-run=client -o yaml | kubectl apply -f -"
      changed_when: true

    # -----------------------------------------------------------
    # 2. é‡å•Ÿ Worker ç¯€é»
    # -----------------------------------------------------------
    - name: 2.1 åˆªé™¤å´©æ½°çš„é‹ç®—ç¯€é» (è®“å®ƒé‡å•Ÿè®€å–æ–°è¨­å®š)
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "kubectl delete pod -l app.kubernetes.io/component=slurmd -n {{ namespace }} --wait=false"
      changed_when: true

    - name: âœ… å®Œæˆ
      debug:
        msg: 
          - "ğŸ‰ V4.8 (Cgroup Fix) åŸ·è¡ŒæˆåŠŸï¼"
          - "å·²å°‡ Slurm é€²ç¨‹è¿½è¹¤æ¨¡å¼æ”¹ç‚º linuxprocã€‚"
          - "é‹ç®—ç¯€é»æ­£åœ¨é‡å•Ÿä¸­..."
          - "è«‹ç­‰å¾… 30 ç§’å¾Œæª¢æŸ¥: kubectl get pods -n slurm-cluster"
