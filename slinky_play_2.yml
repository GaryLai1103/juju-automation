---
# ========================================================
# SKU: Slinky-App-Standalone-v4.2-CleanHelm
# ä¿®æ­£ï¼š
#   1. [Fix Conflict] åˆªé™¤æ‰‹å‹• PVCï¼Œäº¤ç”± Helm å»ºç«‹ (æ“æœ‰æ¬Šå–®ä¸€åŒ–)
#   2. [Fix Hang] è¨­å®š rook-nfs: enabled: false (é¿é–‹ rook å¡æ­»)
#   3. [Binding] ä½¿ç”¨ volumeName å¼·åˆ¶ Helm çš„ PVC ç¶å®šéœæ…‹ PV
# ========================================================
- name: Application Layer - Deploy Slurm (Final Stable)
  hosts: maasjuju
  gather_facts: yes
  vars:
    test_model: "slinky-cluster"
    release_name: "slinky"
    namespace: "slurm-cluster"
    slurm_git_url: "https://github.com/stackhpc/slurm-k8s-cluster.git"
    nfs_path: "/srv/nfs/kubedata"
    nfs_server_ip: "192.168.1.96"

  tasks:
    # -----------------------------------------------------------
    # 1. æ¸…ç†è¡çªè³‡æº (æœ€é‡è¦çš„ç¬¬ä¸€æ­¥)
    # -----------------------------------------------------------
    - name: 1.1 åˆªé™¤æ“‹è·¯çš„æ‰‹å‹• PVC
      # æˆ‘å€‘å¿…é ˆåˆªé™¤å®ƒï¼Œè®“ Helm è‡ªå·±å¾é ­å»ºç«‹ä¸€å€‹ä¹¾æ·¨çš„
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "kubectl delete pvc slurm-shared-storage -n {{ namespace }} --wait=false 2>/dev/null || true"
      changed_when: true

    # -----------------------------------------------------------
    # 2. æº–å‚™ PV (PersistentVolume) - åªæœ‰é€™å€‹è¦æ‰‹å‹•å»º
    # -----------------------------------------------------------
    - name: 2.1 å®šç¾© PV å…§å®¹ (Base64)
      set_fact:
        pv_yaml_content: |
          apiVersion: v1
          kind: PersistentVolume
          metadata:
            name: slurm-nfs-pv
            labels:
              type: nfs-static
          spec:
            capacity:
              storage: 20Gi
            accessModes:
              - ReadWriteMany
            persistentVolumeReclaimPolicy: Retain
            storageClassName: ""
            nfs:
              path: {{ nfs_path }}
              server: {{ nfs_server_ip }}

    - name: 2.2 å¯«å…¥ä¸¦æ‡‰ç”¨ PV
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "echo '{{ pv_yaml_content | b64encode }}' | base64 -d > /home/ubuntu/slurm-pv.yaml && \
         kubectl apply -f /home/ubuntu/slurm-pv.yaml"
      changed_when: true

    - name: 2.3 ç¢ºä¿ Host NFS æœå‹™æ­£å¸¸
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "sudo apt-get update && \
         sudo DEBIAN_FRONTEND=noninteractive apt-get install -y nfs-kernel-server && \
         sudo mkdir -p {{ nfs_path }} && \
         sudo chmod 777 {{ nfs_path }} && \
         echo '{{ nfs_path }} *(rw,sync,no_subtree_check,no_root_squash)' | sudo tee /etc/exports && \
         sudo exportfs -a && \
         sudo systemctl restart nfs-kernel-server"
      changed_when: true

    # -----------------------------------------------------------
    # 3. éƒ¨ç½² Slurm
    # -----------------------------------------------------------
    - name: 3.1 ä¸‹è¼‰ StackHPC Chart
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "sudo apt-get install -y git && \
         rm -rf slurm-k8s-cluster && \
         git clone --depth 1 {{ slurm_git_url }}"
      changed_when: true

    - name: 3.2 ä¸‹è¼‰ä¾è³´
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "cd slurm-k8s-cluster/slurm-cluster-chart && helm dependency update"
      changed_when: true

    - name: 3.3 ç”¢ç”Ÿ Values (å®Œç¾è¨­å®šç‰ˆ)
      # é€™è£¡æ˜¯æˆåŠŸçš„é—œéµçµ„åˆï¼š
      # 1. rook-nfs: enabled: false (ä¸å‡†å¡æ­»)
      # 2. volumeClaim: create: true (Helm è‡ªå·±å»º)
      # 3. volumeName: slurm-nfs-pv (ä½†å¿…é ˆç”¨æˆ‘çš„ç¡¬ç¢Ÿ)
      vars:
        values_content: |
          global:
            clusterName: {{ test_model }}
          
          # [é—œéµ 1] å¾¹åº•é—œé–‰å…§å»º Rook NFSï¼Œé¿å… ImagePullBackOff æˆ– PVC Pending
          rook-nfs:
            enabled: false
          
          # [é—œéµ 2] è®“ Helm å»ºç«‹ PVCï¼Œä¸¦ç¶å®šåˆ°æˆ‘å€‘çš„éœæ…‹ PV
          volumeClaim:
            create: true
            name: slurm-shared-storage
            storageClassName: ""
            volumeName: slurm-nfs-pv
            accessModes:
              - ReadWriteMany
            size: 20Gi
            
          controller:
            size: 10Gi
            storageClassName: "local-path"
            resources:
              limits:
                cpu: 2
                memory: 4Gi
          slurmdbd:
            enabled: true
            storageClassName: "local-path"
            size: 10Gi
          login:
            service:
              type: NodePort
              nodePort: 30022
            ssh:
              enabled: true
          worker:
            replicas: 1
            resources:
              limits:
                cpu: 8
                memory: 16Gi
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "echo '{{ values_content | b64encode }}' | base64 -d > /home/ubuntu/slurm-static-values.yaml"
      changed_when: false

    - name: 3.4 éƒ¨ç½² Slurm
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "helm upgrade --install {{ release_name }} ./slurm-k8s-cluster/slurm-cluster-chart \
          --namespace {{ namespace }} \
          --create-namespace \
          -f /home/ubuntu/slurm-static-values.yaml \
          --wait --timeout 15m"
      register: helm_deploy

    - name: âœ… å®Œæˆ
      debug:
        msg: 
          - "ğŸ‰ V4.2 éƒ¨ç½²æˆåŠŸï¼"
          - "é€™æ˜¯æœ€ä¹¾æ·¨çš„éƒ¨ç½²æ¨¡å¼ï¼šHelm è‡ªå·±ç®¡ç† PVCï¼Œä½†è³‡æ–™å­˜åœ¨æˆ‘å€‘æŒ‡å®šçš„ NFS ä¸Šã€‚"
          - "è«‹æª¢æŸ¥: kubectl get pvc -n slurm-cluster"
