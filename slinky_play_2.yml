---
# ========================================================
# SKU: Slinky-App-Standalone-v1.0
# å‰æï¼šå¿…é ˆå…ˆåŸ·è¡Œé Infrastructure Playbookï¼Œç¢ºä¿ K8s æ´»è‘—
# åŠŸèƒ½ï¼š
#   1. å®‰è£ Helm
#   2. é…ç½® Slinky (å«è‡ªå‹• DB + Local Path Storage)
#   3. éƒ¨ç½² Slurm
# ========================================================
- name: Application Layer - Deploy Slinky (Slurm)
  hosts: maasjuju
  gather_facts: yes
  vars:
    # é€™æ˜¯æ‚¨å‰›å‰›å»ºç«‹çš„æ¨¡å‹åç¨±ï¼Œå¿…é ˆä¸€è‡´
    test_model: "slinky-cluster"
    
    # Slurm Helm Chart è¨­å®š
    helm_repo_name: "schedmd"
    helm_repo_url: "https://schedmd.github.io/slurm-helm-charts/"
    release_name: "slinky"
    namespace: "slurm-cluster"

  tasks:
    # -----------------------------------------------------------
    # 1. æª¢æŸ¥ç’°å¢ƒ (é˜²å‘†æ©Ÿåˆ¶)
    # -----------------------------------------------------------
    - name: 1.1 ç¢ºèª Machine 0 æ˜¯å¦å­˜æ´»
      shell: juju ssh --model {{ test_model }} 0 -- "echo 'alive'"
      register: machine_check
      ignore_errors: yes

    - name: 1.2 çµ‚æ­¢æª¢æŸ¥ (è‹¥ç’°å¢ƒä¸å­˜åœ¨)
      fail:
        msg: "âŒ æ‰¾ä¸åˆ° Machine 0ï¼è«‹å…ˆåŸ·è¡Œ Infrastructure Playbook å»ºç«‹ K8s å¢é›†ã€‚"
      when: machine_check.rc != 0

    # -----------------------------------------------------------
    # 2. æº–å‚™éƒ¨ç½²å·¥å…· (Helm)
    # -----------------------------------------------------------
    - name: 2.1 åœ¨ Machine 0 å®‰è£ Helm (Remote Exec)
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "sudo snap install helm --classic"
      register: helm_install
      changed_when: "'installed' in helm_install.stdout"

    - name: 2.2 åŠ å…¥ Slurm Helm Repo
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "helm repo add {{ helm_repo_name }} {{ helm_repo_url }} && helm repo update"
      changed_when: false

    # -----------------------------------------------------------
    # 3. è¨­å®šæª”é…ç½® (ConfigMap & Database)
    # -----------------------------------------------------------
    - name: 3.1 ç”¢ç”Ÿ Slinky è¨­å®šæª” (values.yaml)
      # é€™è£¡æ•´åˆäº†æ‚¨æœ€é—œå¿ƒçš„ï¼šè³‡æ–™åº«è‡ªå‹•å•Ÿç”¨ + ä½¿ç”¨ local-path å„²å­˜
      shell: |
        juju ssh --model {{ test_model }} 0 -- "cat <<EOF > /home/ubuntu/slinky-values.yaml
        global:
          clusterName: {{ test_model }}

        # [å„²å­˜] è®“æ‰€æœ‰ PVC éƒ½ä½¿ç”¨æˆ‘å€‘å‰›è£å¥½çš„ local-path
        volumeClaimTemplate:
          accessModes: [ \"ReadWriteOnce\" ]
          storageClassName: \"local-path\"
          resources:
            requests:
              storage: 10Gi

        # [æ§åˆ¶å™¨]
        slurmctld:
          persistence:
            enabled: true
            storageClassName: \"local-path\"
            size: 10Gi
          resources:
            limits:
              cpu: 2
              memory: 4Gi

        # [è³‡æ–™åº«] é€™è£¡ enabled: true æœƒè‡ªå‹•å»ºç«‹ MariaDB Pod
        slurmdbd:
          enabled: true
          persistence:
            enabled: true
            storageClassName: \"local-path\"
            size: 10Gi
          resources:
            limits:
              cpu: 2
              memory: 4Gi

        # [å…¥å£] é–‹å•Ÿ NodePort 30022 ä¾› SSH ç™»å…¥
        login:
          enabled: true
          service:
            type: NodePort
            nodePort: 30022
          ssh:
            enabled: true
          persistence:
            enabled: true
            storageClassName: \"local-path\"
            size: 10Gi

        # [é‹ç®—ç¯€é»]
        slurmd:
          resources:
            requests:
              cpu: 1
              memory: 2Gi
            limits: 
              cpu: 16  
              memory: 64Gi
          persistence:
            enabled: true
            storageClassName: \"local-path\"
            size: 50Gi
        EOF"
      changed_when: false

    # -----------------------------------------------------------
    # 4. åŸ·è¡Œéƒ¨ç½²
    # -----------------------------------------------------------
    - name: 4.1 å®‰è£/æ›´æ–° Slurm (Helm Install)
      # åŠ ä¸Š --wait ä»£è¡¨æœƒç­‰åˆ° Pod è®Šæˆ Running æ‰å›å ±æˆåŠŸ (æœ€å¤šç­‰ 10åˆ†é˜)
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "helm upgrade --install {{ release_name }} {{ helm_repo_name }}/slurm-cluster \
          --namespace {{ namespace }} \
          --create-namespace \
          -f /home/ubuntu/slinky-values.yaml \
          --wait --timeout 10m"
      register: helm_deploy
      changed_when: "'Release \"{{ release_name }}\" does not exist' in helm_deploy.stderr or 'Happy Helming' in helm_deploy.stdout"

    # -----------------------------------------------------------
    # 5. è³‡è¨Šé¡¯ç¤º
    # -----------------------------------------------------------
    - name: 5.1 ç²å– Machine 0 IP
      shell: |
        juju status --model {{ test_model }} --format json | jq -r '.machines["0"]["dns-name"]'
      register: master_ip

    - name: âœ… Slinky éƒ¨ç½²å®Œæˆ
      debug:
        msg: 
          - "ğŸ‰ Slurm on K8s éƒ¨ç½²æˆåŠŸï¼"
          - "è³‡æ–™åº« (MariaDB) èˆ‡ Slurmdbd å·²è‡ªå‹•å»ºç«‹ã€‚"
          - "è«‹å˜—è©¦ SSH é€£ç·šç™»å…¥ç¯€é»ï¼š"
          - "ssh root@{{ master_ip.stdout }} -p 30022"
