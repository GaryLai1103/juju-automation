---
# ========================================================
# SKU: Slinky-App-Standalone-v3.1-StaticNFS
# ç­–ç•¥ï¼š
#   1. [System] ç¢ºä¿ Machine 0 æœ‰ NFS Server
#   2. [K8s] æ‰‹å‹•å»ºç«‹ PV (å°æ‡‰ NFS IP) èˆ‡ PVC
#   3. [Helm] å¼·åˆ¶ä½¿ç”¨ç¾æœ‰ PVCï¼Œç¦æ­¢ Helm äº‚è£ Rook
# ========================================================
- name: Application Layer - Deploy Slurm (Static NFS)
  hosts: maasjuju
  gather_facts: yes
  vars:
    test_model: "slinky-cluster"
    release_name: "slinky"
    namespace: "slurm-cluster"
    slurm_git_url: "https://github.com/stackhpc/slurm-k8s-cluster.git"
    nfs_path: "/srv/nfs/kubedata"

  tasks:
    # -----------------------------------------------------------
    # 1. æº–å‚™å·¥ä½œ & ç²å– IP
    # -----------------------------------------------------------
    - name: 1.1 ç¢ºèª Machine 0 å­˜æ´»
      shell: juju ssh --model {{ test_model }} 0 -- "echo 'alive'"
      register: machine_check
      ignore_errors: yes

    - name: 1.2 ç²å– Machine 0 å…§ç¶² IP (NFS Server IP)
      shell: |
        juju status --model {{ test_model }} --format json | jq -r '.machines["0"]["dns-name"]'
      register: nfs_server_ip

    # -----------------------------------------------------------
    # 2. ç¢ºä¿ NFS Server é‹ä½œä¸­ (Host ç«¯)
    # -----------------------------------------------------------
    - name: 2.1 å®‰è£ä¸¦è¨­å®š NFS Server
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "sudo apt-get update && \
         sudo DEBIAN_FRONTEND=noninteractive apt-get install -y nfs-kernel-server && \
         sudo mkdir -p {{ nfs_path }} && \
         sudo chown nobody:nogroup {{ nfs_path }} && \
         sudo chmod 777 {{ nfs_path }} && \
         echo '{{ nfs_path }} *(rw,sync,no_subtree_check,no_root_squash)' | sudo tee /etc/exports && \
         sudo exportfs -a && \
         sudo systemctl restart nfs-kernel-server"
      changed_when: true

    # -----------------------------------------------------------
    # 3. [é—œéµ] æ‰‹å‹•å»ºç«‹ Static PV å’Œ PVC
    # -----------------------------------------------------------
    - name: 3.1 å»ºç«‹ PV/PVC å®šç¾©æª”
      # é€™è£¡æˆ‘å€‘ç›´æ¥å¯«æ­» IPï¼ŒæŠŠ K8s çš„å„²å­˜å°æ¥åˆ° Machine 0
      shell: |
        juju ssh --model {{ test_model }} 0 -- "cat <<EOF > /home/ubuntu/static-nfs.yaml
        ---
        apiVersion: v1
        kind: PersistentVolume
        metadata:
          name: slurm-nfs-pv
        spec:
          capacity:
            storage: 20Gi
          accessModes:
            - ReadWriteMany
          persistentVolumeReclaimPolicy: Retain
          nfs:
            path: {{ nfs_path }}
            server: {{ nfs_server_ip.stdout }}
        ---
        apiVersion: v1
        kind: PersistentVolumeClaim
        metadata:
          name: slurm-shared-storage
          namespace: {{ namespace }}
        spec:
          accessModes:
            - ReadWriteMany
          resources:
            requests:
              storage: 20Gi
          volumeName: slurm-nfs-pv
          storageClassName: \"\"  # ç•™ç©ºä»£è¡¨éœæ…‹ç¶å®šï¼Œä¸ä½¿ç”¨ StorageClass
        EOF"
      changed_when: false

    - name: 3.2 æ‡‰ç”¨ PV/PVC
      # å…ˆå»ºç«‹ Namespaceï¼Œå†å»ºç«‹ PVC
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "kubectl create ns {{ namespace }} || true && \
         kubectl apply -f /home/ubuntu/static-nfs.yaml"
      changed_when: true

    # -----------------------------------------------------------
    # 4. éƒ¨ç½² Slurm (ä½¿ç”¨ç¾æˆ PVC)
    # -----------------------------------------------------------
    - name: 4.1 ä¸‹è¼‰ StackHPC Chart
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "sudo apt-get install -y git && \
         rm -rf slurm-k8s-cluster && \
         git clone --depth 1 {{ slurm_git_url }}"
      changed_when: true

    - name: 4.2 ä¸‹è¼‰ä¾è³´
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "cd slurm-k8s-cluster/slurm-cluster-chart && helm dependency update"
      changed_when: true

    - name: 4.3 ç”¢ç”Ÿ Values (Disable Creation)
      # [é‡é»] create: false -> å‘Šè¨´ Helm ä¸è¦è‡ªå·±å»º PVC
      # [é‡é»] name: slurm-shared-storage -> å‘Šè¨´ Helm ç”¨æˆ‘å€‘å‰›å‰›å»ºå¥½çš„é‚£å€‹
      shell: |
        juju ssh --model {{ test_model }} 0 -- "cat <<EOF > /home/ubuntu/slurm-static-values.yaml
        global:
          clusterName: {{ test_model }}

        # [å„²å­˜è¨­å®š - éœæ…‹ç¶å®šæ¨¡å¼]
        volumeClaim:
          create: false             # ç¦æ­¢ Helm å»ºç«‹ PVC
          name: slurm-shared-storage # æŒ‡å®šä½¿ç”¨æˆ‘å€‘æ‰‹å‹•å»ºçš„ PVC

        controller:
          size: 10Gi
          storageClassName: \"local-path\" # Controller è‡ªå·±çš„ DB ç”¨ local-path æ²’é—œä¿‚
          resources:
            limits:
              cpu: 2
              memory: 4Gi

        slurmdbd:
          enabled: true
          storageClassName: \"local-path\"
          size: 10Gi

        login:
          service:
            type: NodePort
            nodePort: 30022
          ssh:
            enabled: true

        worker:
          replicas: 1
          resources:
            limits:
              cpu: 8
              memory: 16Gi
        EOF"
      changed_when: false

    - name: 4.4 éƒ¨ç½² Slurm
      shell: |
        juju ssh --model {{ test_model }} 0 -- \
        "helm upgrade --install {{ release_name }} ./slurm-k8s-cluster/slurm-cluster-chart \
          --namespace {{ namespace }} \
          --create-namespace \
          -f /home/ubuntu/slurm-static-values.yaml \
          --wait --timeout 15m"
      register: helm_deploy

    - name: âœ… å®Œæˆ
      debug:
        msg: 
          - "ğŸ‰ Slurm + Static NFS éƒ¨ç½²æˆåŠŸï¼"
          - "æˆ‘å€‘ç¹éäº† Helm çš„è‡ªå‹•é…ç½®ï¼Œç›´æ¥æ‰‹å‹•ç¶å®š PV/PVCã€‚"
          - "è«‹æª¢æŸ¥ï¼škubectl get pvc -n slurm-cluster"
