---
# ========================================================
# Scenario: Slinky Offline AI Environment - Deployment Only
# Goal: Upload files & Prep Env (WHL Folder Version)
# ========================================================
- name: ä½ˆç½² Slinky PyTorch æ¸¬è©¦æª”æ¡ˆ (WHL è³‡æ–™å¤¾ç‰ˆ)
  hosts: maasjuju
  gather_facts: no
  vars:
    # ---- Slinky è¨­å®š ----
    test_model: "slinky-cluster"
    k8s_machine: "0"
    slurm_ns: "slurm"
    controller_pod: "slurm-controller-0"
    shared_dir: "/home/slurm"

  tasks:
    # ----------------------------------------------------
    # 1. é›¢ç·šå®‰è£ Pip èˆ‡ Dependencies (WHL è³‡æ–™å¤¾ç‰ˆ + è‡ªå‹•æ¸…ç©º)
    # ----------------------------------------------------
    - name: 1.1 é›¢ç·šå®‰è£æ‰€æœ‰ Wheel å¥—ä»¶ (Bulk Install from WHL)
      shell: |
        # =======================================================
        # [æ–°å¢æ­¥é©Ÿ] 0. å…ˆæ®ºå…‰ Pod è£¡æ‰€æœ‰æ®˜ç•™çš„ .whl æª”æ¡ˆ
        # é€™æ˜¯é¿å…ç‰ˆæœ¬è¡çªçš„é—œéµï¼
        # =======================================================
        echo "ğŸ§¹ Nuke ALL old wheels in Pod..."
        juju ssh -m {{ test_model }} {{ k8s_machine }} -- \
           "kubectl exec -n {{ slurm_ns }} {{ controller_pod }} -- rm -f {{ shared_dir }}/*.whl"

        # -------------------------------------------------------
        # 1. å–å¾— Jumpbox ä¸Š WHL è³‡æ–™å¤¾çš„æª”æ¡ˆ
        # -------------------------------------------------------
        WHEEL_FILES=$(ls /home/gary/WHL/*.whl)
        
        if [ -z "$WHEEL_FILES" ]; then
            echo "âŒ Error: No .whl files found in /home/gary/WHL/"
            exit 1
        fi

        echo "ğŸ“¦ Found wheels: $WHEEL_FILES"

        # -------------------------------------------------------
        # 2. è¿´åœˆï¼šå°‡æ¯å€‹æª”æ¡ˆå‚³é€åˆ° Pod
        # -------------------------------------------------------
        for FILE in $WHEEL_FILES; do
            FILENAME=$(basename "$FILE")
            echo "ğŸš€ Transferring $FILENAME..."
            
            # Jumpbox -> Machine 0
            cat "$FILE" | juju ssh -m {{ test_model }} {{ k8s_machine }} "cat > /tmp/$FILENAME"
            
            # Machine 0 -> Pod
            juju ssh -m {{ test_model }} {{ k8s_machine }} -- \
               "kubectl cp /tmp/$FILENAME {{ slurm_ns }}/{{ controller_pod }}:{{ shared_dir }}/$FILENAME"
            
            # Clean up Machine 0
            juju ssh -m {{ test_model }} {{ k8s_machine }} -- "rm -f /tmp/$FILENAME"
        done

        # -------------------------------------------------------
        # 3. é€²å…¥ Pod åŸ·è¡Œå®‰è£
        # -------------------------------------------------------
        juju ssh -m {{ test_model }} {{ k8s_machine }} -- bash -s <<'EOS'
          kubectl exec -n {{ slurm_ns }} {{ controller_pod }} -- bash -c '
            set -e
            cd {{ shared_dir }}
            export PATH=$HOME/.local/bin:$PATH
            
            # å†æ¬¡ç¢ºèªç›®éŒ„ç¾åœ¨åªæœ‰æ–°æª”æ¡ˆ (Debugç”¨)
            echo "ğŸ“‚ Files in directory:"
            ls -lh *.whl
            
            # --- å®‰è£æ‰€æœ‰ .whl æª” ---
            echo "ğŸ“¦ Installing ALL wheels..."
            # é€™æ¬¡ç›®éŒ„è£¡åªæœ‰ Docker ä¸‹è¼‰çš„é‚£ä¸€å¥—å®Œç¾æª”æ¡ˆï¼Œçµ•å°ä¸æœƒè¡çª
            python3 -m pip install *.whl \
                --no-index \
                --find-links {{ shared_dir }} \
                --user \
                --break-system-packages
            
            echo "ğŸ” Verifying PyTorch..."
            python3 -c "import torch; print(f\"ğŸ‰ Success! PyTorch {torch.__version__} is ready. CUDA: {torch.cuda.is_available()}\")"
          '
        EOS
      async: 1800
      poll: 10
      register: install_res

    # ----------------------------------------------------
    # 2. ä½ˆç½²æ¸¬è©¦è…³æœ¬
    # ----------------------------------------------------
    - name: 2.1 æ³¨å…¥ train.py
      shell: |
        juju ssh -m {{ test_model }} {{ k8s_machine }} -- bash -s <<'EOS'
          cat << 'PY' > /tmp/train.py
        import torch
        import time
        import os
        import socket
        import sys

        TARGET_DURATION = 30
        node_name = socket.gethostname()
        job_id = os.environ.get('SLURM_JOB_ID', 'Interactive')

        print(f"\nğŸš€ [Job {job_id}] GPU Test (Node: {node_name})")
        
        if torch.cuda.is_available():
            print(f"âœ… GPU: {torch.cuda.get_device_name(0)}")
            dev = torch.device("cuda")
        else:
            print("âŒ No GPU found! Using CPU.")
            dev = torch.device("cpu")

        N = 4096 # çŸ©é™£å¤§å°
        a = torch.randn(N, N, device=dev)
        b = torch.randn(N, N, device=dev)

        print(f"ğŸ”¥ Start Matrix Multiplication loop ({TARGET_DURATION}s)...")
        start_time = time.time()
        count = 0
        
        try:
            while (time.time() - start_time) < TARGET_DURATION:
                c = torch.mm(a, b)
                torch.cuda.synchronize() if torch.cuda.is_available() else None
                count += 1
                sys.stdout.write(f"\râš¡ Batch: {count}")
                sys.stdout.flush()
        except KeyboardInterrupt:
            print("\nStopped.")

        print(f"\nâœ… Finished. Total Batches: {count}")
        PY
          
          kubectl cp /tmp/train.py {{ slurm_ns }}/{{ controller_pod }}:{{ shared_dir }}/train.py
        EOS

    - name: 2.2 æ³¨å…¥ run_job.sh
      shell: |
        juju ssh -m {{ test_model }} {{ k8s_machine }} -- bash -s <<'EOS'
          cat << 'SBATCH' > /tmp/run_job.sh
        #!/bin/bash
        #SBATCH --job-name=gpu-test
        #SBATCH --output=gpu-%j.out
        #SBATCH --ntasks=1
        #SBATCH --gres=gpu:1
        #SBATCH --time=00:05:00
        #SBATCH --partition=slinky

        # [ä¿®æ”¹é» 2] ç§»é™¤ source ai-envï¼Œå› ç‚ºæˆ‘å€‘æ˜¯ç”¨ --user å®‰è£åˆ°é è¨­è·¯å¾‘
        echo "â¡ï¸ Starting Training..."
        export PATH=$HOME/.local/bin:$PATH
        
        python3 {{ shared_dir }}/train.py
        SBATCH
        
          kubectl cp /tmp/run_job.sh {{ slurm_ns }}/{{ controller_pod }}:{{ shared_dir }}/run_job.sh
        EOS

    # ----------------------------------------------------
    # 3. æç¤ºè¨Šæ¯
    # ----------------------------------------------------
    - name: ğŸš€ ä½ˆç½²å®Œæˆ
      debug:
        msg: 
          - "âœ… å®‰è£å®Œæˆï¼è«‹ç™»å…¥ Controller æ¸¬è©¦ï¼š"
          - "juju ssh -m {{ test_model }} 0 -- kubectl exec -it -n slurm slurm-controller-0 -- bash"
          - "cd /home/slurm"
          - "python3 train.py"
