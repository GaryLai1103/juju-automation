---
# ========================================================
# Scenario: Slinky Offline AI Environment - Install & Burn-in
# Goal: Install PyTorch (WHL) & Deploy Temp Monitor Burn-in
# ========================================================
- name: ä½ˆç½² Slinky PyTorch èˆ‡ GPU æº«åº¦ç‡’æ©Ÿæ¸¬è©¦
  hosts: maasjuju
  gather_facts: no
  vars:
    # ---- Slinky è¨­å®š ----
    test_model: "slinky-cluster"
    k8s_machine: "0"
    slurm_ns: "slurm"
    controller_pod: "slurm-controller-0"
    shared_dir: "/home/slurm"

  tasks:
    # ----------------------------------------------------
    # 1. é›¢ç·šå®‰è£ Pip èˆ‡ Dependencies (å¼·åŠ›æ¸…é™¤ V3 ç‰ˆ)
    # ----------------------------------------------------
    - name: 1.1 é›¢ç·šå®‰è£æ‰€æœ‰ Wheel å¥—ä»¶ (Bulk Install from WHL)
      shell: |
        # [æ­¥é©Ÿ 0] å¼·åˆ¶æ¸…ç†
        echo "ğŸ§¹ Nuke ALL old wheels in Pod (Force)..."
        juju ssh -m {{ test_model }} {{ k8s_machine }} -- \
            "kubectl exec -n {{ slurm_ns }} {{ controller_pod }} -- sh -c 'rm -f {{ shared_dir }}/*.whl'"

        # [æ­¥é©Ÿ 1] å–å¾— Jumpbox ä¸Š WHL è³‡æ–™å¤¾çš„æª”æ¡ˆ
        WHEEL_FILES=$(ls /home/gary/WHL/*.whl)
        if [ -z "$WHEEL_FILES" ]; then
            echo "âŒ Error: No .whl files found in /home/gary/WHL/"
            exit 1
        fi

        # [æ­¥é©Ÿ 2] å‚³é€åˆ° Pod
        for FILE in $WHEEL_FILES; do
            FILENAME=$(basename "$FILE")
            echo "ğŸš€ Transferring $FILENAME..."
            cat "$FILE" | juju ssh -m {{ test_model }} {{ k8s_machine }} "cat > /tmp/$FILENAME"
            juju ssh -m {{ test_model }} {{ k8s_machine }} -- \
                "kubectl cp /tmp/$FILENAME {{ slurm_ns }}/{{ controller_pod }}:{{ shared_dir }}/$FILENAME"
            juju ssh -m {{ test_model }} {{ k8s_machine }} -- "rm -f /tmp/$FILENAME"
        done

        # [æ­¥é©Ÿ 3] é€²å…¥ Pod åŸ·è¡Œå®‰è£ (ä¿®æ­£ï¼šè‡ªèˆ‰ Pip æ¨¡å¼)
        juju ssh -m {{ test_model }} {{ k8s_machine }} -- bash -s <<'EOS'
          kubectl exec -n {{ slurm_ns }} {{ controller_pod }} -- bash -c "
            set -e
            cd {{ shared_dir }}
            
            # 1. æ‰¾åˆ° pip wheel
            BOOTSTRAP_PIP=\$(ls pip-*.whl | head -n 1)
            echo \"ğŸ› ï¸  Found pip wheel: \$BOOTSTRAP_PIP\"
            
            # 2. æ³¨å…¥ PYTHONPATH é€²è¡Œå®‰è£
            PYTHONPATH=\$BOOTSTRAP_PIP python3 -m pip install *.whl \
                --no-index \
                --find-links . \
                --user \
                --break-system-packages
            
            # 3. é©—è­‰
            export PATH=\$HOME/.local/bin:\$PATH
            python3 -m pip --version
            python3 -c 'import torch; print
